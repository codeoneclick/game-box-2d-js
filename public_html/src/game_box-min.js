var oop={global:function(){return this}(),define_class:function(class_definition){try{if(!class_definition)throw new Error("empty class definition");var class_name=class_definition.name;if(!class_name||"string"!==typeof class_name)throw new Error("empty or wrong type class name");var init_method=class_definition.init;if(!init_method||"function"!==typeof init_method)throw new Error("class must have init method");var release_method=class_definition.release;if(!release_method||"function"!==typeof release_method)throw new Error("class must have release method");
var parent_class=class_definition.extend;if(parent_class&&"function"!==typeof parent_class)throw new Error("parent constructor must be function");var class_constructor=null;if(parent_class){class_constructor=function(){parent_class.apply(this,arguments);class_constructor.prototype.init.apply(this,arguments)};if(parent_class===class_constructor)throw new Error("class cannot extend himself");var transitive=new Function;transitive.prototype=parent_class.prototype;class_constructor.prototype=new transitive;
class_constructor.prototype.constructor=class_constructor}else class_constructor=function(){class_constructor.prototype.init.apply(this,arguments)};class_constructor.prototype["init"]=init_method;class_constructor.prototype["release"]=release_method;var class_methods=class_definition.methods;if(class_methods)for(var method_name in class_methods){if("function"!==typeof class_methods[method_name])throw new Error("class method must be function");class_constructor.prototype[method_name]=class_methods[method_name]}var class_static_methods=
class_definition.static_methods;if(class_static_methods)for(var method_name in class_static_methods){if("function"!==typeof class_static_methods[method_name])throw new Error("class method must be function");class_constructor[method_name]=class_static_methods[method_name]}var class_constants=class_definition.constants;if(class_constants)for(var constant_name in class_constants){if("function"===typeof class_constants[constant_name])throw new Error("class constant cannot be function");class_constructor[constant_name]=
class_constants[constant_name]}var namespace=oop.global;if(class_definition.namespace){if(!namespace[class_definition.namespace]){namespace[class_definition.namespace]=new Object;console.warn("created new namespace: ",class_definition.namespace)}namespace=namespace[class_definition.namespace]}if(!namespace[class_name])namespace[class_name]=class_constructor;else throw new Error("can't create class with same definition name");}catch(exception){console.error("class_definition --\x3e");console.error(class_definition)}finally{console.warn("class defined: ",
class_definition.name)}}};function guid(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()};oop.define_class({namespace:"gb",name:"vec2",init:function(){this.m_data=new Float32Array(2);if(arguments[0]instanceof gb.vec2){this.m_data[0]=arguments[0].x;this.m_data[1]=arguments[0].y}else if(arguments.length===1){this.m_data[0]=arguments[0];this.m_data[1]=arguments[0]}else if(arguments.length===2){this.m_data[0]=arguments[0];this.m_data[1]=arguments[1]}else{this.m_data[0]=0;this.m_data[1]=0}Object.defineProperty(this,"x",{configurable:true,get:function(){return this.m_data[0]},set:function(value){this.m_data[0]=
value}});Object.defineProperty(this,"y",{configurable:true,get:function(){return this.m_data[1]},set:function(value){this.m_data[1]=value}})},release:function(){},methods:{add:function(vector){this.m_data[0]+=vector.m_data[0];this.m_data[1]+=vector.m_data[1];return this},add_scalar:function(scalar){this.m_data[0]+=scalar;this.m_data[1]+=scalar;return this},sub:function(value){this.m_data[0]-=value.m_data[0];this.m_data[1]-=value.m_data[1];return this},sub_scalar:function(value){this.m_data[0]-=value;
this.m_data[1]-=value;return this},multiply:function(value){this.m_data[0]*=value.m_data[0];this.m_data[1]*=value.m_data[1];return this},multiply_scalar:function(value){this.m_data[0]*=value;this.m_data[1]*=value;return this},divide:function(value){this.m_data[0]/=value.m_data[0];this.m_data[1]/=value.m_data[1];return this},divide_scalar:function(value){this.m_data[0]/=value;this.m_data[1]/=value;return this},clamp:function(min,max){this.m_data[0]=Math.max(min.m_data[0],Math.min(max.m_data[0],this.m_data[0]));
this.m_data[1]=Math.max(min.m_data[1],Math.min(max.m_data[1],this.m_data[1]));return this},dot:function(value){return this.m_data[0]*value.m_data[0]+this.m_data[1]*value.m_data[1]},length:function(){return Math.sqrt(this.m_data[0]*this.m_data[0]+this.m_data[1]*this.m_data[1])},normalize:function(){return this.divide_scalar(this.length())},angle:function(){var angle=Math.atan2(this.m_data[1],this.m_data[0]);if(angle<0)angle+=2*Math.PI;return angle},distance_to:function(value){var dx=this.m_data[0]-
value.m_data[0],dy=this.m_data[1]-value.m_data[1];return Math.sqrt(dx*dx+dy*dy)},lerp:function(value,alpha){this.m_data[0]+=(value.m_data[0]-this.m_data[0])*alpha;this.m_data[1]+=(value.m_data[1]-this.m_data[1])*alpha;return this},equals:function(value){return value.m_data[0]===this.m_data[0]&&value.m_data[1]===this.m_data[1]},min:function(value){this.m_data[0]=Math.min(this.m_data[0],value.m_data[0]);this.m_data[1]=Math.min(this.m_data[1],value.m_data[1]);return this},max:function(value){this.m_data[0]=
Math.max(this.m_data[0],value.m_data[0]);this.m_data[1]=Math.max(this.m_data[1],value.m_data[1]);return this},to_array:function(){return this.m_data}},static_methods:{add:function(vector_01,vector_02){return new gb.vec2(vector_01.m_data[0]+vector_02.m_data[0],vector_01.m_data[1]+vector_02.m_data[1])},sub:function(vector_01,vector_02){return new gb.vec2(vector_01.m_data[0]-vector_02.m_data[0],vector_01.m_data[1]-vector_02.m_data[1])},lerp:function(vector_01,vector_02,alpha){return gb.vec2.sub(vector_02,
vector_01).multiply_scalar(alpha).add(vector_01)},equals:function(vector_01,vector_02){return vector_01.m_data[0]===vector_02.m_data[0]&&vector_01.m_data[1]===vector_02.m_data[1]},min:function(vector_01,vector_02){var vector_03=new gb.vec2(0);vector_03.m_data[0]=Math.min(vector_01.m_data[0],vector_02.m_data[0]);vector_03.m_data[1]=Math.min(vector_01.m_data[1],vector_02.m_data[1]);return vector_03},max:function(vector_01,vector_02){var vector_03=new gb.vec2(0);vector_03.m_data[0]=Math.max(vector_01.m_data[0],
vector_02.m_data[0]);vector_03.m_data[1]=Math.max(vector_01.m_data[1],vector_02.m_data[1]);return vector_03}}});oop.define_class({namespace:"gb",name:"vec3",init:function(){this.m_data=new Float32Array(3);if(arguments[0]instanceof gb.vec3){this.m_data[0]=arguments[0].x;this.m_data[1]=arguments[0].y;this.m_data[2]=arguments[0].z}else if(arguments.length===1){this.m_data[0]=arguments[0];this.m_data[1]=arguments[0];this.m_data[2]=arguments[0]}else if(arguments.length===3){this.m_data[0]=arguments[0];this.m_data[1]=arguments[1];this.m_data[2]=arguments[2]}else{this.m_data[0]=0;this.m_data[1]=0;this.m_data[2]=0}Object.defineProperty(this,
"x",{get:function(){return this.m_data[0]},set:function(value){this.m_data[0]=value}});Object.defineProperty(this,"y",{get:function(){return this.m_data[1]},set:function(value){this.m_data[1]=value}});Object.defineProperty(this,"z",{get:function(){return this.m_data[2]},set:function(value){this.m_data[2]=value}})},release:function(){},methods:{add:function(value){this.x+=value.x;this.y+=value.y;this.z+=value.z;return this},add_scalar:function(value){this.x+=value;this.y+=value;this.z+=value;return this},
sub:function(value){this.x-=value.x;this.y-=value.y;this.z-=value.z;return this},sub_scalar:function(value){this.x-=value;this.y-=value;this.z-=value;return this},multiply:function(value){this.x*=value.x;this.y*=value.y;this.z*=value.z;return this},multiply_scalar:function(value){this.x*=value;this.y*=value;this.z*=value;return this},divide:function(value){this.x/=value.x;this.y/=value.y;this.z/=value.z;return this},divide_scalar:function(value){this.x/=value;this.y/=value;this.z/=value;return this},
min:function(value){this.x=Math.min(this.x,value.x);this.y=Math.min(this.y,value.y);this.z=Math.min(this.z,value.z);return this},max:function(value){this.x=Math.max(this.x,value.x);this.y=Math.max(this.y,value.y);this.z=Math.max(this.z,value.z);return this},clamp:function(min,max){this.x=Math.max(min.x,Math.min(max.x,this.x));this.y=Math.max(min.y,Math.min(max.y,this.y));this.z=Math.max(min.z,Math.min(max.z,this.z));return this},dot:function(value){return this.x*value.x+this.y*value.y+this.z*value.z},
cross:function(value){var x=this.x,y=this.y,z=this.z;this.x=y*value.z-z*value.y;this.y=z*value.x-x*value.z;this.z=x*value.y-y*value.x;return this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},length_sq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(){return this.divide_scalar(this.length())},distance_to:function(value){var dx=this.x-value.x,dy=this.y-value.y,dz=this.z-value.z;return Math.sqrt(dx*dx+dy*dy+dz*dz)},lerp:function(value,
alpha){this.x+=(value.x-this.x)*alpha;this.y+=(value.y-this.y)*alpha;this.z+=(value.z-this.z)*alpha;return this},lerp_vectors:function(value_01,value_02,alpha){this.sub_vectors(value_02,value_01).multiply_scalar(alpha).add(value_01);return this},equals:function(value){return value.x===this.x&&value.y===this.y&&value.z===this.z},to_array:function(){return this.m_data}},static_methods:{add:function(vector_01,vector_02){return new gb.vec3(vector_01.x+vector_02.x,vector_01.y+vector_02.y,vector_01.z+vector_02.z)},
sub:function(vector_01,vector_02){return new gb.vec3(vector_01.x-vector_02.x,vector_01.y-vector_02.y,vector_01.z-vector_02.z)},cross:function(vector_01,vector_02){return new gb.vec3(vector_01.y*vector_02.z-vector_01.z*vector_02.y,vector_01.z*vector_02.x-vector_01.x*vector_02.z,vector_01.x*vector_02.y-vector_01.y*vector_02.x)}}});oop.define_class({namespace:"gb",name:"vec4",init:function(){this.m_data=new Float32Array(4);if(arguments[0]instanceof gb.vec4){this.m_data[0]=arguments[0].x;this.m_data[1]=arguments[0].y;this.m_data[2]=arguments[0].z;this.m_data[3]=arguments[0].w}else if(arguments.length===1){this.m_data[0]=arguments[0];this.m_data[1]=arguments[0];this.m_data[2]=arguments[0];this.m_data[3]=arguments[0]}else if(arguments.length===4){this.m_data[0]=arguments[0];this.m_data[1]=arguments[1];this.m_data[2]=arguments[2];
this.m_data[3]=arguments[3]}else{this.m_data[0]=0;this.m_data[1]=0;this.m_data[2]=0;this.m_data[3]=0}Object.defineProperty(this,"x",{get:function(){return this.m_data[0]},set:function(value){this.m_data[0]=value}});Object.defineProperty(this,"y",{get:function(){return this.m_data[1]},set:function(value){this.m_data[1]=value}});Object.defineProperty(this,"z",{get:function(){return this.m_data[2]},set:function(value){this.m_data[2]=value}});Object.defineProperty(this,"w",{get:function(){return this.m_data[3]},
set:function(value){this.m_data[3]=value}})},release:function(){},methods:{add:function(value){this.x+=value.x;this.y+=value.y;this.z+=value.z;this.w+=value.w;return this},add_scalar:function(value){this.x+=value;this.y+=value;this.z+=value;this.w+=value;return this},add_vectors:function(value_01,value_02){this.x=value_01.x+value_02.x;this.y=value_01.y+value_02.y;this.z=value_01.z+value_02.z;this.w=value_01.w+value_02.w;return this},sub:function(value){this.x-=value.x;this.y-=value.y;this.z-=value.z;
this.w-=value.w;return this},sub_scalar:function(value){this.x-=value;this.y-=value;this.z-=value;this.w-=value;return this},sub_vectors:function(value_01,value_02){this.x=value_01.x-value_02.x;this.y=value_01.y-value_02.y;this.z=value_01.z-value_02.z;this.w=value_01.w-value_02.w;return this},multiply:function(value){this.x*=value.x;this.y*=value.y;this.z*=value.z;this.w*=value.w;return this},multiply_scalar:function(value){this.x*=value;this.y*=value;this.z*=value;this.w*=value;return this},divide:function(value){this.x/=
value.x;this.y/=value.y;this.z/=value.z;this.w/=value.w;return this},divide_scalar:function(value){this.x/=value;this.y/=value;this.z/=value;this.w/=value;return this},min:function(value){this.x=Math.min(this.x,value.x);this.y=Math.min(this.y,value.y);this.z=Math.min(this.z,value.z);this.w=Math.min(this.w,value.w);return this},max:function(value){this.x=Math.max(this.x,value.x);this.y=Math.max(this.y,value.y);this.z=Math.max(this.z,value.z);this.w=Math.max(this.w,value.w);return this},clamp:function(min,
max){this.x=Math.max(min.x,Math.min(max.x,this.x));this.y=Math.max(min.y,Math.min(max.y,this.y));this.z=Math.max(min.z,Math.min(max.z,this.z));this.w=Math.max(min.w,Math.min(max.w,this.w));return this},dot:function(value){return this.x*value.x+this.y*value.y+this.z*value.z+this.w*value.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){return this.divide_scalar(this.length())},lerp:function(value,alpha){this.x+=(value.x-this.x)*alpha;
this.y+=(value.y-this.y)*alpha;this.z+=(value.z-this.z)*alpha;this.w+=(value.w-this.w)*alpha;return this},lerp_vectors:function(value_01,value_02,alpha){this.sub_vectors(value_02,value_01).multiply_scalar(alpha).add(value_01);return this},equals:function(value){return value.x===this.x&&value.y===this.y&&value.z===this.z&&value.w===this.w},to_array:function(){return this.m_data}},static_methods:{}});oop.define_class({namespace:"gb",name:"mat4",init:function(){this.m_elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},release:function(){},methods:{identity:function(){this.m_elements[0]=1;this.m_elements[4]=0;this.m_elements[8]=0;this.m_elements[12]=0;this.m_elements[1]=0;this.m_elements[5]=1;this.m_elements[9]=0;this.m_elements[13]=0;this.m_elements[2]=0;this.m_elements[6]=0;this.m_elements[10]=1;this.m_elements[14]=0;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=0;this.m_elements[15]=
1;return this},rotate:function(euler){var x=euler.x,y=euler.y,z=euler.z;var a=Math.cos(x),b=Math.sin(x);var c=Math.cos(y),d=Math.sin(y);var e=Math.cos(z),f=Math.sin(z);var ae=a*e,af=a*f,be=b*e,bf=b*f;this.m_elements[0]=c*e;this.m_elements[4]=-c*f;this.m_elements[8]=d;this.m_elements[1]=af+be*d;this.m_elements[5]=ae-bf*d;this.m_elements[9]=-b*c;this.m_elements[2]=bf-ae*d;this.m_elements[6]=be+af*d;this.m_elements[10]=a*c;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=0;this.m_elements[12]=
0;this.m_elements[13]=0;this.m_elements[14]=0;this.m_elements[15]=1;return this},translate:function(x,y,z){this.identity();this.m_elements[12]=x;this.m_elements[13]=y;this.m_elements[14]=z;return this},rotation_x:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.m_elements[0]=1;this.m_elements[4]=0;this.m_elements[8]=0;this.m_elements[12]=0;this.m_elements[1]=0;this.m_elements[5]=c;this.m_elements[9]=-s;this.m_elements[13]=0;this.m_elements[2]=0;this.m_elements[6]=s;this.m_elements[10]=
c;this.m_elements[14]=0;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=0;this.m_elements[15]=1;return this},rotate_y:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.m_elements[0]=c;this.m_elements[4]=0;this.m_elements[8]=s;this.m_elements[12]=0;this.m_elements[1]=0;this.m_elements[5]=1;this.m_elements[9]=0;this.m_elements[13]=0;this.m_elements[2]=-s;this.m_elements[6]=0;this.m_elements[10]=c;this.m_elements[14]=0;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=
0;this.m_elements[15]=1;return this},rotate_z:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.m_elements[0]=c;this.m_elements[4]=-s;this.m_elements[8]=0;this.m_elements[12]=0;this.m_elements[1]=s;this.m_elements[5]=c;this.m_elements[9]=0;this.m_elements[13]=0;this.m_elements[2]=0;this.m_elements[6]=0;this.m_elements[10]=1;this.m_elements[14]=0;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=0;this.m_elements[15]=1;return this},scale:function(x,y,z){this.m_elements[0]=x;
this.m_elements[4]=0;this.m_elements[8]=0;this.m_elements[12]=0;this.m_elements[1]=0;this.m_elements[5]=y;this.m_elements[9]=0;this.m_elements[13]=0;this.m_elements[2]=0;this.m_elements[6]=0;this.m_elements[10]=z;this.m_elements[14]=0;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=0;this.m_elements[15]=1;return this},frustum:function(left,right,bottom,top,near,far){var x=2*near/(right-left);var y=2*near/(top-bottom);var a=(right+left)/(right-left);var b=(top+bottom)/(top-bottom);var c=
-(far+near)/(far-near);var d=-2*far*near/(far-near);this.m_elements[0]=x;this.m_elements[4]=0;this.m_elements[8]=a;this.m_elements[12]=0;this.m_elements[1]=0;this.m_elements[5]=y;this.m_elements[9]=b;this.m_elements[13]=0;this.m_elements[2]=0;this.m_elements[6]=0;this.m_elements[10]=c;this.m_elements[14]=d;this.m_elements[3]=0;this.m_elements[7]=0;this.m_elements[11]=-1;this.m_elements[15]=0;return this},perspective:function(fov,aspect,near,far){var ymax=near*Math.tan(gb.math.radians(fov*.5));var ymin=
-ymax;var xmin=ymin*aspect;var xmax=ymax*aspect;return this.frustum(xmin,xmax,ymin,ymax,near,far)},ortho:function(left,right,bottom,top,near,far){this.identity();this.m_elements[0]=2/(right-left);this.m_elements[5]=2/(top-bottom);this.m_elements[10]=-2/(far-near);this.m_elements[12]=-(right+left)/(right-left);this.m_elements[13]=-(top+bottom)/(top-bottom);this.m_elements[14]=-(far+near)/(far-near);return this},look_at:function(eye,target,up){var x=new gb.vec3;var y=new gb.vec3;var z=new gb.vec3;z=
gb.vec3.sub(eye,target).normalize();if(z.length_sq()===0)z.z=1;x=gb.vec3.cross(up,z).normalize();if(x.length_sq()===0){z.x+=1E-4;x=gb.vec3.cross(up,z).normalize()}y=gb.vec3.cross(z,x);this.m_elements[0]=x.x;this.m_elements[4]=y.x;this.m_elements[8]=z.x;this.m_elements[1]=x.y;this.m_elements[5]=y.y;this.m_elements[9]=z.y;this.m_elements[2]=x.z;this.m_elements[6]=y.z;this.m_elements[10]=z.z;return this},equals:function(matrix){for(var i=0;i<16;i++)if(this.m_elements[i]!==matrix.m_elements[i])return false;
return true},to_array:function(){return this.m_elements}},static_methods:{multiply:function(matrix_01,matrix_02){var ae=matrix_01.m_elements;var be=matrix_02.m_elements;var matrix_03=new gb.mat4;var a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12];var a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13];var a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14];var a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15];var b11=be[0],b12=be[4],b13=be[8],b14=be[12];var b21=be[1],b22=be[5],b23=be[9],b24=be[13];var b31=be[2],b32=be[6],b33=be[10],
b34=be[14];var b41=be[3],b42=be[7],b43=be[11],b44=be[15];matrix_03.m_elements[0]=a11*b11+a12*b21+a13*b31+a14*b41;matrix_03.m_elements[4]=a11*b12+a12*b22+a13*b32+a14*b42;matrix_03.m_elements[8]=a11*b13+a12*b23+a13*b33+a14*b43;matrix_03.m_elements[12]=a11*b14+a12*b24+a13*b34+a14*b44;matrix_03.m_elements[1]=a21*b11+a22*b21+a23*b31+a24*b41;matrix_03.m_elements[5]=a21*b12+a22*b22+a23*b32+a24*b42;matrix_03.m_elements[9]=a21*b13+a22*b23+a23*b33+a24*b43;matrix_03.m_elements[13]=a21*b14+a22*b24+a23*b34+a24*
b44;matrix_03.m_elements[2]=a31*b11+a32*b21+a33*b31+a34*b41;matrix_03.m_elements[6]=a31*b12+a32*b22+a33*b32+a34*b42;matrix_03.m_elements[10]=a31*b13+a32*b23+a33*b33+a34*b43;matrix_03.m_elements[14]=a31*b14+a32*b24+a33*b34+a34*b44;matrix_03.m_elements[3]=a41*b11+a42*b21+a43*b31+a44*b41;matrix_03.m_elements[7]=a41*b12+a42*b22+a43*b32+a44*b42;matrix_03.m_elements[11]=a41*b13+a42*b23+a43*b33+a44*b43;matrix_03.m_elements[15]=a41*b14+a42*b24+a43*b34+a44*b44;return matrix_03},multiply_vec4:function(vector,
matrix){var result=new gb.vec4;result.x=matrix.m_elements[0]*vector.x+matrix.m_elements[4]*vector.y+matrix.m_elements[8]*vector.z+matrix.m_elements[12]*vector.w;result.y=matrix.m_elements[1]*vector.x+matrix.m_elements[5]*vector.y+matrix.m_elements[9]*vector.z+matrix.m_elements[13]*vector.w;result.z=matrix.m_elements[2]*vector.x+matrix.m_elements[6]*vector.y+matrix.m_elements[10]*vector.z+matrix.m_elements[14]*vector.w;result.w=matrix.m_elements[3]*vector.x+matrix.m_elements[7]*vector.y+matrix.m_elements[11]*
vector.z+matrix.m_elements[15]*vector.w;return result},multiply_vec2:function(vector,matrix){var result=new gb.vec2;result.x=matrix.m_elements[0]*vector.x+matrix.m_elements[4]*vector.y+matrix.m_elements[12];result.y=matrix.m_elements[1]*vector.x+matrix.m_elements[5]*vector.y+matrix.m_elements[13];return result}}});oop.define_class({namespace:"gb",name:"math",constants:{INT16_MAX:32767,INT16_MIN:-32768,orientation:{colinear:0,clockwise:1,counterclockwise:2}},init:function(){},release:function(){},methods:{},static_methods:{radians:function(degrees){return Math.PI/180*degrees},degrees:function(radians){return 180/Math.PI*radians},is_int:function(value){return Number(value)===value&&value%1===0},is_float:function(value){return Number(value)===value&&value%1!==0},intersect_min_max_bound:function(min_bound,max_bound,
point){if(point.x>=min_bound.x&&point.x<=max_bound.x&&point.y>=min_bound.y&&point.y<=max_bound.y)return true;return false},intersect:function(ray_origin,ray_direction,edge_point_01,edge_point_02){var r_px=ray_origin.x;var r_py=ray_origin.y;var r_dx=ray_direction.x-ray_origin.x;var r_dy=ray_direction.y-ray_origin.y;var s_px=edge_point_01.x;var s_py=edge_point_01.y;var s_dx=edge_point_02.x-edge_point_01.x;var s_dy=edge_point_02.y-edge_point_01.y;var r_mag=Math.sqrt(r_dx*r_dx+r_dy*r_dy);var s_mag=Math.sqrt(s_dx*
s_dx+s_dy*s_dy);if(r_dx/r_mag===s_dx/s_mag&&r_dy/r_mag===s_dy/s_mag)return{intersected:false};var t_2=(r_dx*(s_py-r_py)+r_dy*(r_px-s_px))/(s_dx*r_dy-s_dy*r_dx);var t_1=(s_px+s_dx*t_2-r_px)/r_dx;if(t_1<0)return{intersected:false};if(t_2<0||t_2>1)return{intersected:false};return{intersected:true,point_x:r_px+r_dx*t_1,point_y:r_py+r_dy*t_1,distance:t_1}},rect_intersect:function(rect_01,rect_02){if(rect_02.x<rect_01.x+rect_01.z&&rect_01.x<rect_02.x+rect_02.z&&rect_02.y<rect_01.y+rect_01.w)return rect_01.y<
rect_02.y+rect_02.w;return false},rect_contains:function(rect_01,rect_02){return rect_02.x>rect_01.x&&rect_02.y>rect_01.y&&rect_02.z<rect_01.z&&rect_02.w<rect_01.w},point_orientation:function(point_01,point_02,point_03){var result=(point_02.y-point_01.y)*(point_03.x-point_02.x)-(point_02.x-point_01.x)*(point_03.y-point_02.y);if(result===0)return gb.math.orientation.colinear;return result>0?gb.math.orientation.clockwise:gb.math.orientation.counterclockwise},is_pot:function(value){return value!==0&&
(value&value-1)===0}}});var gl=null;
oop.define_class({namespace:"gb",name:"graphics_context",init:function(){var canvas=document.getElementById("gl_canvas");console.log(canvas);var gl_context=null;try{gl_context=canvas.getContext("webgl",{depth:false,antialias:true});gl_context.viewport_width=canvas.width;gl_context.viewport_height=canvas.height;console.log("OpenGL context created");console.log("viewport: [ "+gl_context.viewport_width+", "+gl_context.viewport_height+" ]")}catch(exception){alert(exception)}if(!gl_context)alert("could not initialise gl context");gl=
gl_context},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"resource_transfering_data",constants:{type:{undefined:0,shader:1,texture:2}},init:function(){this.m_type=gb.resource_transfering_data.type.undefined;Object.defineProperty(this,"type",{get:function(){return this.m_type}})},release:function(){}});oop.define_class({namespace:"gb",name:"shader_transfering_data",extend:gb.resource_transfering_data,init:function(){this.m_type=gb.resource_transfering_data.type.shader;this.m_vs_source_code="";this.m_fs_source_code="";this.m_handler=-1;Object.defineProperty(this,"vs_source_code",{get:function(){return this.m_vs_source_code},set:function(value){this.m_vs_source_code=value}});Object.defineProperty(this,"fs_source_code",{get:function(){return this.m_fs_source_code},set:function(value){this.m_fs_source_code=
value}});Object.defineProperty(this,"handler",{get:function(){return this.m_handler},set:function(value){this.m_handler=value}})},release:function(){}});oop.define_class({namespace:"gb",name:"texture_transfering_data",extend:gb.resource_transfering_data,init:function(){this.m_type=gb.resource_transfering_data.type.texture;this.m_width=0;this.m_height=0;this.m_data=null;this.m_handler=-1;Object.defineProperty(this,"width",{get:function(){return this.m_width},set:function(value){this.m_width=value}});Object.defineProperty(this,"height",{get:function(){return this.m_height},set:function(value){this.m_height=value}});Object.defineProperty(this,"handler",
{get:function(){return this.m_handler},set:function(value){this.m_handler=value}});Object.defineProperty(this,"data",{get:function(){return this.m_data},set:function(value){this.m_data=value}})},release:function(){}});oop.define_class({namespace:"gb",name:"resource_base",constants:{type:{undefined:0,shader:1,texture:2},status:{unloaded:0,loaded:1,commited:2}},init:function(guid){this.m_guid=guid;this.m_type=gb.resource_base.type.undefined;this.m_status=gb.resource_base.status.unloaded;this.m_callbacks=[];this.m_userdata_container=[];Object.defineProperty(this,"guid",{get:function(){return this.m_guid}});Object.defineProperty(this,"type",{get:function(){return this.m_type}});Object.defineProperty(this,"status",
{get:function(){return this.m_status}});Object.defineProperty(this,"is_commited",{get:function(){return gb.resource_base.status.commited}})},release:function(){},methods:{on_resource_loaded:function(success){for(var i=0;i<this.m_callbacks.length;++i){var callback=this.m_callbacks[i];callback(success?this:null,this.m_userdata_container[i])}this.m_callbacks=[];this.m_userdata_container=[]},add_resource_loading_callback:function(callback,userdata){if(_.isFunction(callback))if(!_.contains(this.m_callbacks,
callback))if(this.status===gb.resource_base.status.commited)callback(this,userdata);else{this.m_callbacks.push(callback);this.m_userdata_container.push(userdata)}else console.error("can't add same callback for resource loading");else console.error("resource loading callback isn't function")},remove_resource_loading_callback:function(callback){var index=_.indexOf(this.m_callbacks,callback);if(index!==-1){this.m_callbacks.splice(index,1);this.m_userdatas.splice(index,1)}else console.error("resource doesn't contain this callback")}}});oop.define_class({namespace:"gb",name:"shader_uniform",constants:{type:{undefined:-1,mat4:0,mat4_array:1,vec4:2,vec4_array:3,vec3:4,vec3_array:5,vec2:6,vec2_array:7,f32:8,f32_array:9,i32:10,i32_array:11,sampler:12}},init:function(){this.m_type=gb.shader_uniform.type.undefined;Object.defineProperty(this,"type",{get:function(){return this.m_type},set:function(value){this.m_type=value}});Object.defineProperty(this,"mat4_value",{get:function(){return this.m_mat4_value},set:function(value){this.m_mat4_value=
value}});Object.defineProperty(this,"vec4_value",{get:function(){return this.m_vec4_value},set:function(value){this.m_vec4_value=value}});Object.defineProperty(this,"vec3_value",{get:function(){return this.m_vec3_value},set:function(value){this.m_vec3_value=value}});Object.defineProperty(this,"vec2_value",{get:function(){return this.m_vec2_value},set:function(value){this.m_vec2_value=value}});Object.defineProperty(this,"f32_value",{get:function(){return this.m_f32_value},set:function(value){this.m_f32_value=
value}});Object.defineProperty(this,"i32_value",{get:function(){return this.m_i32_value},set:function(value){this.m_i32_value=value}});Object.defineProperty(this,"sampler_index",{get:function(){return this.m_sampler_index}});Object.defineProperty(this,"sampler_texture",{get:function(){return this.m_sampler_texture}})},release:function(){},methods:{set_sampler:function(texture,index){this.m_sampler_texture=texture;this.m_sampler_index=index}}});
oop.define_class({namespace:"gb",name:"shader",extend:gb.resource_base,constants:{sampler_type:{sampler_01:0,sampler_02:1,sampler_03:2,sampler_04:3,sampler_05:4,sampler_06:5,sampler_07:6,sampler_08:7,max:8},attribute_type:{position:0,texcoord:1,color:2,max:3},uniform_type:{mat_m:0,mat_p:1,mat_v:2,max:3},attribute_names:{a_position:"a_position",a_texcoord:"a_texcoord",a_color:"a_color"},uniform_names:{u_mat_m:"u_mat_m",u_mat_p:"u_mat_p",u_mat_v:"u_mat_v"},sampler_names:{sampler_01:"sampler_01",sampler_02:"sampler_02",
sampler_03:"sampler_03",sampler_04:"sampler_04",sampler_05:"sampler_05",sampler_06:"sampler_06",sampler_07:"sampler_07",sampler_08:"sampler_08"}},init:function(){this.m_type=gb.resource_base.type.shader;this.m_handler=-1;this.m_uniforms=[];this.m_uniforms[gb.shader.uniform_type.max-1]=-1;this.m_samplers=[];this.m_samplers[gb.shader.sampler_type.max-1]=-1;this.m_attributes=[];this.m_attributes[gb.shader.attribute_type.max-1]=-1;this.m_custom_uniforms=[];this.m_custom_attributes=[];this.m_cached_uniforms=
[];Object.defineProperty(this,"attributes",{get:function(){return this.m_attributes}})},release:function(){},methods:{setup:function(){this.m_uniforms[gb.shader.uniform_type.mat_m]=gl.getUniformLocation(this.m_handler,gb.shader.uniform_names.u_mat_m);this.m_uniforms[gb.shader.uniform_type.mat_v]=gl.getUniformLocation(this.m_handler,gb.shader.uniform_names.u_mat_v);this.m_uniforms[gb.shader.uniform_type.mat_p]=gl.getUniformLocation(this.m_handler,gb.shader.uniform_names.u_mat_p);this.m_samplers[gb.shader.sampler_type.sampler_01]=
gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_01);this.m_samplers[gb.shader.sampler_type.sampler_02]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_02);this.m_samplers[gb.shader.sampler_type.sampler_03]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_03);this.m_samplers[gb.shader.sampler_type.sampler_04]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_04);this.m_samplers[gb.shader.sampler_type.sampler_05]=gl.getUniformLocation(this.m_handler,
gb.shader.sampler_names.sampler_05);this.m_samplers[gb.shader.sampler_type.sampler_06]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_06);this.m_samplers[gb.shader.sampler_type.sampler_07]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_07);this.m_samplers[gb.shader.sampler_type.sampler_08]=gl.getUniformLocation(this.m_handler,gb.shader.sampler_names.sampler_08);this.m_attributes[gb.shader.attribute_type.position]=gl.getAttribLocation(this.m_handler,gb.shader.attribute_names.a_position);
this.m_attributes[gb.shader.attribute_type.texcoord]=gl.getAttribLocation(this.m_handler,gb.shader.attribute_names.a_texcoord);this.m_attributes[gb.shader.attribute_type.color]=gl.getAttribLocation(this.m_handler,gb.shader.attribute_names.a_color)},on_transfering_data_serialized:function(data){switch(data.type){case gb.resource_transfering_data.type.shader:this.m_status=gb.resource_base.status.loaded;break}},on_transfering_data_commited:function(data){switch(data.type){case gb.resource_transfering_data.type.shader:this.m_handler=
data.handler;this.m_status=gb.resource_base.status.commited;this.setup();break}},get_custom_uniform:function(uniform){var handler=-1;if(typeof this.m_custom_uniforms[uniform]!=="undefined")handler=this.m_custom_uniforms[uniform];else{handler=gl.getUniformLocation(this.m_handler,uniform);this.m_custom_uniforms[uniform]=handler}return handler},set_mat4:function(value,uniform){if(this.status===gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===
value)return;else if(typeof this.m_cached_uniforms[uniform]==="undefined")this.m_cached_uniforms[uniform]=new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniformMatrix4fv(handler,false,new Float32Array(value.to_array()));this.m_cached_uniforms[uniform].mat4_value=value}},set_custom_mat4:function(value,uniform){if(this.status===gb.resource_base.status.commited)gl.uniformMatrix4fv(this.get_custom_uniform(uniform),false,new Float32Array(value.to_array()))},set_vec4:function(value,uniform){if(this.status===
gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===value)return;else if(typeof this.m_cached_uniforms[uniform]==="undefined")this.m_cached_uniforms[uniform]=new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniform4fv(handler,new Float32Array(value.to_array()));this.m_cached_uniforms[uniform].vec4_value=value}},set_custom_vec4:function(value,uniform){if(this.status===gb.resource_base.status.commited)gl.uniform4fv(this.get_custom_uniform(uniform),
new Float32Array(value.to_array()))},set_vec3:function(value,uniform){if(this.status===gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===value)return;else if(typeof this.m_cached_uniforms[uniform]==="undefined")this.m_cached_uniforms[uniform]=new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniform3fv(handler,new Float32Array(value.to_array()));this.m_cached_uniforms[uniform].vec3_value=value}},set_custom_vec3:function(value,
uniform){if(this.status===gb.resource_base.status.commited)gl.uniform3fv(this.get_custom_uniform(uniform),new Float32Array(value.to_array()))},set_vec2:function(value,uniform){if(this.status===gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===value)return;else if(typeof this.m_cached_uniforms[uniform]==="undefined")this.m_cached_uniforms[uniform]=new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniform2fv(handler,
new Float32Array(value.to_array()));this.m_cached_uniforms[uniform].vec2_value=value}},set_custom_vec2:function(value,uniform){if(this.status===gb.resource_base.status.commited)gl.uniform2fv(this.get_custom_uniform(uniform),new Float32Array(value.to_array()))},set_f32:function(value,uniform){if(this.status===gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===value)return;else if(typeof this.m_cached_uniforms[uniform]==="undefined")this.m_cached_uniforms[uniform]=
new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniform1f(handler,value);this.m_cached_uniforms[uniform].f32_value=value}},set_custom_f32:function(value,uniform){if(this.status===gb.resource_base.status.commited)gl.uniform1f(this.get_custom_uniform(uniform),value)},set_i32:function(value,uniform){if(this.status===gb.resource_base.status.commited){if(typeof this.m_cached_uniforms[uniform]!=="undefined"&&this.m_cached_uniforms[uniform]===value)return;else if(typeof this.m_cached_uniforms[uniform]===
"undefined")this.m_cached_uniforms[uniform]=new gb.shader_uniform;var handler=this.m_uniforms[uniform];gl.uniform1i(handler,value);this.m_cached_uniforms[uniform].i32_value=value}},set_custom_i32:function(value,uniform){if(this.status===gb.resource_base.status.commited)gl.uniform1i(this.get_custom_uniform(uniform),value)},set_texture:function(texture,sampler){if(this.status===gb.resource_base.status.commited&&sampler<gb.shader.sampler_type.max){gl.activeTexture(gl.TEXTURE0+sampler);texture.bind();
gl.uniform1i(this.m_samplers[sampler],sampler)}},bind:function(){if(this.status===gb.resource_base.status.commited)gl.useProgram(this.m_handler)},unbind:function(){if(this.status===gb.resource_base.status.commited)gl.useProgram(null)}},static_methods:{construct:function(guid,vs_source_code,fs_source_code){var shader=null;var shader_compiler=new gb.shader_compiler_glsl;var vs_handler=shader_compiler.compile(vs_source_code,gl.VERTEX_SHADER);if(vs_handler!==-1){var fs_handler=shader_compiler.compile(fs_source_code,
gl.FRAGMENT_SHADER);if(fs_handler!==-1){var handler=shader_compiler.link(vs_handler,fs_handler);if(handler!==-1){shader=new gb.shader(guid);shader.m_handler=handler;shader.m_status=gb.resource_base.status.commited;shader.setup()}}}return shader}}});oop.define_class({namespace:"gb",name:"texture",extend:gb.resource_base,init:function(){this.m_type=gb.resource_base.type.texture;this.m_handler=-1;this.m_width=0;this.m_height=0;this.m_setted_wrap_mode=0;this.m_presseted_wrap_mode=gl.CLAMP_TO_EDGE;this.m_setted_mag_filter=0;this.m_presetted_mag_filter=gl.NEAREST;this.m_setted_min_filter=0;this.m_presetted_min_filter=gl.NEAREST;Object.defineProperty(this,"handler",{get:function(){return this.m_handler}});Object.defineProperty(this,"width",{get:function(){return this.m_width}});
Object.defineProperty(this,"height",{get:function(){return this.m_height}});Object.defineProperty(this,"wrap_mode",{set:function(value){this.m_presseted_wrap_mode=value}});Object.defineProperty(this,"mag_filter",{set:function(value){this.m_presetted_mag_filter=value}});Object.defineProperty(this,"min_filter",{set:function(value){this.m_presetted_min_filter=value}})},release:function(){gl.deleteTexture(this.m_handler)},methods:{on_transfering_data_serialized:function(data){switch(data.type){case gb.resource_transfering_data.type.texture:this.m_status=
gb.resource_base.status.loaded;break}},on_transfering_data_commited:function(data){switch(data.type){case gb.resource_transfering_data.type.texture:this.m_handler=data.handler;this.m_width=data.width;this.m_height=data.height;this.m_status=gb.resource_base.status.commited;break}},bind:function(){if(this.status===gb.resource_base.status.commited){gl.bindTexture(gl.TEXTURE_2D,this.m_handler);if(this.m_presseted_wrap_mode!==this.m_setted_wrap_mode){this.m_setted_wrap_mode=this.m_presseted_wrap_mode;
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,this.m_setted_wrap_mode);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,this.m_setted_wrap_mode)}if(this.m_presetted_min_filter!==this.m_setted_min_filter){this.m_setted_min_filter=this.m_presetted_min_filter;gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.m_setted_min_filter)}if(this.m_presetted_mag_filter!==this.m_setted_mag_filter){this.m_setted_mag_filter=this.m_presetted_mag_filter;gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,
this.m_setted_mag_filter)}}},unbind:function(){gl.bindTexture(gl.TEXTURE_2D,null)}},static_methods:{construct:function(guid,handler,width,height){var texture=new gb.texture(guid);texture.m_handler=handler;texture.m_width=width;texture.m_height=height;texture.m_status=gb.resource_base.status.commited;return texture}}});oop.define_class({namespace:"gb",name:"ibo",init:function(size,mode){this.m_handler=gl.createBuffer();this.m_allocated_size=size;this.m_used_size=size;this.m_mode=mode;this.m_stride=2;var size_in_bytes=size*this.m_stride;this.m_data=new ArrayBuffer(size_in_bytes);this.m_data_accessor=new DataView(this.m_data);Object.defineProperty(this,"allocated_size",{get:function(){return this.m_allocated_size}});Object.defineProperty(this,"used_size",{get:function(){return this.m_used_size}})},release:function(){gl.deleteBuffer(this.m_handler)},
methods:{write_element:function(index,value){if(index<this.m_allocated_size)this.m_data_accessor.setUint16(index*this.m_stride,value,true);else console.error("out of ibo bound")},read_attribute:function(index){if(index<this.m_allocated_size)return this.m_data_accessor.getUint16(index*this.m_stride,true);else console.error("out of ibo bound")},submit:function(size){var data=this.m_data;if(size&&size>0&&size<this.m_allocated_size){this.m_used_size=size;data=this.m_data.slice(0,size*this.m_stride)}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,
this.m_handler);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,data,this.m_mode)},bind:function(){if(this.m_used_size!==0)gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.m_handler)},unbind:function(){if(this.m_used_size!==0)gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}}});oop.define_class({namespace:"gb",name:"vbo",constants:{attribute:{position:0,texcoord:1,color:2},declaration:{position_xy:0,position_xy_texcoord_uv:1,position_xy_texcoord_uv_color_rgba:2}},init:function(size,mode,declaration){this.m_handler=gl.createBuffer();this.m_allocated_size=size;this.m_used_size=size;this.m_mode=mode;this.m_min_bound=new gb.vec2(gb.math.INT16_MAX);this.m_max_bound=new gb.vec2(gb.math.INT16_MIN);this.m_declaration=declaration;this.m_stride=0;switch(declaration){case gb.vbo.declaration.position_xy:this.m_stride=
8;break;case gb.vbo.declaration.position_xy_texcoord_uv:this.m_stride=16;break;case gb.vbo.declaration.position_xy_texcoord_uv_color_rgba:this.m_stride=32;break}var size_in_bytes=size*this.m_stride;this.m_data=new ArrayBuffer(size_in_bytes);this.m_data_accessor=new DataView(this.m_data);Object.defineProperty(this,"allocated_size",{get:function(){return this.m_allocated_size}});Object.defineProperty(this,"used_size",{get:function(){return this.m_used_size}});Object.defineProperty(this,"min_bound",
{get:function(){return this.m_min_bound}});Object.defineProperty(this,"max_bound",{get:function(){return this.m_max_bound}})},release:function(){gl.deleteBuffer(this.m_handler)},methods:{write_attribute:function(attribute,index,value){if(attribute===gb.vbo.attribute.position)if(index<this.m_allocated_size){this.m_data_accessor.setFloat32(index*this.m_stride+0,value.x,true);this.m_data_accessor.setFloat32(index*this.m_stride+4,value.y,true);this.m_min_bound.min(value);this.m_max_bound.max(value)}else console.error("out of vbo bound");
if(attribute===gb.vbo.attribute.texcoord&&(this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv||this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba))if(index<this.m_allocated_size){this.m_data_accessor.setFloat32(index*this.m_stride+8,value.x,true);this.m_data_accessor.setFloat32(index*this.m_stride+12,value.y,true)}else console.error("out of vbo bound");if(attribute===gb.vbo.attribute.color&&this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba)if(index<
this.m_allocated_size){this.m_data_accessor.setFloat32(index*this.m_stride+16,value.x,true);this.m_data_accessor.setFloat32(index*this.m_stride+20,value.y,true);this.m_data_accessor.setFloat32(index*this.m_stride+24,value.z,true);this.m_data_accessor.setFloat32(index*this.m_stride+28,value.w,true)}else console.error("out of vbo bound")},read_attribute:function(attribute,index){if(attribute===gb.vbo.attribute.position)if(index<this.m_allocated_size)return{x:this.m_data_accessor.getFloat32(index*this.m_stride+
0,true),y:this.m_data_accessor.getFloat32(index*this.m_stride+4,true)};else console.error("out of vbo bound");if(attribute===gb.vbo.attribute.texcoord&&(this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv||this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba))if(index<this.m_allocated_size)return{x:this.m_data_accessor.getFloat32(index*this.m_stride+8,true),y:this.m_data_accessor.getFloat32(index*this.m_stride+12,true)};else console.error("out of vbo bound");if(attribute===
gb.vbo.attribute.color&&this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba)if(index<this.m_allocated_size)return{x:this.m_data_accessor.getFloat32(index*this.m_stride+16,true),y:this.m_data_accessor.getFloat32(index*this.m_stride+20,true),z:this.m_data_accessor.getFloat32(index*this.m_stride+24,true),w:this.m_data_accessor.getFloat32(index*this.m_stride+28,true)};else console.error("out of vbo bound");return null},submit:function(size){var data=this.m_data;if(size&&size>0&&
size<this.m_allocated_size){this.m_used_size=size;data=this.m_data.slice(0,size*this.m_stride)}gl.bindBuffer(gl.ARRAY_BUFFER,this.m_handler);gl.bufferData(gl.ARRAY_BUFFER,data,this.m_mode)},bind:function(attributes){if(this.m_used_size!==0){gl.bindBuffer(gl.ARRAY_BUFFER,this.m_handler);if(attributes[gb.shader.attribute_type.position]>=0){gl.vertexAttribPointer(attributes[gb.shader.attribute_type.position],2,gl.FLOAT,false,this.m_stride,0);gl.enableVertexAttribArray(attributes[gb.shader.attribute_type.position])}if(attributes[gb.shader.attribute_type.texcoord]>=
0&&(this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv||this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba)){gl.vertexAttribPointer(attributes[gb.shader.attribute_type.texcoord],2,gl.FLOAT,false,this.m_stride,4*2);gl.enableVertexAttribArray(attributes[gb.shader.attribute_type.texcoord])}if(attributes[gb.shader.attribute_type.color]>=0&&this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba){gl.vertexAttribPointer(attributes[gb.shader.attribute_type.color],
4,gl.FLOAT,false,this.m_stride,4*4);gl.enableVertexAttribArray(attributes[gb.shader.attribute_type.color])}}},unbind:function(attributes){if(this.m_used_size!==0){gl.bindBuffer(gl.ARRAY_BUFFER,this.m_handler);if(attributes[gb.shader.attribute_type.position]>=0)gl.disableVertexAttribArray(attributes[gb.shader.attribute_type.position]);if(attributes[gb.shader.attribute_type.texcoord]>=0&&(this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv||this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba))gl.disableVertexAttribArray(attributes[gb.shader.attribute_type.texcoord]);
if(attributes[gb.shader.attribute_type.color]>=0&&this.m_declaration===gb.vbo.declaration.position_xy_texcoord_uv_color_rgba)gl.disableVertexAttribArray(attributes[gb.shader.attribute_type.color]);gl.bindBuffer(gl.ARRAY_BUFFER,null)}},to_vertices_positions:function(){var vertices=[];for(var i=0;i<this.m_allocated_size;++i){var position=this.read_attribute(gb.vbo.attribute.position,i);vertices.push(new gb.vec2(position.x,position.y))}return vertices}}});oop.define_class({namespace:"gb",name:"mesh",init:function(vbo,ibo,mode){this.m_vbo=vbo;this.m_ibo=ibo;this.m_mode=mode;Object.defineProperty(this,"vbo",{get:function(){return this.m_vbo}});Object.defineProperty(this,"ibo",{get:function(){return this.m_ibo}})},release:function(){this.vbo.release();this.ibo.release()},methods:{bind:function(attributes){this.m_vbo.bind(attributes);this.m_ibo.bind()},unbind:function(attributes){this.m_vbo.unbind(attributes);this.m_ibo.unbind()},draw:function(){gl.drawElements(this.m_mode,
this.m_ibo.used_size,gl.UNSIGNED_SHORT,0)}}});oop.define_class({namespace:"gb",name:"builtin_shaders",init:function(){},release:function(){},methods:{},static_methods:{get_screen_quad_tex2d_shader:function(){var shader_screen_quad_tex2d_vert="varying vec2 v_texcoord;\nvoid main(void)\n{\nv_texcoord = a_texcoord;\ngl_Position = vec4(a_position, 0.0, 1.0);\n}";var shader_screen_quad_tex2d_frag="varying vec2 v_texcoord;\nuniform sampler2D  sampler_01;\nvoid main(void)\n{\ngl_FragColor = texture2D(sampler_01, v_texcoord);\n}";return gb.shader.construct("screen_quad_tex2d",
shader_screen_quad_tex2d_vert,shader_screen_quad_tex2d_frag)}}});oop.define_class({namespace:"gb",name:"resource_serializer",constants:{status:{undefined:0,in_progress:1,failure:2,success:3}},init:function(guid,resource){this.m_guid=guid;this.m_resource=resource;this.m_status=gb.resource_serializer.status.undefined;Object.defineProperty(this,"guid",{get:function(){return this.m_guid}});Object.defineProperty(this,"status",{get:function(){return this.m_status}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"shader_serializer_glsl",extend:gb.resource_serializer,init:function(filename,resource,vs_filename,fs_filename){this.m_vs_filename=vs_filename;this.m_fs_filename=fs_filename},release:function(){},methods:{serialize:function(data,callback){this.m_status=gb.resource_serializer.status.in_progress;var self=this;$.ajax({dataType:"text",url:this.m_vs_filename,data:{},async:true,success:function(value){data.vs_source_code=value;$.ajax({dataType:"text",url:self.m_fs_filename,
data:{},async:true,success:function(value){data.fs_source_code=value;self.m_resource.on_transfering_data_serialized(data);self.m_status=data.vs_source_code.length!==0&&data.fs_source_code.length!==0?gb.resource_serializer.status.success:gb.resource_serializer.status.failure;callback()}})}})}},static_methods:{}});oop.define_class({namespace:"gb",name:"texture_serializer_png",extend:gb.resource_serializer,init:function(filename){this.m_filename=filename},release:function(){},methods:{serialize:function(data,callback){this.m_status=gb.resource_serializer.status.in_progress;var self=this;var image=new Image;image.onload=function(){data.data=image;data.width=image.width;data.height=image.height;self.m_resource.on_transfering_data_serialized(data);self.m_status=gb.resource_serializer.status.success;callback()};
image.src=this.m_filename}},static_methods:{}});oop.define_class({namespace:"gb",name:"shader_compiler_glsl",constants:{vs_shader_header:"precision highp float;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nattribute vec4 a_color;\n",fs_shader_header:"precision highp float;\n"},init:function(){},release:function(){},methods:{compile:function(source_code,shader_type){var handler=gl.createShader(shader_type);if(!handler){console.error("can't create shader");return-1}var full_source_code=shader_type===gl.VERTEX_SHADER?(gb.shader_compiler_glsl.vs_shader_header+
source_code).trim():(gb.shader_compiler_glsl.fs_shader_header+source_code).trim();gl.shaderSource(handler,full_source_code);gl.compileShader(handler);var compile_message=gl.getShaderInfoLog(handler)||"";if(!gl.getShaderParameter(handler,gl.COMPILE_STATUS)){console.error(full_source_code);console.error(compile_message)}return handler},link:function(vs_handler,fs_handler){var shader_handler=gl.createProgram();gl.attachShader(shader_handler,vs_handler);gl.attachShader(shader_handler,fs_handler);gl.linkProgram(shader_handler);
var link_message=gl.getProgramInfoLog(shader_handler)||"";if(!gl.getProgramParameter(shader_handler,gl.LINK_STATUS)){console.error(link_message);gl.detachShader(shader_handler,vs_handler);gl.detachShader(shader_handler,fs_handler);gl.deleteShader(vs_handler);gl.deleteShader(fs_handler);shader_handler=-1}return shader_handler}},static_methods:{}});oop.define_class({namespace:"gb",name:"resource_commiter",constants:{status:{undefined:0,in_progress:1,failure:2,success:3}},init:function(guid,resource){this.m_guid=guid;this.m_resource=resource;this.m_status=gb.resource_commiter.status.undefined;Object.defineProperty(this,"guid",{get:function(){return this.m_guid}});Object.defineProperty(this,"status",{get:function(){return this.m_status}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"shader_commiter_glsl",extend:gb.resource_commiter,init:function(){},release:function(){},methods:{commit:function(data){this.m_status=gb.resource_commiter.status.in_progress;var shader_compiler=new gb.shader_compiler_glsl;var status=gb.resource_commiter.status.failure;var vs_handler=shader_compiler.compile(data.vs_source_code,gl.VERTEX_SHADER);if(vs_handler!==-1){var fs_handler=shader_compiler.compile(data.fs_source_code,gl.FRAGMENT_SHADER);if(fs_handler!==-1){var handler=
shader_compiler.link(vs_handler,fs_handler);data.handler=handler;if(handler!==-1)status=gb.resource_commiter.status.success}}this.m_resource.on_transfering_data_commited(data);this.m_status=status}},static_methods:{}});oop.define_class({namespace:"gb",name:"texture_commiter_png",extend:gb.resource_commiter,init:function(){},release:function(){},methods:{commit:function(data){this.m_status=gb.resource_commiter.status.in_progress;var handler=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,handler);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,data.data);data.handler=handler;this.m_resource.on_transfering_data_commited(data);this.m_status=gb.resource_commiter.status.success}},static_methods:{}});oop.define_class({namespace:"gb",name:"resource_loading_operation",constants:{status:{undefined:0,in_progress:1,waiting:2,failure:3,success:4}},init:function(guid,resource,data){this.m_guid=guid;this.m_resource=resource;this.m_status=gb.resource_loading_operation.status.undefined;this.m_transfering_data=null;this.m_serializer=null;this.m_commiter=null;this.m_serialized_data=data;Object.defineProperty(this,"guid",{get:function(){return this.m_guid}});Object.defineProperty(this,"status",{get:function(){return this.m_status}})},
release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"shader_loading_operation",extend:gb.resource_loading_operation,constants:{vs_extension:".vert",fs_extension:".frag"},init:function(){this.m_transfering_data=new gb.shader_transfering_data},release:function(){},methods:{start:function(callback){var self=this;this.serialize(function(){if(self.m_status===gb.resource_loading_operation.status.waiting)self.commit(function(){callback()});else callback()})},serialize:function(callback){this.m_status=gb.resource_loading_operation.status.in_progress;
this.m_serializer=new gb.shader_serializer_glsl(this.m_guid,this.m_resource,this.m_guid+gb.shader_loading_operation.vs_extension,this.m_guid+gb.shader_loading_operation.fs_extension);var self=this;this.m_serializer.serialize(this.m_transfering_data,function(){self.m_status=self.m_serializer.status===gb.resource_serializer.status.success?gb.resource_loading_operation.status.waiting:gb.resource_loading_operation.status.failure;callback()})},commit:function(callback){this.m_status=gb.resource_loading_operation.status.in_progress;
this.m_commiter=new gb.shader_commiter_glsl(this.m_guid,this.m_resource);this.m_commiter.commit(this.m_transfering_data);this.m_status=this.m_commiter.status===gb.resource_commiter.status.success?gb.resource_loading_operation.status.success:gb.resource_loading_operation.status.failure;callback()}},static_methods:{}});oop.define_class({namespace:"gb",name:"texture_loading_operation",extend:gb.resource_loading_operation,init:function(){this.m_transfering_data=new gb.texture_transfering_data},release:function(){},methods:{start:function(callback){var self=this;this.serialize(function(){if(self.m_status===gb.resource_loading_operation.status.waiting)self.commit(function(){callback()});else callback()})},serialize:function(callback){if(!this.m_serialized_data){this.m_status=gb.resource_loading_operation.status.in_progress;
this.m_serializer=new gb.texture_serializer_png(this.m_guid,this.m_resource);var self=this;this.m_serializer.serialize(this.m_transfering_data,function(){self.m_status=self.m_serializer.status===gb.resource_serializer.status.success?gb.resource_loading_operation.status.waiting:gb.resource_loading_operation.status.failure;callback()})}else{this.m_status=gb.resource_loading_operation.status.waiting;this.m_transfering_data.data=this.m_serialized_data;this.m_transfering_data.width=this.m_serialized_data.width;
this.m_transfering_data.height=this.m_serialized_data.height;this.m_resource.on_transfering_data_serialized(this.m_transfering_data);callback()}},commit:function(callback){this.m_status=gb.resource_loading_operation.status.in_progress;this.m_commiter=new gb.texture_commiter_png(this.m_guid,this.m_resource);this.m_commiter.commit(this.m_transfering_data);this.m_status=this.m_commiter.status===gb.resource_commiter.status.success?gb.resource_loading_operation.status.success:gb.resource_loading_operation.status.failure;
callback()}},static_methods:{}});oop.define_class({namespace:"gb",name:"resource_accessor",init:function(){this.m_resources=[];this.m_operations_queue=[]},release:function(){},methods:{add_custom_resource:function(guid,resource){this.m_resources[guid]=resource},get_shader:function(filename){var resource=this.m_resources[filename];if(typeof resource==="undefined"){resource=new gb.shader(filename);this.m_resources[filename]=resource;var operation=new gb.shader_loading_operation(filename,resource);this.m_operations_queue[filename]=
operation;var self=this;operation.start(function(){self.m_resources[filename].on_resource_loaded(self.m_operations_queue[filename].status===gb.resource_loading_operation.status.success);self.m_operations_queue[filename]=null})}return resource},get_texture:function(filename,data){var resource=data?null:this.m_resources[filename];if(!resource){resource=new gb.texture(filename);this.m_resources[filename]=resource;var operation=new gb.texture_loading_operation(filename,resource,data);this.m_operations_queue[filename]=
operation;var self=this;operation.start(function(){self.m_resources[filename].on_resource_loaded(self.m_operations_queue[filename].status===gb.resource_loading_operation.status.success);self.m_operations_queue[filename]=null})}return resource}},static_methods:{}});var g_string_to_glenum=null;
oop.define_class({namespace:"gb",name:"configuration_base",init:function(){this.m_configurations=[]},release:function(){},methods:{set_configuration:function(name,value,index){if(this.m_configurations[name]instanceof Object)if(arguments.length===3)if(index>=0&&index<this.m_configurations[name].length)this.m_configurations[name][index]=value;else this.m_configurations[name].push(value);else this.m_configurations[name].push(value);else{this.m_configurations[name]=[];this.m_configurations[name].push(value)}return this}},static_methods:{string_to_glenum:function(){if(!g_string_to_glenum)g_string_to_glenum=
{GL_FRONT:gl.FRONT,GL_BACK:gl.BACK,GL_SRC_COLOR:gl.SRC_ALPHA,GL_SRC_ALPHA:gl.SRC_ALPHA,GL_ONE:gl.ONE,GL_ZERO:gl.ZERO,GL_ONE_MINUS_SRC_COLOR:gl.ONE_MINUS_SRC_COLOR,GL_ONE_MINUS_DST_COLOR:gl.ONE_MINUS_DST_COLOR,GL_ONE_MINUS_SRC_ALPHA:gl.ONE_MINUS_SRC_ALPHA,GL_ONE_MINUS_DST_ALPHA:gl.ONE_MINUS_DST_ALPHA,GL_DST_ALPHA:gl.DST_ALPHA,GL_CONSTANT_ALPHA:gl.CONSTANT_ALPHA,GL_REPEAT:gl.REPEAT,GL_CLAMP_TO_EDGE:gl.CLAMP_TO_EDGE,GL_MIRRORED_REPEAT:gl.MIRRORED_REPEAT,GL_NEAREST:gl.NEAREST,GL_LINEAR:gl.LINEAR,GL_MIPMAP:gl.LINEAR_MIPMAP_NEAREST,
GL_ALWAYS:gl.ALWAYS,GL_EQUAL:gl.EQUAL,GL_NOTEQUAL:gl.NOTEQUAL,GL_FUNC_ADD:gl.FUNC_ADD};return g_string_to_glenum}}});oop.define_class({namespace:"gb",name:"game_object_configuration",extend:gb.configuration_base,init:function(){Object.defineProperty(this,"materials_configurations",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.materials_configurations instanceof Object)return this.m_configurations.materials_configurations;return null}})},release:function(){},methods:{}});oop.define_class({namespace:"gb",name:"texture_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"filename",{get:function(){return this.json.filename}});Object.defineProperty(this,"technique_name",{get:function(){return this.json.technique_name}});Object.defineProperty(this,"sampler_index",{get:function(){return this.json.sampler_index}});Object.defineProperty(this,"wrap_mode",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.wrap_mode]}});
Object.defineProperty(this,"mag_filter",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.mag_filter]}});Object.defineProperty(this,"min_filter",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.min_filter]}})},release:function(){},methods:{serialize:function(value){this.json=value}}});oop.define_class({namespace:"gb",name:"shader_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"filename",{get:function(){return this.json.filename}})},release:function(){},methods:{serialize:function(value){this.json=value}}});oop.define_class({namespace:"gb",name:"material_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"technique_name",{get:function(){return this.json.technique_name}});Object.defineProperty(this,"technique_pass",{get:function(){return this.json.technique_pass}});Object.defineProperty(this,"is_depth_test",{get:function(){return Boolean(this.json.is_depth_test)}});Object.defineProperty(this,"is_depth_mask",{get:function(){return Boolean(this.json.is_depth_mask)}});
Object.defineProperty(this,"is_cull_face",{get:function(){return Boolean(this.json.is_cull_face)}});Object.defineProperty(this,"cull_face_mode",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.cull_face_mode]}});Object.defineProperty(this,"is_blending",{get:function(){return Boolean(this.json.is_blending)}});Object.defineProperty(this,"blending_function_source",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.blending_function_source]}});Object.defineProperty(this,
"blending_function_destination",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.blending_function_destination]}});Object.defineProperty(this,"blending_equation",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.blending_equation]}});Object.defineProperty(this,"is_stencil_test",{get:function(){return Boolean(this.json.is_stencil_test)}});Object.defineProperty(this,"stencil_function",{get:function(){return gb.configuration_base.string_to_glenum()[this.json.stencil_function]}});
Object.defineProperty(this,"stencil_function_parameter_1",{get:function(){return this.json.stencil_function_parameter_1}});Object.defineProperty(this,"stencil_function_parameter_2",{get:function(){return this.json.stencil_function_parameter_2}});Object.defineProperty(this,"stencil_mask_parameter",{get:function(){return this.json.stencil_mask_parameter}});Object.defineProperty(this,"shader_configuration",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.shader instanceof
Object)if(this.m_configurations.shader.length>0)return this.m_configurations.shader[0];return null}});Object.defineProperty(this,"textures_configurations",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.textures instanceof Object)return this.m_configurations.textures;return null}})},release:function(){},methods:{serialize:function(filename,callback){var self=this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+
filename);var configuration=new gb.shader_configuration;configuration.serialize(self.json.shader);self.set_configuration("shader",configuration);for(var i=0;i<self.json.textures.length;++i){configuration=new gb.texture_configuration;configuration.serialize(self.json.textures[i]);self.set_configuration("textures",configuration)}callback(self)}).fail(function(){console.log("can't load: "+filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"sprite_configuration",extend:gb.game_object_configuration,init:function(){},release:function(){},methods:{serialize:function(filename,callback){var self=this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+filename);var configurations_count=self.json.materials.length;if(configurations_count>0){var waiting_configurations_count=configurations_count;var add_material_configuration=function(configuration){self.set_configuration("materials_configurations",
configuration);waiting_configurations_count--;if(waiting_configurations_count===0)callback(self)};for(var i=0;i<configurations_count;++i){var configuration=new gb.material_configuration;configuration.serialize(self.json.materials[i].filename,add_material_configuration)}}else callback(self)}).fail(function(){console.log("can't load: "+filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"ws_technique_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"technique_name",{get:function(){return this.json.technique_name}});Object.defineProperty(this,"num_passes",{get:function(){return this.json.num_passes}});Object.defineProperty(this,"index",{get:function(){return this.json.index}});Object.defineProperty(this,"screen_width",{get:function(){return this.json.screen_width}});Object.defineProperty(this,
"screen_height",{get:function(){return this.json.screen_height}});Object.defineProperty(this,"clear_color_r",{get:function(){return this.json.clear_color_r}});Object.defineProperty(this,"clear_color_g",{get:function(){return this.json.clear_color_g}});Object.defineProperty(this,"clear_color_b",{get:function(){return this.json.clear_color_b}});Object.defineProperty(this,"clear_color_a",{get:function(){return this.json.clear_color_a}})},release:function(){},methods:{serialize:function(filename,callback){var self=
this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+filename);callback(self)}).fail(function(){console.log("can't load: "+filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"ss_technique_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"material_configuration",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.material_configuration instanceof Object)if(this.m_configurations.material_configuration.length>0)return this.m_configurations.material_configuration[0];return null}});Object.defineProperty(this,"technique_name",{get:function(){return this.json.technique_name}});
Object.defineProperty(this,"screen_width",{get:function(){return this.json.screen_width}});Object.defineProperty(this,"screen_height",{get:function(){return this.json.screen_height}})},release:function(){},methods:{serialize_material_configuration:function(callback){var self=this;var configuration=new gb.material_configuration;configuration.serialize(self.json.material_filename,function(configuration){self.set_configuration("material_configuration",configuration);callback()})},serialize:function(filename,
callback){var self=this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+filename);self.serialize_material_configuration(function(){callback(self)})}).fail(function(){console.log("can't load: "+filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"main_technique_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"material_configuration",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.material_configuration instanceof Object)if(this.m_configurations.material_configuration.length>0)return this.m_configurations.material_configuration[0];return null}});Object.defineProperty(this,"technique_name",{get:function(){return this.json.technique_name}})},
release:function(){},methods:{serialize_material_configuration:function(callback){var self=this;var configuration=new gb.material_configuration;configuration.serialize(self.json.material_filename,function(configuration){self.set_configuration("material_configuration",configuration);callback()})},serialize:function(filename,callback){var self=this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+filename);self.serialize_material_configuration(function(){callback(self)})}).fail(function(){console.log("can't load: "+
filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"transition_configuration",extend:gb.configuration_base,init:function(){this.json=null;Object.defineProperty(this,"guid",{get:function(){return this.json.guid}});Object.defineProperty(this,"main_technique_configuration",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.main_technique_configuration instanceof Object)if(this.m_configurations.main_technique_configuration.length>0)return this.m_configurations.main_technique_configuration[0];
return null}});Object.defineProperty(this,"ws_techniques_configurations",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.ws_techniques_configurations instanceof Object)return this.m_configurations.ws_techniques_configurations;return null}});Object.defineProperty(this,"ss_techniques_configurations",{get:function(){if(this.m_configurations instanceof Object)if(this.m_configurations.ss_techniques_configurations instanceof Object)return this.m_configurations.ss_techniques_configurations;
return null}})},release:function(){},methods:{serialize_main_technique_configuration:function(callback){var self=this;var configuration=new gb.main_technique_configuration;configuration.serialize(self.json.main_technique_filename,function(configuration){self.set_configuration("main_technique_configuration",configuration);callback()})},serialize_ws_techniques_configurations:function(callback){var self=this;var configurations_count=self.json.ws_techniques.length;if(configurations_count>0){var waiting_configurations_count=
configurations_count;var add_ws_technique_configuration=function(configuration){self.set_configuration("ws_techniques_configurations",configuration);waiting_configurations_count--;if(waiting_configurations_count===0)callback()};for(var i=0;i<configurations_count;++i){var configuration=new gb.ws_technique_configuration;configuration.serialize(self.json.ws_techniques[i].filename,add_ws_technique_configuration)}}else callback()},serialize_ss_techniques_configurations:function(callback){var self=this;
var configurations_count=self.json.ss_techniques.length;if(configurations_count>0){var waiting_configurations_count=configurations_count;var add_ss_technique_configuration=function(configuration){self.set_configuration("ss_techniques_configurations",configuration);waiting_configurations_count--;if(waiting_configurations_count===0)callback()};for(var i=0;i<configurations_count;++i){var configuration=new gb.ss_technique_configuration;configuration.serialize(self.json.ss_techniques[i].filename,add_ss_technique_configuration)}}else callback()},
serialize:function(filename,callback){var self=this;$.ajax({dataType:"json",url:filename,data:{},async:true}).done(function(value){self.json=value;console.log("loaded: "+filename);self.serialize_main_technique_configuration(function(){self.serialize_ws_techniques_configurations(function(){self.serialize_ss_techniques_configurations(function(){callback(self)})})})}).fail(function(){console.log("can't load: "+filename);callback(null)})}}});oop.define_class({namespace:"gb",name:"configuration_accessor",init:function(){},release:function(){},methods:{get_transition_configuration:function(filename,callback){var configuration=new gb.transition_configuration;configuration.serialize(filename,function(configuration){callback(configuration)})},get_sprite_configuration:function(filename,callback){var configuration=new gb.sprite_configuration;configuration.serialize(filename,function(configuration){callback(configuration)})}},static_methods:{}});oop.define_class({namespace:"gb",name:"mesh_constructor",init:function(){},release:function(){},methods:{},static_methods:{create_screen_quad:function(){var vbo=new gb.vbo(4,gl.STATIC_DRAW,gb.vbo.declaration.position_xy_texcoord_uv);vbo.write_attribute(gb.vbo.attribute.position,0,new gb.vec2(-1,-1));vbo.write_attribute(gb.vbo.attribute.position,1,new gb.vec2(-1,1));vbo.write_attribute(gb.vbo.attribute.position,2,new gb.vec2(1,-1));vbo.write_attribute(gb.vbo.attribute.position,3,new gb.vec2(1,1));
vbo.write_attribute(gb.vbo.attribute.texcoord,0,new gb.vec2(0,0));vbo.write_attribute(gb.vbo.attribute.texcoord,1,new gb.vec2(0,1));vbo.write_attribute(gb.vbo.attribute.texcoord,2,new gb.vec2(1,0));vbo.write_attribute(gb.vbo.attribute.texcoord,3,new gb.vec2(1,1));vbo.submit();var ibo=new gb.ibo(6,gl.STATIC_DRAW);ibo.write_element(0,0);ibo.write_element(1,2);ibo.write_element(2,1);ibo.write_element(3,1);ibo.write_element(4,2);ibo.write_element(5,3);ibo.submit();return new gb.mesh(vbo,ibo,gl.TRIANGLES)},
create_shape_quad:function(){var vbo=new gb.vbo(4,gl.STATIC_DRAW,gb.vbo.declaration.position_xy_texcoord_uv);vbo.write_attribute(gb.vbo.attribute.position,0,new gb.vec2(-.5,-.5));vbo.write_attribute(gb.vbo.attribute.position,1,new gb.vec2(-.5,.5));vbo.write_attribute(gb.vbo.attribute.position,2,new gb.vec2(.5,-.5));vbo.write_attribute(gb.vbo.attribute.position,3,new gb.vec2(.5,.5));vbo.write_attribute(gb.vbo.attribute.texcoord,0,new gb.vec2(0,0));vbo.write_attribute(gb.vbo.attribute.texcoord,1,new gb.vec2(0,
1));vbo.write_attribute(gb.vbo.attribute.texcoord,2,new gb.vec2(1,0));vbo.write_attribute(gb.vbo.attribute.texcoord,3,new gb.vec2(1,1));vbo.submit();var ibo=new gb.ibo(6,gl.STATIC_DRAW);ibo.write_element(0,0);ibo.write_element(1,2);ibo.write_element(2,1);ibo.write_element(3,1);ibo.write_element(4,2);ibo.write_element(5,3);ibo.submit();return new gb.mesh(vbo,ibo,gl.TRIANGLES)},create_circle:function(){var num_subdivisions=32;var radius=1;var num_vertices=num_subdivisions+1;var vbo=new gb.vbo(num_vertices,
gl.STATIC_DRAW,gb.vbo.declaration.position_xy);var index=1;var vertex_position=new gb.vec2;vbo.write_attribute(gb.vbo.attribute.position,0,vertex_position);for(var angle=0;angle<=Math.PI*2;angle+=Math.PI*2/num_subdivisions){vertex_position.x=radius*Math.cos(angle);vertex_position.y=radius*Math.sin(angle);vbo.write_attribute(gb.vbo.attribute.position,index,vertex_position);index++}vbo.submit();index=1;var num_indices=(num_subdivisions+1)*3;var ibo=new gb.ibo(num_indices,gl.STATIC_DRAW);for(var i=0;i<
num_subdivisions*3;i+=3){ibo.write_element(i+0,0);ibo.write_element(i+1,Math.min(index++,num_vertices-1));ibo.write_element(i+2,Math.min(index,num_vertices-1))}ibo.write_element(num_indices-3,0);ibo.write_element(num_indices-2,Math.min(index-1,num_vertices-1));ibo.write_element(num_indices-1,1);ibo.submit();return new gb.mesh(vbo,ibo,gl.TRIANGLES)},create_grid:function(num_rows,num_columns,rows_gap,columns_gap){var num_vertices=(num_rows+1)*(num_columns+1)*4;var num_indices=(num_rows+1)*(num_columns+
1)*4;var vbo=new gb.vbo(num_vertices,gl.STATIC_DRAW,gb.vbo.declaration.position_xy);var index=0;var vertex_position=new gb.vec2;for(var i=0;i<=num_rows;++i){vertex_position.x=i*rows_gap;vertex_position.y=0;if(i===num_columns)vertex_position.x-=1;if(i===0)vertex_position.x+=1;vbo.write_attribute(gb.vbo.attribute.position,index,vertex_position);index++;vertex_position.x=i*rows_gap;if(i===num_columns)vertex_position.x-=1;if(i===0)vertex_position.x+=1;vertex_position.y=num_columns*columns_gap;vbo.write_attribute(gb.vbo.attribute.position,
index,vertex_position);index++}for(var i=0;i<=num_columns;++i){vertex_position.x=0;vertex_position.y=i*columns_gap;if(i===num_columns)vertex_position.y-=1;if(i===0)vertex_position.y+=1;vbo.write_attribute(gb.vbo.attribute.position,index,vertex_position);index++;vertex_position.x=num_columns*rows_gap;vertex_position.y=i*columns_gap;if(i===num_columns)vertex_position.y-=1;if(i===0)vertex_position.y+=1;vbo.write_attribute(gb.vbo.attribute.position,index,vertex_position);index++}vbo.submit();var ibo=
new gb.ibo(num_indices*4,gl.STATIC_DRAW);for(var i=0;i<num_indices;++i)ibo.write_element(i,i);ibo.submit();return new gb.mesh(vbo,ibo,gl.LINES)}}});var g_cached_parameters=null;
oop.define_class({namespace:"gb",name:"material_cached_parameters",init:function(){this.m_is_cull_face=false;this.m_cull_face_mode=gl.FRONT;this.m_is_blending=false;this.m_blending_function_source=gl.SRC_ALPHA;this.m_blending_function_destination=gl.ONE_MINUS_SRC_ALPHA;this.m_blending_equation=gl.FUNC_ADD;this.m_is_stencil_test=false;this.m_stencil_function=gl.ALWAYS;this.m_stencil_function_parameter_1=-1;this.m_stencil_function_parameter_2=-1;this.m_stencil_mask_parameter=-1;this.m_is_depth_test=
false;this.m_is_depth_mask=false;this.m_shader=null;this.m_textures=[];for(var i=0;i<8;++i)this.m_textures[i]=null;Object.defineProperty(this,"is_cull_face",{get:function(){return this.m_is_cull_face},set:function(value){this.m_is_cull_face=value}});Object.defineProperty(this,"cull_face_mode",{get:function(){return this.m_cull_face_mode},set:function(value){this.m_cull_face_mode=value}});Object.defineProperty(this,"is_blending",{get:function(){return this.m_is_blending},set:function(value){this.m_is_blending=
value}});Object.defineProperty(this,"blending_function_source",{get:function(){return this.m_blending_function_source},set:function(value){this.m_blending_function_source=value}});Object.defineProperty(this,"blending_function_destination",{get:function(){return this.m_blending_function_destination},set:function(value){this.m_blending_function_destination=value}});Object.defineProperty(this,"blending_equation",{get:function(){return this.m_blending_equation},set:function(value){this.m_blending_equation=
value}});Object.defineProperty(this,"is_stencil_test",{get:function(){return this.m_is_stencil_test},set:function(value){this.m_is_stencil_test=value}});Object.defineProperty(this,"stencil_function",{get:function(){return this.m_stencil_function},set:function(value){this.m_stencil_function=value}});Object.defineProperty(this,"stencil_function_parameter_1",{get:function(){return this.m_stencil_function_parameter_1},set:function(value){this.m_stencil_function_parameter_1=value}});Object.defineProperty(this,
"stencil_function_parameter_2",{get:function(){return this.m_stencil_function_parameter_2},set:function(value){this.m_stencil_function_parameter_2=value}});Object.defineProperty(this,"stencil_mask_parameter",{get:function(){return this.m_stencil_mask_parameter},set:function(value){this.m_stencil_mask_parameter=value}});Object.defineProperty(this,"is_depth_test",{get:function(){return this.m_is_depth_test},set:function(value){this.m_is_depth_test=value}});Object.defineProperty(this,"is_depth_mask",
{get:function(){return this.m_is_depth_mask},set:function(value){this.m_is_depth_mask=value}});Object.defineProperty(this,"shader",{get:function(){return this.m_shader},set:function(value){this.m_shader=value}});Object.defineProperty(this,"textures",{get:function(){return this.m_textures},set:function(value){this.m_textures=value}})},release:function(){},methods:{},static_methods:{get_cached_parameters:function(){if(g_cached_parameters===null){g_cached_parameters=new gb.material_cached_parameters;
g_cached_parameters.is_cull_face=true;gl.enable(gl.CULL_FACE);g_cached_parameters.cull_face_mode=gl.BACK;gl.cullFace(gl.BACK);g_cached_parameters.is_blending=true;gl.enable(gl.BLEND);g_cached_parameters.blending_function_source=gl.SRC_ALPHA;g_cached_parameters.blending_function_destination=gl.ONE_MINUS_SRC_ALPHA;gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);g_cached_parameters.is_stencil_test=false;gl.disable(gl.STENCIL_TEST);g_cached_parameters.stencil_function=gl.ALWAYS;g_cached_parameters.stencil_function_parameter_1=
0;g_cached_parameters.stencil_function_parameter_2=0;gl.stencilFunc(gl.ALWAYS,0,0);g_cached_parameters.m_stencil_mask_parameter=0;gl.stencilMask(0);g_cached_parameters.is_depth_test=true;gl.enable(gl.DEPTH_TEST);g_cached_parameters.is_depth_mask=true;gl.depthMask(true)}return g_cached_parameters}}});
oop.define_class({namespace:"gb",name:"material",init:function(){this.m_parameters=new gb.material_cached_parameters;this.m_custom_shader_uniforms=[];this.m_guid="";Object.defineProperty(this,"is_cull_face",{get:function(){return this.m_parameters.is_cull_face},set:function(value){this.m_parameters.is_culling=value}});Object.defineProperty(this,"cull_face_mode",{get:function(){return this.m_parameters.cull_face_mode},set:function(value){this.m_parameters.cull_face_mode=value}});Object.defineProperty(this,
"is_blending",{get:function(){return this.m_parameters.is_blending},set:function(value){this.m_parameters.is_blending=value}});Object.defineProperty(this,"blending_function_source",{get:function(){return this.m_parameters.blending_function_source},set:function(value){this.m_parameters.blending_function_source=value}});Object.defineProperty(this,"blending_function_destination",{get:function(){return this.m_parameters.blending_function_destination},set:function(value){this.m_parameters.blending_function_destination=
value}});Object.defineProperty(this,"blending_equation",{get:function(){return this.m_parameters.blending_equation},set:function(value){this.m_parameters.blending_equation=value}});Object.defineProperty(this,"is_stencil_test",{get:function(){return this.m_parameters.is_stencil_test},set:function(value){this.m_parameters.is_stencil_test=value}});Object.defineProperty(this,"stencil_function",{get:function(){return this.m_parameters.stencil_function},set:function(value){this.m_parameters.stencil_function=
value}});Object.defineProperty(this,"stencil_function_parameter_1",{get:function(){return this.m_parameters.stencil_function_parameter_1},set:function(value){this.m_parameters.stencil_function_parameter_1=value}});Object.defineProperty(this,"stencil_function_parameter_2",{get:function(){return this.m_parameters.stencil_function_parameter_2},set:function(value){this.m_parameters.stencil_function_parameter_2=value}});Object.defineProperty(this,"stencil_mask_parameter",{get:function(){return this.m_parameters.stencil_mask_parameter},
set:function(value){this.m_parameters.stencil_mask_parameter=value}});Object.defineProperty(this,"is_depth_test",{get:function(){return this.m_parameters.is_depth_test},set:function(value){this.m_parameters.is_depth_test=value}});Object.defineProperty(this,"is_depth_mask",{get:function(){return this.m_parameters.is_depth_mask},set:function(value){this.m_parameters.is_depth_mask=value}});Object.defineProperty(this,"shader",{get:function(){return this.m_parameters.shader},set:function(value){this.m_parameters.shader=
value}});Object.defineProperty(this,"guid",{get:function(){return this.m_guid},set:function(value){this.m_guid=value}})},release:function(){},methods:{set_texture:function(texture,sampler){this.m_parameters.textures[sampler]=texture},get_texture_sampler:function(guid){var sampler=-1;for(var i=0;i<8;++i)if(this.m_parameters.textures[i]!==null&&this.m_parameters.textures[i].guid===guid){sampler=i;break}return sampler},get_texture:function(sampler){return this.m_parameters.textures[sampler]},set_custom_shader_uniform:function(value,
uniform){var current_uniform=null;if(typeof this.m_custom_shader_uniforms[uniform]!=="undefined")current_uniform=this.m_custom_shader_uniforms[uniform];else{current_uniform=new gb.shader_uniform;this.m_custom_shader_uniforms[uniform]=current_uniform}if(value instanceof gb.mat4){current_uniform.mat4_value=value;current_uniform.type=gb.shader_uniform.type.mat4}else if(value instanceof gb.vec4){current_uniform.vec4_value=value;current_uniform.type=gb.shader_uniform.type.vec4}else if(value instanceof
gb.vec3){current_uniform.vec3_value=value;current_uniform.type=gb.shader_uniform.type.vec3}else if(value instanceof gb.vec2){current_uniform.vec2_value=value;current_uniform.type=gb.shader_uniform.type.vec2}else if(typeof value==="number")if(gb.math.is_int(value)){current_uniform.i32_value=value;current_uniform.type=gb.shader_uniform.type.i32}else{current_uniform.f32_value=value;current_uniform.type=gb.shader_uniform.type.f32}else console.log("unknown shader uniform type: ",typeof value)},bind_custom_shader_uniforms:function(){for(var key in this.m_custom_shader_uniforms){var current_uniform=
this.m_custom_shader_uniforms[key];switch(current_uniform.type){case gb.shader_uniform.type.mat4:this.m_parameters.shader.set_custom_mat4(current_uniform.mat4_value,key);break;case gb.shader_uniform.type.vec4:this.m_parameters.shader.set_custom_vec4(current_uniform.vec4_value,key);break;case gb.shader_uniform.type.vec3:this.m_parameters.shader.set_custom_vec3(current_uniform.vec3_value,key);break;case gb.shader_uniform.type.vec2:this.m_parameters.shader.set_custom_vec2(current_uniform.vec2_value,
key);break;case gb.shader_uniform.type.f32:this.m_parameters.shader.set_custom_f32(current_uniform.f32_value,key);break;case gb.shader_uniform.type.i32:this.m_parameters.shader.set_custom_i32(current_uniform.i32_value,key);break}}},bind:function(){this.m_parameters.shader.bind();for(var i=0;i<8;++i)if(this.m_parameters.textures[i]!==null)this.m_parameters.shader.set_texture(this.m_parameters.textures[i],i);if(this.m_parameters.is_depth_test&&this.m_parameters.is_depth_test!==gb.material_cached_parameters.get_cached_parameters.is_depth_test){gl.enable(gl.DEPTH_TEST);
gb.material_cached_parameters.get_cached_parameters.is_depth_test=this.m_parameters.is_depth_test}else if(this.m_parameters.is_depth_test!==gb.material_cached_parameters.get_cached_parameters.is_depth_test){gl.disable(gl.DEPTH_TEST);gb.material_cached_parameters.get_cached_parameters.is_depth_test=this.m_parameters.is_depth_test}if(this.m_parameters.is_depth_mask&&this.m_parameters.is_depth_mask!==gb.material_cached_parameters.get_cached_parameters.is_depth_mask){gl.depthMask(true);gb.material_cached_parameters.get_cached_parameters.is_depth_mask=
this.m_parameters.is_depth_mask}else if(this.m_parameters.is_depth_mask!==gb.material_cached_parameters.get_cached_parameters.is_depth_mask){gl.depthMask(false);gb.material_cached_parameters.get_cached_parameters.is_depth_mask=this.m_parameters.is_depth_mask}if(this.m_parameters.is_cull_face&&this.m_parameters.is_cull_face!==gb.material_cached_parameters.get_cached_parameters.is_cull_face){gl.enable(gl.CULL_FACE);gb.material_cached_parameters.get_cached_parameters.is_cull_face=this.m_parameters.is_cull_face}else if(this.m_parameters.is_cull_face!==
gb.material_cached_parameters.get_cached_parameters.is_cull_face){gl.disable(gl.CULL_FACE);gb.material_cached_parameters.get_cached_parameters.is_cull_face=this.m_parameters.is_cull_face}if(this.m_parameters.cull_face_mode&&this.m_parameters.cull_face_mode!==gb.material_cached_parameters.get_cached_parameters.cull_face_mode){gl.cullFace(this.m_parameters.cull_face_mode);gb.material_cached_parameters.get_cached_parameters.cull_face_mode=this.m_parameters.cull_face_mode}else if(this.m_parameters.cull_face_mode!==
gb.material_cached_parameters.get_cached_parameters.cull_face_mode){gl.cullFace(this.m_parameters.cull_face_mode);gb.material_cached_parameters.get_cached_parameters.cull_face_mode=this.m_parameters.cull_face_mode}if(this.m_parameters.is_blending&&this.m_parameters.is_blending!==gb.material_cached_parameters.get_cached_parameters.is_blending){gl.enable(gl.BLEND);gb.material_cached_parameters.get_cached_parameters.is_blending=this.m_parameters.is_blending}else if(this.m_parameters.is_blending!==gb.material_cached_parameters.get_cached_parameters.is_blending){gl.disable(gl.BLEND);
gb.material_cached_parameters.get_cached_parameters.is_blending=this.m_parameters.is_blending}if(this.m_parameters.blending_function_source!==gb.material_cached_parameters.get_cached_parameters.blending_function_source||this.m_parameters.blending_function_destination!==gb.material_cached_parameters.get_cached_parameters.blending_function_destination){gl.blendFunc(this.m_parameters.blending_function_source,this.m_parameters.blending_function_destination);gb.material_cached_parameters.get_cached_parameters.blending_function_source=
this.m_parameters.blending_function_source;gb.material_cached_parameters.get_cached_parameters.blending_function_destination=this.m_parameters.blending_function_destination}if(this.m_parameters.blending_equation!==gb.material_cached_parameters.get_cached_parameters.blending_equation){gl.blendEquation(this.m_parameters.blending_equation);gb.material_cached_parameters.get_cached_parameters.blending_equation=this.m_parameters.blending_equation}if(this.m_parameters.is_stencil_test&&this.m_parameters.is_stencil_test!==
gb.material_cached_parameters.get_cached_parameters.is_stencil_test){gl.enable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters.is_stencil_test=this.m_parameters.is_stencil_test}else if(this.m_parameters.is_stencil_test!==gb.material_cached_parameters.get_cached_parameters.is_stencil_test){gl.disable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters.is_stencil_test=this.m_parameters.is_stencil_test}if(this.m_parameters.stencil_function!==gb.material_cached_parameters.get_cached_parameters.stencil_function||
this.m_parameters.stencil_function_parameter_1!==gb.material_cached_parameters.get_cached_parameters.stencil_function_parameter_1||this.m_parameters.stencil_function_parameter_2!==gb.material_cached_parameters.get_cached_parameters.stencil_function_parameter_2){gl.stencilFunc(this.m_parameters.stencil_function,this.m_parameters.stencil_function_parameter_1,this.m_parameters.stencil_function_parameter_2);gb.material_cached_parameters.get_cached_parameters.stencil_function=this.m_parameters.stencil_function;
gb.material_cached_parameters.get_cached_parameters.stencil_function_parameter_1=this.m_parameters.stencil_function_parameter_1;gb.material_cached_parameters.get_cached_parameters.stencil_function_parameter_2=this.m_parameters.stencil_function_parameter_2}if(this.m_parameters.stencil_mask_parameter!==gb.material_cached_parameters.get_cached_parameters.stencil_mask_parameter){gl.stencilMask(this.m_parameters.stencil_mask_parameter);gb.material_cached_parameters.get_cached_parameters.stencil_mask_parameter=
this.m_parameters.stencil_mask_parameter}this.bind_custom_shader_uniforms()},unbind:function(){this.m_parameters.shader.unbind()}},static_methods:{construct:function(configuration){var material=new gb.material;material.is_cull_face=configuration.is_cull_face;material.cull_face_mode=configuration.cull_face_mode;material.is_blending=configuration.is_blending;material.blending_function_source=configuration.blending_function_source;material.blending_function_destination=configuration.blending_function_destination;
material.blending_equation=configuration.blending_equation;material.is_stencil_test=configuration.is_stencil_test;material.stencil_function=configuration.stencil_function;material.stencil_function_parameter_1=configuration.stencil_function_parameter_1;material.stencil_function_parameter_2=configuration.stencil_function_parameter_2;material.stencil_mask_parameter=configuration.stencil_mask_parameter;material.guid=""+configuration.technique_name+configuration.technique_pass+configuration.shader_configuration.filename;
return material},set_shader:function(material,configuration,resource_accessor){var shader=resource_accessor.get_shader(configuration.shader_configuration.filename);shader.add_resource_loading_callback(function(resource){material.shader=resource})},set_textures:function(material,configuration,resource_accessor){var textures_count=configuration.textures_configurations?configuration.textures_configurations.length:0;if(textures_count){var on_texture_loaded_callback=function(resource,userdata){resource.wrap_mode=
userdata.wrap_mode;resource.mag_filter=userdata.mag_filter;resource.min_filter=userdata.min_filter;material.set_texture(resource,userdata.sampler_index)};for(var i=0;i<textures_count;++i){var texture_configuration=configuration.textures_configurations[i];var texture_name=texture_configuration.filename.length!==0?texture_configuration.filename:texture_configuration.technique_name;var texture=resource_accessor.get_texture(texture_name);texture.add_resource_loading_callback(on_texture_loaded_callback,
texture_configuration)}}}}});oop.define_class({namespace:"gb",name:"render_technique_base",init:function(width,height,name,index){this.m_name=name;this.m_frame_width=width;this.m_frame_height=height;this.m_index=index;this.m_clear_color=new gb.vec4(.5,.5,.5,1);this.m_frame_buffer=null;Object.defineProperty(this,"name",{get:function(){return this.m_name}});Object.defineProperty(this,"frame_width",{get:function(){return this.m_frame_width}});Object.defineProperty(this,"frame_height",{get:function(){return this.m_frame_height}});
Object.defineProperty(this,"index",{get:function(){return this.m_index}});Object.defineProperty(this,"clear_color",{set:function(value){this.m_clear_color=value}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"render_technique_main",extend:gb.render_technique_base,init:function(width,height,name,index,material){this.m_material=material;this.m_screen_quad=gb.mesh_constructor.create_screen_quad();this.m_render_buffer=null},release:function(){this.m_screen_quad.release()},methods:{bind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.bindRenderbuffer(gl.RENDERBUFFER,this.m_render_buffer);gl.viewport(0,0,this.m_frame_width,this.m_frame_height);gl.disable(gl.DEPTH_TEST);
gb.material_cached_parameters.get_cached_parameters().is_depth_test=false;gl.depthMask(false);gb.material_cached_parameters.get_cached_parameters().is_depth_mask=false;gl.disable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters().is_stencil_test=false;gl.clearColor(this.m_clear_color.x,this.m_clear_color.y,this.m_clear_color.z,this.m_clear_color.w);gl.clear(gl.COLOR_BUFFER_BIT);if(this.m_material.shader&&this.m_material.shader.is_commited){this.m_material.bind();this.m_screen_quad.bind(this.m_material.shader.attributes)}},
unbind:function(){if(this.m_material.shader&&this.m_material.shader.is_commited){this.m_material.unbind();this.m_screen_quad.unbind(this.m_material.shader.attributes)}},draw:function(){if(this.m_material.shader&&this.m_material.shader.is_commited)this.m_screen_quad.draw()}},static_methods:{}});oop.define_class({namespace:"gb",name:"render_technique_ws",extend:gb.render_technique_base,init:function(width,height,name,index,num_passes){this.m_num_passes=Math.max(num_passes,1);var color_attachment_id=gl.createTexture();this.m_color_attachment_texture=gb.texture.construct(name+".color",color_attachment_id,this.m_frame_width,this.m_frame_height);this.m_color_attachment_texture.wrap_mode=gl.CLAMP_TO_EDGE;this.m_color_attachment_texture.mag_filter=gl.LINEAR;this.m_color_attachment_texture.min_filter=
gl.LINEAR;this.m_color_attachment_texture.bind();gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.m_frame_width,this.m_frame_height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.m_depth_attachment_texture=null;this.m_depth_attachment_id=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.m_depth_attachment_id);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,this.m_frame_width,this.m_frame_height);this.m_frame_buffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);
gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,color_attachment_id,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this.m_depth_attachment_id);var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)console.error("can't create framebuffer");Object.defineProperty(this,"color_attachment_texture",{get:function(){return this.m_color_attachment_texture}});Object.defineProperty(this,"depth_attachment_texture",
{get:function(){return this.m_depth_attachment_texture}});Object.defineProperty(this,"num_passes",{get:function(){return this.m_num_passes}})},release:function(){gl.deleteFramebuffer(this.m_frame_buffer);gl.deleteRenderbuffer(this.m_depth_attachment_id);this.m_color_attachment_texture.release()},methods:{bind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.viewport(0,0,this.m_frame_width,this.m_frame_height);gl.disable(gl.DEPTH_TEST);gb.material_cached_parameters.get_cached_parameters().is_depth_test=
true;gl.depthMask(false);gb.material_cached_parameters.get_cached_parameters().is_depth_mask=true;gl.enable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters().is_stencil_test=true;gl.stencilOp(gl.KEEP,gl.KEEP,gl.REPLACE);gl.clearColor(this.m_clear_color.x,this.m_clear_color.y,this.m_clear_color.z,this.m_clear_color.w);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)},unbind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null)},draw:function(){}},static_methods:{}});oop.define_class({namespace:"gb",name:"render_technique_ss",extend:gb.render_technique_base,init:function(width,height,name,index,material){var color_attachment_id=gl.createTexture();this.m_color_attachment_texture=gb.texture.construct(name+".color",color_attachment_id,this.m_frame_width,this.m_frame_height);this.m_color_attachment_texture.wrap_mode=gl.CLAMP_TO_EDGE;this.m_color_attachment_texture.mag_filter=gl.LINEAR;this.m_color_attachment_texture.min_filter=gl.LINEAR;this.m_color_attachment_texture.bind();
gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.m_frame_width,this.m_frame_height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.m_frame_buffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,color_attachment_id,0);var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)console.error("can't create framebuffer");this.m_material=material;this.m_screen_quad=gb.mesh_constructor.create_screen_quad();
Object.defineProperty(this,"color_attachment_texture",{get:function(){return this.m_color_attachment_texture}});Object.defineProperty(this,"material",{get:function(){return this.m_material}})},release:function(){this.m_screen_quad.release();this.m_color_attachment_texture.release();gl.deleteFramebuffer(this.m_frame_buffer)},methods:{bind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.viewport(0,0,this.m_frame_width,this.m_frame_height);gl.disable(gl.DEPTH_TEST);gb.material_cached_parameters.get_cached_parameters().is_depth_test=
false;gl.depthMask(false);gb.material_cached_parameters.get_cached_parameters().is_depth_mask=false;gl.disable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters().is_stencil_test=false;gl.clearColor(this.m_clear_color.x,this.m_clear_color.y,this.m_clear_color.z,this.m_clear_color.w);gl.clear(gl.COLOR_BUFFER_BIT);if(this.m_material.shader&&this.m_material.shader.is_commited){this.m_material.bind();this.m_screen_quad.bind(this.m_material.shader.attributes)}},unbind:function(){if(this.m_material.shader&&
this.m_material.shader.is_commited){this.m_material.unbind();this.m_screen_quad.unbind(this.m_material.shader.attributes)}},draw:function(){if(this.m_material.shader&&this.m_material.shader.is_commited)this.m_screen_quad.draw()}},static_methods:{}});oop.define_class({namespace:"gb",name:"render_pipeline",init:function(){this.m_main_render_technique=null;this.m_ws_render_techniques=[];this.m_unique_ws_render_techniques=[];this.m_ss_render_techniques=[];this.m_unique_ss_render_techniques=[];Object.defineProperty(this,"ws_render_techniques",{get:function(){return this.m_ws_render_techniques}})},release:function(){var techniques_count=this.m_ws_render_techniques.length;var technique=null;for(var i=0;i<techniques_count;++i){technique=this.m_ws_render_techniques[i];
technique.release()}techniques_count=this.m_ss_render_techniques.length;for(var i=0;i<techniques_count;++i){technique=this.m_ss_render_techniques[i];technique.release()}this.m_main_render_technique.release()},methods:{create_main_render_technique:function(material){this.m_main_render_technique=new gb.render_technique_main(gl.viewport_width,gl.viewport_height,"main",0,material)},add_ws_render_technique:function(technique_name,technique_index,technique){var guid=""+technique_index+technique_name;if(!this.m_unique_ws_render_techniques[guid]){this.m_unique_ws_render_techniques[guid]=
technique;this.m_ws_render_techniques.push(technique)}else console.log("can't add same ws render technique: "+technique_name)},remove_ws_render_technique:function(technique_name,technique_index){},add_ss_render_technique:function(technique_name,technique){if(typeof this.m_unique_ss_render_techniques[technique_name]==="undefined"){this.m_unique_ss_render_techniques[technique_name]=technique;this.m_ss_render_techniques.push(technique)}else console.log("can't add same ss render technique: "+technique_name)},
remove_ss_render_technique:function(technique_name){},on_draw_begin:function(){},on_draw_end:function(){for(var i=0;i<this.m_ss_render_techniques.length;++i){var technique=this.m_ss_render_techniques[i];technique.bind();technique.draw();technique.unbind()}if(this.m_main_render_technique){this.m_main_render_technique.bind();this.m_main_render_technique.draw();this.m_main_render_technique.unbind()}},get_ws_technique_result_as_image:function(technique_name,technique_index,image_width,image_height){var image=
null;var guid=""+technique_index+technique_name;if(this.m_unique_ws_render_techniques[guid]){var technique=this.m_unique_ws_render_techniques[guid];var material=new gb.material;var shader=gb.builtin_shaders.get_screen_quad_tex2d_shader();material.shader=shader;material.set_texture(technique.color_attachment_texture,gb.shader.sampler_type.sampler_01);var screen_quad=new gb.mesh_constructor.create_screen_quad;var render_target=new gb.render_target(technique.frame_width,technique.frame_height);render_target.begin();
if(material.shader&&material.shader.is_commited){material.bind();screen_quad.bind(material.shader.attributes);screen_quad.draw();material.unbind();screen_quad.unbind(material.shader.attributes)}var image=render_target.end(image_width,image_height);render_target.release();screen_quad.release()}return image}},static_methods:{}});oop.define_class({namespace:"gb",name:"render_target",init:function(width,height){var color_attachment_id=gl.createTexture();this.m_color_attachment_texture=gb.texture.construct("render_target",color_attachment_id,width,height);this.m_color_attachment_texture.wrap_mode=gl.CLAMP_TO_EDGE;this.m_color_attachment_texture.mag_filter=gl.LINEAR;this.m_color_attachment_texture.min_filter=gl.LINEAR;this.m_color_attachment_texture.bind();gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,
null);this.m_frame_buffer=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,color_attachment_id,0);var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(status!==gl.FRAMEBUFFER_COMPLETE)console.error("can't create framebuffer");this.m_screen_quad=gb.mesh_constructor.create_screen_quad()},release:function(){gl.deleteFramebuffer(this.m_frame_buffer);this.m_color_attachment_texture.release();this.m_screen_quad.release()},
methods:{begin:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.m_frame_buffer);gl.viewport(0,0,this.m_color_attachment_texture.width,this.m_color_attachment_texture.height);gl.disable(gl.DEPTH_TEST);gb.material_cached_parameters.get_cached_parameters().is_depth_test=false;gl.depthMask(false);gb.material_cached_parameters.get_cached_parameters().is_depth_mask=false;gl.disable(gl.STENCIL_TEST);gb.material_cached_parameters.get_cached_parameters().is_stencil_test=false;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT)},
end:function(clip_width,clip_height){var data=new Uint8Array(this.m_color_attachment_texture.width*this.m_color_attachment_texture.height*4);gl.readPixels(0,0,this.m_color_attachment_texture.width,this.m_color_attachment_texture.height,gl.RGBA,gl.UNSIGNED_BYTE,data);var canvas_2d=document.createElement("canvas");canvas_2d.width=this.m_color_attachment_texture.width;canvas_2d.height=this.m_color_attachment_texture.height;var context_2d=canvas_2d.getContext("2d");var image_data=context_2d.createImageData(this.m_color_attachment_texture.width,
this.m_color_attachment_texture.height);image_data.data.set(data);context_2d.putImageData(image_data,0,0);var image=new Image;image.src=canvas_2d.toDataURL();canvas_2d.width=clip_width;canvas_2d.height=clip_height;context_2d.clearRect(0,0,this.m_color_attachment_texture.width,this.m_color_attachment_texture.height);context_2d.scale(1,-1);context_2d.drawImage(image,0,-image.height);image.src=canvas_2d.toDataURL();return image}},static_methods:{}});var g_input_context=null;
oop.define_class({namespace:"gb",name:"input_context",constants:{source:{mouse:0,keyboard:3},state:{pressed:0,released:1,moved:2,dragged:3}},init:function(){g_input_context=this;var canvas=document.getElementById("gl_canvas");canvas.onmousedown=this.on_mouse_pressed;canvas.onmouseup=this.on_mouse_released;canvas.onmousemove=this.on_mouse_moved;this.m_listeners=[];this.m_mouse_pressed=false;this.m_previouse_pressed_point=new gb.vec2(0)},release:function(){},methods:{on_mouse_pressed:function(event){g_input_context.m_mouse_pressed=true;
var listeners_count=g_input_context.m_listeners.length;for(var i=0;i<listeners_count;++i){var listener=g_input_context.m_listeners[i];if(listener.on_mouse_pressed)listener.on_mouse_pressed(new gb.vec2(event.offsetX,event.offsetY))}g_input_context.m_previouse_pressed_point.x=event.offsetX;g_input_context.m_previouse_pressed_point.y=event.offsetY},on_mouse_released:function(event){g_input_context.m_mouse_pressed=false;var listeners_count=g_input_context.m_listeners.length;for(var i=0;i<listeners_count;++i){var listener=
g_input_context.m_listeners[i];if(listener.on_mouse_released)listener.on_mouse_released(new gb.vec2(event.offsetX,event.offsetY))}g_input_context.m_previouse_pressed_point.x=event.offsetX;g_input_context.m_previouse_pressed_point.y=event.offsetY},on_mouse_moved:function(event){var listeners_count=g_input_context.m_listeners.length;for(var i=0;i<listeners_count;++i){var listener=g_input_context.m_listeners[i];if(!g_input_context.m_mouse_pressed&&listener.on_mouse_moved)listener.on_mouse_moved(new gb.vec2(event.offsetX,
event.offsetY),new gb.vec2(g_input_context.m_previouse_pressed_point.x-event.offsetX,g_input_context.m_previouse_pressed_point.y-event.offsetY));else if(g_input_context.m_mouse_pressed&&listener.on_mouse_dragged)listener.on_mouse_dragged(new gb.vec2(event.offsetX,event.offsetY),new gb.vec2(g_input_context.m_previouse_pressed_point.x-event.offsetX,g_input_context.m_previouse_pressed_point.y-event.offsetY))}g_input_context.m_previouse_pressed_point.x=event.offsetX;g_input_context.m_previouse_pressed_point.y=
event.offsetY},add_listener:function(listener){this.m_listeners.push(listener)},remove_listener:function(listener){var index=_.indexOf(this.m_listeners,listener);if(index!==-1)this.m_listeners.splice(index,1);else console.error("input context doesn't contain this listener")}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_base_component",constants:{type:{undefined:-1,transformation:0,material:1,geometry:2,scene:3,light:4,light_mask:5,convex_hull:6,touch_recognize:7,animation:8,box2d_body:9,box2d_world:10,action:11,max:12}},init:function(){this.m_type=gb.ces_base_component.undefined;Object.defineProperty(this,"type",{get:function(){return this.m_type}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_transformation_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.transformation;this.m_position=new gb.vec2(0);this.m_rotation=0;this.m_scale=new gb.vec2(1);this.m_matrix_t=(new gb.mat4).identity();this.m_matrix_r=(new gb.mat4).identity();this.m_matrix_s=(new gb.mat4).identity();this.m_matrix_m=(new gb.mat4).identity();this.m_is_matrix_m_computed=false;var self=this;Object.defineProperty(this,"position",{set:function(value){self.m_position=
value;Object.defineProperty(value,"x",{set:function(value){self.m_position.m_data[0]=value;self.m_matrix_t.translate(self.m_position.x,self.m_position.y,0);self.m_is_matrix_m_computed=false},get:function(){return self.m_position.m_data[0]}});Object.defineProperty(value,"y",{set:function(value){self.m_position.m_data[1]=value;self.m_matrix_t.translate(self.m_position.x,self.m_position.y,0);self.m_is_matrix_m_computed=false},get:function(){return self.m_position.m_data[1]}});self.m_matrix_t.translate(self.m_position.x,
self.m_position.y,0);self.m_is_matrix_m_computed=false},get:function(){return self.m_position}});Object.defineProperty(this,"rotation",{set:function(value){this.m_rotation=value;this.m_matrix_r.rotate_z(this.m_rotation);this.m_is_matrix_m_computed=false},get:function(){return this.m_rotation}});Object.defineProperty(this,"scale",{set:function(value){this.m_scale=value;Object.defineProperty(value,"x",{set:function(value){self.m_scale.m_data[0]=value;self.m_matrix_s.scale(self.m_scale.x,self.m_scale.y,
1);self.m_is_matrix_m_computed=false},get:function(){return self.m_scale.m_data[0]}});Object.defineProperty(value,"y",{set:function(value){self.m_scale.m_data[1]=value;self.m_matrix_s.scale(self.m_scale.x,self.m_scale.y,1);self.m_is_matrix_m_computed=false},get:function(){return self.m_scale.m_data[1]}});this.m_matrix_s.scale(this.m_scale.x,this.m_scale.y,1);this.m_is_matrix_m_computed=false},get:function(){return this.m_scale}});Object.defineProperty(this,"matrix_m",{get:function(){if(!this.m_is_matrix_m_computed){this.m_matrix_m=
gb.mat4.multiply(gb.mat4.multiply(this.m_matrix_t,this.m_matrix_r),this.m_matrix_s);this.m_is_matrix_m_computed=true}return this.m_matrix_m}});this.position=new gb.vec2(0);this.rotation=0;this.scale=new gb.vec2(1)},release:function(){},methods:{},static_methods:{get_parent_transformation:function(entity,is_use_scale){var matrix=(new gb.mat4).identity();var parent=entity.parent;while(parent){var parent_transformation_component=parent.get_component(gb.ces_base_component.type.transformation);if(is_use_scale)matrix=
gb.mat4.multiply(matrix,parent_transformation_component.matrix_m);else matrix=gb.mat4.multiply(matrix,gb.mat4.multiply(parent_transformation_component.m_matrix_t,parent_transformation_component.m_matrix_r));parent=parent.parent}return matrix},get_absolute_transformation:function(entity,is_use_scale){var matrix=gb.ces_transformation_component.get_parent_transformation(entity,is_use_scale);var transformation_component=entity.get_component(gb.ces_base_component.type.transformation);if(is_use_scale)matrix=
gb.mat4.multiply(matrix,transformation_component.matrix_m);else matrix=gb.mat4.multiply(matrix,gb.mat4.multiply(transformation_component.m_matrix_t,transformation_component.m_matrix_r));return matrix},get_absolute_transformation_in_camera_space:function(entity){var matrix=gb.ces_transformation_component.get_absolute_transformation(entity);if(entity.is_component_exist(gb.ces_base_component.type.scene)){var scene_component=entity.get_component(gb.ces_base_component.type.scene);matrix=gb.mat4.multiply(matrix,
scene_component.camera.matrix_v)}return matrix}}});oop.define_class({namespace:"gb",name:"ces_material_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.material;this.m_materials=[]},release:function(){},methods:{add_material:function(technique_name,technique_pass,material){if(typeof this.m_materials[technique_name]==="undefined")this.m_materials[technique_name]=[];this.m_materials[technique_name][technique_pass]=material},remove_material:function(technique_name,technique_pass){if(typeof this.m_materials[technique_name]!==
"undefined"&&this.m_materials[technique_name].length>technique_pass)this.m_materials[technique_name].splice(technique_pass,1)},get_material:function(technique_name,technique_pass){var material=null;if(typeof this.m_materials[technique_name]!=="undefined"&&this.m_materials[technique_name].length>technique_pass)material=this.m_materials[technique_name][technique_pass];return material},bind:function(technique_name,technique_pass,material){var using_material=material;if(typeof material==="undefined")using_material=
this.get_material(technique_name,technique_pass);using_material.bind()},unbind:function(technique_name,technique_pass,material){var using_material=material;if(typeof material==="undefined")using_material=this.get_material(technique_name,technique_pass);using_material.unbind()},set_custom_shader_uniform:function(value,uniform,technique_name,technique_pass){if(arguments.length===4){var material=this.get_material(technique_name,technique_pass);if(material)material.set_custom_shader_uniform(value,uniform)}else{var materials_count=
0;for(var key in this.m_materials){materials_count=this.m_materials[key].length;for(var i=0;i<materials_count;++i)this.m_materials[key][i].set_custom_shader_uniform(value,uniform)}}},set_texture:function(texture,sampler,technique_name,technique_pass){if(arguments.length===4){var material=this.get_material(technique_name,technique_pass);if(material)material.set_texture(texture,sampler)}else{var materials_count=0;for(var key in this.m_materials){materials_count=this.m_materials[key].length;for(var i=
0;i<materials_count;++i)this.m_materials[key][i].set_texture(texture,sampler)}}},swap_texture_to_active:function(guid){var materials_count=0;for(var key in this.m_materials){materials_count=this.m_materials[key].length;for(var i=0;i<materials_count;++i){var material=this.m_materials[key][i];sampler=material.get_texture_sampler(guid);if(sampler>0){var texture_0=material.get_texture(0);var texture_to_swap=material.get_texture(sampler);material.set_texture(texture_to_swap,0);material.set_texture(texture_0,
sampler)}}}}},static_methods:{add_material:function(entity,technique_name,technique_pass,material){var material_component=entity.get_component(gb.ces_base_component.type.material);if(material_component)material_component.add_material(technique_name,technique_pass,material)},remove_material:function(entity,technique_name,technique_pass){var material_component=entity.get_component(gb.ces_base_component.type.material);if(material_component)material_component.remove_material(technique_name,technique_pass)},
get_material:function(entity,technique_name,technique_pass){var material=null;var material_component=entity.get_component(gb.ces_base_component.type.material);if(material_component)material=material_component.get_material(technique_name,technique_pass);return material}}});oop.define_class({namespace:"gb",name:"ces_scene_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.scene;this.m_scene=null;Object.defineProperty(this,"scene",{set:function(value){this.m_scene=value},get:function(){return this.m_scene}});Object.defineProperty(this,"camera",{get:function(){return this.m_scene.camera}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_convex_hull_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.convex_hull;this.m_center=new gb.vec2(0);this.m_oriented_vertices=[];Object.defineProperty(this,"center",{get:function(){return this.m_center}});Object.defineProperty(this,"oriented_vertices",{get:function(){return this.m_oriented_vertices}})},release:function(){},methods:{generate_convex_hull:function(vertices){if(vertices.length<3)return;this.m_oriented_vertices=
[];var leftmost_point_index=0;for(var i=0;i<vertices.length;++i)if(vertices[i].x<vertices[leftmost_point_index].x)leftmost_point_index=i;var start_point_index=leftmost_point_index,end_point_index;do{end_point_index=(start_point_index+1)%vertices.length;for(var i=0;i<vertices.length;++i)if(gb.math.point_orientation(vertices[start_point_index],vertices[i],vertices[end_point_index])===gb.math.orientation.counterclockwise)end_point_index=i;this.m_oriented_vertices.push(vertices[end_point_index]);start_point_index=
end_point_index}while(start_point_index!==leftmost_point_index);var min_bound=new gb.vec2(gb.math.INT16_MAX);var max_bound=new gb.vec2(gb.math.INT16_MIN);for(var i=0;i<this.m_oriented_vertices.length;++i){min_bound=gb.vec2.min(this.m_oriented_vertices[i],min_bound);max_bound=gb.vec2.max(this.m_oriented_vertices[i],max_bound)}this.m_center=gb.vec2.sub(max_bound,min_bound).divide_scalar(2)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_geometry_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.geometry;this.m_mesh=null;this.m_size=new gb.vec2(0);this.m_pivot=new gb.vec2(0);Object.defineProperty(this,"pivot",{configurable:true,get:function(){return this.m_pivot},set:function(value){this.m_pivot=value}});Object.defineProperty(this,"size",{configurable:true,get:function(){return this.m_size},set:function(value){this.m_size=value}});Object.defineProperty(this,
"mesh",{configurable:true,get:function(){return this.m_mesh}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_geometry_freeform_component",extend:gb.ces_geometry_component,init:function(){Object.defineProperty(this,"mesh",{get:function(){return this.m_mesh},set:function(value){this.m_mesh=value}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_geometry_quad_component",extend:gb.ces_geometry_component,init:function(){this.m_mesh=gb.mesh_constructor.create_shape_quad();this.m_pivot.x=.5;this.m_pivot.y=.5;Object.defineProperty(this,"pivot",{get:function(){return this.m_pivot},set:function(value){this.m_pivot=value;this.m_pivot.x=Math.max(Math.min(this.m_pivot.x,1),0);this.m_pivot.y=Math.max(Math.min(this.m_pivot.y,1),0);this.update_mesh_position_attributes()}});Object.defineProperty(this,"size",{get:function(){return this.m_size},
set:function(value){this.m_size=value;this.update_mesh_position_attributes()}})},release:function(){},methods:{update_mesh_position_attributes:function(){var position_00=new gb.vec2(-this.m_size.x*(1-this.m_pivot.x),-this.m_size.y*(1-this.m_pivot.y));var position_11=new gb.vec2(this.m_size.x*this.m_pivot.x,this.m_size.y*this.m_pivot.y);var vbo=this.m_mesh.vbo;vbo.write_attribute(gb.vbo.attribute.position,0,new gb.vec2(position_00.x,position_00.y));vbo.write_attribute(gb.vbo.attribute.position,1,new gb.vec2(position_00.x,
position_11.y));vbo.write_attribute(gb.vbo.attribute.position,2,new gb.vec2(position_11.x,position_00.y));vbo.write_attribute(gb.vbo.attribute.position,3,new gb.vec2(position_11.x,position_11.y));vbo.submit()},update_mesh_texcoord_attributes:function(u_0,v_0,u_1,v_1){var vbo=this.m_mesh.vbo;vbo.write_attribute(gb.vbo.attribute.texcoord,0,new gb.vec2(u_0,v_0));vbo.write_attribute(gb.vbo.attribute.texcoord,1,new gb.vec2(u_0,v_1));vbo.write_attribute(gb.vbo.attribute.texcoord,2,new gb.vec2(u_1,v_0));
vbo.write_attribute(gb.vbo.attribute.texcoord,3,new gb.vec2(u_1,v_1));vbo.submit()}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_light_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.light;this.m_shadow_casters=[];Object.defineProperty(this,"shadow_casters",{get:function(){return this.m_shadow_casters}})},release:function(){},methods:{add_shadow_caster:function(shadow_caster){this.m_shadow_casters.push(shadow_caster)},cleanup:function(){this.m_shadow_casters=[]}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_light_mask_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.light_mask;this.m_shadow_casters_vertices=[];this.m_shadow_casters_edges=[];this.m_vertices=[];this.m_indices=[];var vbo=new gb.vbo(1024,gl.DYNAMIC_DRAW,gb.vbo.declaration.position_xy);var ibo=new gb.ibo(4096,gl.DYNAMIC_DRAW);this.m_mesh=new gb.mesh(vbo,ibo,gl.TRIANGLES);Object.defineProperty(this,"mesh",{get:function(){if(this.m_vertices.length===0||
this.m_indices.length===0){this.m_mesh.vbo.submit(1);this.m_mesh.ibo.submit(1)}else{var vbo=this.m_mesh.vbo;for(var i=0;i<this.m_vertices.length;++i)vbo.write_attribute(gb.vbo.attribute.position,i,this.m_vertices[i]);vbo.submit();var ibo=this.m_mesh.ibo;for(var i=0;i<this.m_indices.length;++i)ibo.write_element(i,this.m_indices[i]);ibo.submit(this.m_indices.length)}return this.m_mesh}})},release:function(){},methods:{update_mask_geometry:function(shadow_caster_matrix_m,convex_hull_oriented_vertices){for(var i=
0;i<convex_hull_oriented_vertices.length;++i){var next_vertex_index=(i+1)%convex_hull_oriented_vertices.length;this.m_shadow_casters_edges.push({point_01:gb.mat4.multiply_vec2(convex_hull_oriented_vertices[i],shadow_caster_matrix_m),point_02:gb.mat4.multiply_vec2(convex_hull_oriented_vertices[next_vertex_index],shadow_caster_matrix_m)});this.m_shadow_casters_vertices.push(gb.mat4.multiply_vec2(convex_hull_oriented_vertices[i],shadow_caster_matrix_m))}},generate_mask_mesh:function(light_caster_position){var angles=
[];for(var i=0;i<this.m_shadow_casters_vertices.length;++i){var point=this.m_shadow_casters_vertices[i];var angle=Math.atan2(point.y-light_caster_position.y,point.x-light_caster_position.x);angles.push(angle-1E-4);angles.push(angle);angles.push(angle+1E-4)}var intersections=[];var direction=new gb.vec2(0);var undefined_intersection=new gb.vec2(gb.math.INT16_MIN);var closest_intersection=new gb.vec2(undefined_intersection);var closest_distance=gb.math.INT16_MAX;for(var i=0;i<angles.length;++i){var angle=
angles[i];direction.x=Math.cos(angle);direction.y=Math.sin(angle);var ray={origin:light_caster_position,direction:direction.add(light_caster_position)};closest_distance=gb.math.INT16_MAX;closest_intersection.x=undefined_intersection.x;closest_intersection.y=undefined_intersection.y;for(var j=0;j<this.m_shadow_casters_edges.length;++j){var intersection=gb.math.intersect(ray.origin,ray.direction,this.m_shadow_casters_edges[j].point_01,this.m_shadow_casters_edges[j].point_02);if(!intersection.intersected)continue;
if(intersection.distance<closest_distance){closest_distance=intersection.distance;closest_intersection.x=intersection.point_x;closest_intersection.y=intersection.point_y}}if(closest_intersection.equals(undefined_intersection))continue;var is_contain=intersections.findIndex(function(value){return value.point_x===closest_intersection.x&&value.point_y===closest_intersection.y});if(is_contain===-1)intersections.push({point_x:closest_intersection.x,point_y:closest_intersection.y,angle:angle})}intersections.sort(function(a,
b){return a.angle-b.angle});var delta_size=intersections.length+1-this.m_vertices.length;if(delta_size>0){var old_size=this.m_vertices.length;this.m_vertices.length=intersections.length+1;for(var i=old_size;i<this.m_vertices.length;++i)this.m_vertices[i]=new gb.vec2}else if(delta_size<0)this.m_vertices.length=intersections.length+1;this.m_vertices[0]=light_caster_position;var index=1;for(var i=0;i<intersections.length;++i){var intersection=intersections[i];this.m_vertices[index].x=intersection.point_x;
this.m_vertices[index].y=intersection.point_y;index++}for(var i=1;i<this.m_vertices.length;++i){var next_vertex_index=Math.max((i+1)%this.m_vertices.length,1);this.m_indices.push(0);this.m_indices.push(i);this.m_indices.push(next_vertex_index)}},cleanup:function(){this.m_shadow_casters_vertices=[];this.m_shadow_casters_edges=[];this.m_indices=[]}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_touch_recognize_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.touch_recognize;this.m_bound=new gb.vec4(0);this.m_min_bound=new gb.vec2(0);this.m_max_bound=new gb.vec2(0);this.m_responders=[];this.m_responders[gb.input_context.state.pressed]=false;this.m_responders[gb.input_context.state.released]=false;this.m_responders[gb.input_context.state.moved]=false;this.m_responders[gb.input_context.state.dragged]=false;
this.m_callbacks=[];this.m_callbacks[gb.input_context.state.pressed]=[];this.m_callbacks[gb.input_context.state.released]=[];this.m_callbacks[gb.input_context.state.moved]=[];this.m_callbacks[gb.input_context.state.dragged]=[];Object.defineProperty(this,"bound",{set:function(value){this.m_bound=value;this.m_min_bound.x=value.x;this.m_min_bound.y=value.y;this.m_max_bound.x=value.z;this.m_max_bound.y=value.w},get:function(){return this.m_bound}});Object.defineProperty(this,"min_bound",{get:function(){return this.m_min_bound}});
Object.defineProperty(this,"max_bound",{get:function(){return this.m_max_bound}})},release:function(){},methods:{enable:function(state,value){this.m_responders[state]=value},is_respond_to:function(state){return this.m_responders[state]},add_callback:function(state,callback,userdata){this.m_callbacks[state].push({callback:callback,userdata:userdata})},remove_callback:function(state,callback){var index=this.m_callbacks[state].findIndex(function(analized_callback){return callback===analized_callback.callback});
if(index!==-1)this.m_callbacks[state].splice(index,1)},get_callbacks:function(state){return this.m_callbacks[state]}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_animation_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.animation;this.m_frames=[];this.m_current_animation="";this.m_current_frame=0;this.m_switch_frame_deltatime=60/1E3;this.m_current_switch_frame_deltatime=60/1E3;Object.defineProperty(this,"frames",{get:function(){if(this.m_frames[this.m_current_animation])return this.m_frames[this.m_current_animation];else return null}});Object.defineProperty(this,"current_frame",
{get:function(){return this.m_current_frame},set:function(value){this.m_current_frame=value}});Object.defineProperty(this,"current_animation",{get:function(){return this.m_current_animation},set:function(value){this.m_current_animation=value;this.m_current_frame=0}});Object.defineProperty(this,"switch_frame_deltatime",{get:function(){return this.m_switch_frame_deltatime}});Object.defineProperty(this,"current_switch_frame_deltatime",{get:function(){return this.m_current_switch_frame_deltatime},set:function(value){this.m_current_switch_frame_deltatime=
value}})},release:function(){},methods:{set_animations_configuration:function(animations_configuration){this.m_frames=[];var animations=animations_configuration["animations"];var frames=animations_configuration["frames"];var animations_count=animations.length;for(var i=0;i<animations_count;++i){animation=animations[i];var animation_name=animation.name;var first_frame=animation.first_frame;var last_frame=animation.last_frame;this.m_frames[animation_name]=[];for(var j=first_frame;j<last_frame;++j)this.m_frames[animation_name].push(frames[j])}}},
static_methods:{}});oop.define_class({namespace:"gb",name:"ces_box2d_body_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.box2d_body;this.m_position=new gb.vec2(0);this.m_rotation=0;this.m_box2d_body=null;this.m_box2d_definition=new Box2D.b2BodyDef;Object.defineProperty(this,"position",{configurable:true,get:function(){return this.m_position}});Object.defineProperty(this,"rotation",{configurable:true,get:function(){return this.m_rotation}});Object.defineProperty(this,"box2d_definition",
{configurable:true,get:function(){return this.m_box2d_definition}});Object.defineProperty(this,"box2d_body",{configurable:true,get:function(){return this.m_box2d_body},set:function(value){this.m_box2d_body=value}})},release:function(){},methods:{on_position_changed:function(position){this.m_position=position},on_rotation_changed:function(rotation){this.m_rotation=rotation}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_box2d_world_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.box2d_world;this.m_gravity=new Box2D.b2Vec2(0,9.8);this.m_box2d_world=new Box2D.b2World(this.m_gravity);this.m_box2d_world.SetContinuousPhysics(true);this.m_box2d_definition=new Box2D.b2BodyDef;this.m_box2d_definition.set_position(new Box2D.b2Vec2(0,0));this.m_box2d_body=this.m_box2d_world.CreateBody(this.m_box2d_definition);this.m_min_bound=null;this.m_max_bound=
null;Object.defineProperty(this,"box2d_world",{configurable:true,get:function(){return this.m_box2d_world}})},release:function(){},methods:{set_bounds:function(min_bound,max_bound){this.m_min_bound=min_bound;this.m_max_bound=max_bound;var bounding_box=new Box2D.b2EdgeShape;bounding_box.Set(new Box2D.b2Vec2(min_bound.x,min_bound.y),new Box2D.b2Vec2(max_bound.x,min_bound.y));this.m_box2d_body.CreateFixture(bounding_box,0);bounding_box.Set(new Box2D.b2Vec2(min_bound.x,max_bound.y),new Box2D.b2Vec2(max_bound.x,
max_bound.y));this.m_box2d_body.CreateFixture(bounding_box,0);bounding_box.Set(new Box2D.b2Vec2(min_bound.x,max_bound.y),new Box2D.b2Vec2(min_bound.x,min_bound.y));this.m_box2d_body.CreateFixture(bounding_box,0);bounding_box.Set(new Box2D.b2Vec2(max_bound.x,max_bound.y),new Box2D.b2Vec2(max_bound.x,min_bound.y));this.m_box2d_body.CreateFixture(bounding_box,0)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_action_component",extend:gb.ces_base_component,init:function(){this.m_type=gb.ces_base_component.type.action;this.m_action=null;Object.defineProperty(this,"action",{get:function(){return this.m_action},set:function(value){this.m_action=value}})},release:function(){},methods:{},static_methods:{}});var g_tag=0;
oop.define_class({namespace:"gb",name:"ces_entity",init:function(){this.m_tag="ces_entity"+g_tag++;this.m_components=[];for(var i=0;i<gb.ces_base_component.type.max;++i)this.m_components[i]=null;this.m_parent=null;this.m_children=[];this.m_visible=true;Object.defineProperty(this,"tag",{set:function(value){this.m_tag=value},get:function(){return this.m_tag}});Object.defineProperty(this,"parent",{set:function(value){this.m_parent=value},get:function(){return this.m_parent}});Object.defineProperty(this,"children",
{get:function(){return this.m_children}});Object.defineProperty(this,"visible",{set:function(value){this.m_visible=value},get:function(){return this.m_visible}});Object.defineProperty(this,"components",{get:function(){return this.m_components}})},release:function(){},methods:{add_component:function(component){this.m_components[component.type]=component},remove_component:function(component){if(component instanceof gb.ces_base_component)this.m_components[component.type]=null;else if(component<this.m_components.length)this.m_components[component]=
null},remove_components:function(){this.m_components=[];for(var i=0;i<gb.ces_base_component.type.max;++i)this.m_components[i]=null},is_component_exist:function(component_type){return this.m_components[component_type]!==null},get_component:function(component_type){return this.m_components[component_type]},add_child:function(child){var index=this.m_children.findIndex(function(analized_child){return analized_child.tag===child.tag});if(index===-1){if(child.parent)child.parent.remove_child(child);child.parent=
this;this.m_children.push(child);this.add_scene_component()}},remove_child:function(child){var index=this.m_children.findIndex(function(analized_child){return analized_child.tag===child.tag});if(index!==-1){this.m_children[index].remove_scene_component();this.m_children[index].parent=null;this.m_children.splice(index,1)}},remove_from_parent:function(){if(this.parent)this.parent.remove_child(this)},add_scene_component:function(){var scene_component=this.parent?this.parent.get_component(gb.ces_base_component.type.scene):
null;if(!this.is_component_exist(gb.ces_base_component.type.scene)&&scene_component)this.add_component(scene_component);for(var i=0;i<this.m_children.length;++i)this.m_children[i].add_scene_component()},remove_scene_component:function(){for(var i=0;i<this.m_children.length;++i)this.m_children[i].remove_scene_component();this.remove_component(gb.ces_base_component.type.scene)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_base_system",constants:{type:{undefined:-1,render:0,deferred_lighting:1,touches_recognize:2,animation:3,box2d:4,action:5}},init:function(){this.m_type=gb.ces_base_system.type.undefined;this.m_priority=0;Object.defineProperty(this,"type",{get:function(){return this.m_type}});Object.defineProperty(this,"priority",{get:function(){return this.m_priority}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_deferred_lighting_system",extend:gb.ces_base_system,init:function(){this.m_type=gb.ces_base_system.type.deferred_lighting;this.m_light_casters=[];this.m_shadow_casters=[]},release:function(){},methods:{on_feed_start:function(){this.m_light_casters=[];this.m_shadow_casters=[]},on_feed:function(root){this.update_recursively(root)},on_feed_end:function(){for(var i=0;i<this.m_light_casters.length;++i){var light_component=this.m_light_casters[i].get_component(gb.ces_base_component.type.light);
light_component.cleanup();var light_mask_component=this.m_light_casters[i].get_component(gb.ces_base_component.type.light_mask);light_mask_component.cleanup();var light_caster_transformation_component=this.m_light_casters[i].get_component(gb.ces_base_component.type.transformation);var light_caster_matrix_m=(new gb.mat4).identity();var light_caster_parent=this.m_light_casters[i].parent;while(light_caster_parent){var light_caster_parent_transformation_component=light_caster_parent.get_component(gb.ces_base_component.type.transformation);
light_caster_matrix_m=gb.mat4.multiply(light_caster_matrix_m,light_caster_parent_transformation_component.matrix_m);light_caster_parent=light_caster_parent.parent}var light_caster_position=gb.mat4.multiply_vec2(light_caster_transformation_component.position,light_caster_matrix_m);for(var j=0;j<this.m_shadow_casters.length;++j){var convex_hull_component=this.m_shadow_casters[j].get_component(gb.ces_base_component.type.convex_hull);var shadow_caster_transformation_component=this.m_shadow_casters[j].get_component(gb.ces_base_component.type.transformation);
var shadow_caster_matrix_m=(new gb.mat4).identity();var shadow_caster_parent=this.m_shadow_casters[j].parent;while(shadow_caster_parent){var shadow_caster_parent_transformation_component=shadow_caster_parent.get_component(gb.ces_base_component.type.transformation);shadow_caster_matrix_m=gb.mat4.multiply(shadow_caster_matrix_m,shadow_caster_parent_transformation_component.matrix_m);shadow_caster_parent=shadow_caster_parent.parent}shadow_caster_matrix_m=gb.mat4.multiply(shadow_caster_matrix_m,shadow_caster_transformation_component.matrix_m);
light_mask_component.update_mask_geometry(shadow_caster_matrix_m,convex_hull_component.oriented_vertices);light_component.add_shadow_caster(this.m_shadow_casters[j])}light_mask_component.generate_mask_mesh(light_caster_position)}},update_recursively:function(entity){var light_component=entity.get_component(gb.ces_base_component.type.light);if(light_component)this.m_light_casters.push(entity);var convex_hull_component=entity.get_component(gb.ces_base_component.type.convex_hull);if(convex_hull_component)this.m_shadow_casters.push(entity);
var children=entity.children;for(var i=0;i<children.length;++i)this.update_recursively(children[i])}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_render_system",extend:gb.ces_base_system,constants:{shadow_color_uniform:"u_shadow_color",light_mask_vs_flag_uniform:"u_mask_flag_vs",light_mask_fs_flag_uniform:"u_mask_flag_fs",shadow_color_for_casters:new gb.vec4(1),shadow_color_for_receivers:new gb.vec4(0,0,0,.75)},init:function(){this.m_render_pipeline=new gb.render_pipeline;this.m_type=gb.ces_base_system.type.render;Object.defineProperty(this,"render_pipeline",{get:function(){return this.m_render_pipeline}});
this.m_screed_quad_mesh=gb.mesh_constructor.create_screen_quad()},release:function(){this.m_screed_quad_mesh.release();this.m_render_pipeline.release()},methods:{on_feed_start:function(){this.m_render_pipeline.on_draw_begin()},on_feed:function(root){var ws_render_techniques=this.m_render_pipeline.ws_render_techniques;for(var i=0;i<ws_render_techniques.length;++i){var technique=ws_render_techniques[i];var technique_name=technique.name;technique.bind();for(var technique_pass=0;technique_pass<technique.num_passes;++technique_pass){this.draw_recursively_lights(root,
technique_name,technique_pass);this.draw_recursively(root,technique_name,technique_pass)}technique.unbind()}},on_feed_end:function(){this.m_render_pipeline.on_draw_end()},draw_recursively:function(entity,technique_name,technique_pass){var scene_component=entity.get_component(gb.ces_base_component.type.scene);if(!scene_component)return;var self=this;var light_component=entity.get_component(gb.ces_base_component.type.light);var transformation_component=entity.get_component(gb.ces_base_component.type.transformation);
var material_component=entity.get_component(gb.ces_base_component.type.material);var geometry_component=entity.get_component(gb.ces_base_component.type.geometry);if(!light_component&&material_component&&geometry_component&&transformation_component){var material=material_component.get_material(technique_name,technique_pass);var mesh=geometry_component.mesh;if(material&&material.shader&&material.shader.is_commited&&mesh&&entity.visible){material.set_custom_shader_uniform(gb.ces_render_system.shadow_color_for_casters,
gb.ces_render_system.shadow_color_uniform);material_component.bind(technique_name,technique_pass,material);material.shader.set_mat4(scene_component.camera.matrix_p,gb.shader.uniform_type.mat_p);material.shader.set_mat4(scene_component.camera.matrix_v,gb.shader.uniform_type.mat_v);var matrix_m=gb.ces_transformation_component.get_absolute_transformation(entity,true);material.shader.set_mat4(matrix_m,gb.shader.uniform_type.mat_m);mesh.bind(material.shader.attributes);mesh.draw();mesh.unbind(material.shader.attributes);
material_component.unbind(technique_name,technique_pass,material)}}var children=entity.children;for(var i=0;i<children.length;++i)this.draw_recursively(children[i],technique_name,technique_pass)},draw_recursively_lights:function(entity,technique_name,technique_pass){var scene_component=entity.get_component(gb.ces_base_component.type.scene);if(!scene_component)return;var self=this;var light_component=entity.get_component(gb.ces_base_component.type.light);var light_mask_component=entity.get_component(gb.ces_base_component.type.light_mask);
var transformation_component=entity.get_component(gb.ces_base_component.type.transformation);var material_component=entity.get_component(gb.ces_base_component.type.material);var geometry_component=entity.get_component(gb.ces_base_component.type.geometry);if(light_component&&material_component&&geometry_component&&transformation_component){var material=material_component.get_material(technique_name,technique_pass);var light_main_mesh=geometry_component.mesh;var light_mask_mesh=light_mask_component.mesh;
if(material&&entity.visible&&material.shader&&material.shader.is_commited&&light_main_mesh&&light_mask_mesh){var draw_light_mask=function(){gl.colorMask(false,false,false,false);gl.depthMask(false);material.stencil_function=gl.ALWAYS;material.stencil_function_parameter_1=1;material.stencil_function_parameter_2=255;material.stencil_mask_parameter=1;material.set_custom_shader_uniform(0,gb.ces_render_system.light_mask_vs_flag_uniform);material.set_custom_shader_uniform(1,gb.ces_render_system.light_mask_fs_flag_uniform);
material_component.bind(technique_name,technique_pass,material);material.shader.set_mat4(scene_component.camera.matrix_p,gb.shader.uniform_type.mat_p);material.shader.set_mat4(scene_component.camera.matrix_v,gb.shader.uniform_type.mat_v);material.shader.set_mat4((new gb.mat4).identity(),gb.shader.uniform_type.mat_m);light_mask_mesh.bind(material.shader.attributes);light_mask_mesh.draw();light_mask_mesh.unbind(material.shader.attributes);var shadow_casters=light_component.shadow_casters;for(var i=
0;i<shadow_casters.length;++i){var shadow_caster=shadow_casters[i];var shadow_caster_geometry_component=shadow_caster.get_component(gb.ces_base_component.type.geometry);var shadow_caster_material_component=shadow_caster.get_component(gb.ces_base_component.type.material);if(shadow_caster_material_component.get_material(technique_name,technique_pass)){var shadow_caster_mesh=shadow_caster_geometry_component.mesh;var shadow_caster_matrix_m=gb.ces_transformation_component.get_absolute_transformation(shadow_caster,
false);material.shader.set_mat4(shadow_caster_matrix_m,gb.shader.uniform_type.mat_m);shadow_caster_mesh.bind(material.shader.attributes);shadow_caster_mesh.draw();shadow_caster_mesh.unbind(material.shader.attributes)}}gl.colorMask(true,true,true,true);gl.depthMask(true);material_component.unbind(technique_name,technique_pass,material)};var draw_light=function(){var light_caster_matrix_m=gb.ces_transformation_component.get_absolute_transformation(entity,true);material.stencil_function=gl.EQUAL;material.stencil_function_parameter_1=
1;material.stencil_function_parameter_2=255;material.stencil_mask_parameter=0;material.blending_function_source=gl.SRC_ALPHA;material.blending_function_destination=gl.ONE;material.set_custom_shader_uniform(0,gb.ces_render_system.light_mask_vs_flag_uniform);material.set_custom_shader_uniform(0,gb.ces_render_system.light_mask_fs_flag_uniform);material_component.bind(technique_name,technique_pass,material);material.shader.set_mat4(light_caster_matrix_m,gb.shader.uniform_type.mat_m);light_main_mesh.bind(material.shader.attributes);
light_main_mesh.draw();light_main_mesh.unbind(material.shader.attributes);material_component.unbind(technique_name,technique_pass,material)};var clear_light_mask=function(){gl.colorMask(false,false,false,false);gl.depthMask(false);material.stencil_function=gl.ALWAYS;material.stencil_function_parameter_1=0;material.stencil_function_parameter_2=255;material.stencil_mask_parameter=1;material.set_custom_shader_uniform(1,gb.ces_render_system.light_mask_vs_flag_uniform);material.set_custom_shader_uniform(1,
gb.ces_render_system.light_mask_fs_flag_uniform);material_component.bind(technique_name,technique_pass,material);material.shader.set_mat4((new gb.mat4).identity(),gb.shader.uniform_type.mat_m);self.m_screed_quad_mesh.bind(material.shader.attributes);self.m_screed_quad_mesh.draw();self.m_screed_quad_mesh.unbind(material.shader.attributes);gl.colorMask(true,true,true,true);gl.depthMask(true);material_component.unbind(technique_name,technique_pass,material)};draw_light_mask();draw_light();clear_light_mask()}}var children=
entity.children;for(var i=0;i<children.length;++i)this.draw_recursively_lights(children[i],technique_name,technique_pass)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_touches_system",extend:gb.ces_base_system,init:function(){this.m_type=gb.ces_base_system.type.touches_recognize;this.m_events=[];this.m_captured_entities=[]},release:function(){},methods:{on_feed_start:function(){},on_feed:function(root){while(this.m_events.length!==0){var event=this.m_events.pop();var intersected_entity=this.intersected_entity(root,event.state,event.point);if(event.state===gb.input_context.state.released){var captured_entities_count=this.m_captured_entities.length;
for(var i=0;i<captured_entities_count;++i){var captured_entity=this.m_captured_entities[i];var touch_recognize_component=captured_entity.get_component(gb.ces_base_component.type.touch_recognize);var callbacks=touch_recognize_component.get_callbacks(event.state);var callbacks_count=callbacks.length;for(var j=0;j<callbacks_count;++j){var callback=callbacks[j].callback;callback(captured_entity,event.state,event.point,callbacks[j].userdata)}}this.m_captured_entities=[]}if(intersected_entity){if(event.state===
gb.input_context.state.pressed){var index=this.m_captured_entities.findIndex(function(analized_entity){return analized_entity===intersected_entity});if(index===-1)this.m_captured_entities.push(intersected_entity)}var touch_recognize_component=intersected_entity.get_component(gb.ces_base_component.type.touch_recognize);var callbacks=touch_recognize_component.get_callbacks(event.state);var callbacks_count=callbacks.length;for(var i=0;i<callbacks_count;++i){var callback=callbacks[i].callback;var index=
this.m_captured_entities.findIndex(function(analized_entity){return analized_entity===intersected_entity});if(index!==-1)callback(intersected_entity,event.state,event.point,callbacks[i].userdata)}}if(event.state===gb.input_context.state.dragged){var captured_entities_count=this.m_captured_entities.length;for(var i=0;i<captured_entities_count;++i){var captured_entity=this.m_captured_entities[i];var touch_recognize_component=captured_entity.get_component(gb.ces_base_component.type.touch_recognize);
var callbacks=touch_recognize_component.get_callbacks(event.state);var callbacks_count=callbacks.length;for(var j=0;j<callbacks_count;++j){var callback=callbacks[j].callback;callback(captured_entity,event.state,event.point,callbacks[j].userdata)}}}}},on_feed_end:function(){},intersected_entity:function(entity,state,point){var intersected_entity=null;var children=entity.children;var children_count=children.length;var child=null;for(var i=0;i<children_count;++i){child=children[i];var intersected_child_entity=
this.intersected_entity(child,state,point);if(intersected_child_entity)intersected_entity=intersected_child_entity}var touch_recognize_component=entity.get_component(gb.ces_base_component.type.touch_recognize);if(touch_recognize_component&&!intersected_entity&&touch_recognize_component.is_respond_to(state)&&entity.visible){var scene_component=entity.get_component(gb.ces_base_component.type.scene);var matrix_m=gb.ces_transformation_component.get_absolute_transformation(entity,false);matrix_m=gb.mat4.multiply(matrix_m,
scene_component.camera.matrix_v);var min_bound=gb.mat4.multiply_vec2(touch_recognize_component.min_bound,matrix_m);var max_bound=gb.mat4.multiply_vec2(touch_recognize_component.max_bound,matrix_m);if(gb.math.intersect_min_max_bound(min_bound,max_bound,point))intersected_entity=entity}return intersected_entity},on_mouse_pressed:function(point){this.m_events.push({state:gb.input_context.state.pressed,point:point})},on_mouse_released:function(point){this.m_events.push({state:gb.input_context.state.released,
point:point})},on_mouse_moved:function(point,delta){this.m_events.push({state:gb.input_context.state.moved,point:point})},on_mouse_dragged:function(point,delta){this.m_events.push({state:gb.input_context.state.dragged,point:point})}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_animation_system",extend:gb.ces_base_system,init:function(){this.m_type=gb.ces_base_system.type.animation},release:function(){},methods:{on_feed_start:function(){},on_feed:function(root,deltatime){this.update_recursively(root,deltatime)},on_feed_end:function(){},update_recursively:function(entity,deltatime){var geometry_component=entity.get_component(gb.ces_base_component.type.geometry);var animation_component=entity.get_component(gb.ces_base_component.type.animation);
var material_component=entity.get_component(gb.ces_base_component.type.material);if(geometry_component&&animation_component&&material_component){animation_component.current_switch_frame_deltatime-=deltatime;if(animation_component.current_switch_frame_deltatime<0){var frames=animation_component.frames;var frames_count=frames.length;var current_frame=(animation_component.current_frame+1)%frames_count;animation_component.current_switch_frame_deltatime=animation_component.switch_frame_deltatime;if(frames){animation_component.current_frame=
current_frame;var frame=frames[animation_component.current_frame];material_component.swap_texture_to_active(frame.t_name);geometry_component.update_mesh_texcoord_attributes(frame.u_0,frame.v_0,frame.u_1,frame.v_1)}}}var children=entity.children;for(var i=0;i<children.length;++i)this.update_recursively(children[i],deltatime)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_box2d_system",extend:gb.ces_base_system,init:function(){this.m_type=gb.ces_base_system.type.box2d},release:function(){},methods:{on_feed_start:function(){},on_feed:function(root,deltatime){var box2d_world_component=root.get_component(gb.ces_base_component.type.box2d_world);if(box2d_world_component){box2d_world_component.box2d_world.Step(deltatime,1,1);this.update_recursively(root)}},on_feed_end:function(){},update_recursively:function(entity){var box2d_body_component=
entity.get_component(gb.ces_base_component.type.box2d_body);if(box2d_body_component){var new_position=new gb.vec2(box2d_body_component.box2d_body.GetPosition().get_x(),box2d_body_component.box2d_body.GetPosition().get_y());box2d_body_component.on_position_changed(new_position);box2d_body_component.on_rotation_changed(box2d_body_component.box2d_body.GetAngle());var transformation_component=entity.get_component(gb.ces_base_component.type.transformation);transformation_component.position=box2d_body_component.position}var children=
entity.children;for(var i=0;i<children.length;++i)this.update_recursively(children[i])}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_action_system",extend:gb.ces_base_system,init:function(){this.m_type=gb.ces_base_system.type.action},release:function(){},methods:{on_feed_start:function(){},on_feed:function(root,deltatime){this.update_recursively(root,deltatime)},on_feed_end:function(){},update_recursively:function(entity,deltatime){var action_component=entity.get_component(gb.ces_base_component.type.action);if(action_component&&action_component.action)action_component.action(entity,deltatime);
var children=entity.children;for(var i=0;i<children.length;++i)this.update_recursively(children[i],deltatime)}},static_methods:{}});oop.define_class({namespace:"gb",name:"ces_systems_feeder",init:function(){this.m_systems=[];this.m_root=null;Object.defineProperty(this,"root",{set:function(value){this.m_root=value}})},release:function(){},methods:{on_update:function(deltatime){for(var i=0;i<this.m_systems.length;++i){var system=this.m_systems[i];system.on_feed_start(deltatime)}for(var i=0;i<this.m_systems.length;++i){var system=this.m_systems[i];system.on_feed(this.m_root,deltatime)}for(var i=0;i<this.m_systems.length;++i){var system=
this.m_systems[i];system.on_feed_end(deltatime)}},add_system:function(system){this.remove_system(system.type);this.m_systems.push(system);this.m_systems.sort(function(system_01,system_02){return system_01.priority-system_02.priority})},remove_system:function(type){var index=this.m_systems.findIndex(function(system){return system.type===type});if(index!==-1)this.m_systems.splice(index,1)},remove_systems:function(){this.m_systems=[]},deallock_systems:function(){var systems_count=this.m_systems.length;
for(var i=0;i<systems_count;++i){var system=this.m_systems[i];system.release()}this.remove_systems()},get_system:function(type){var system=null;var index=this.m_systems.findIndex(function(system){return system.type===type});if(index!==-1)system=this.m_systems[index];return system}},static_methods:{}});oop.define_class({namespace:"gb",name:"camera",init:function(width,height){this.m_screen_width=width;this.m_screen_height=height;this.m_position=new gb.vec2(0);this.m_rotation=0;this.m_scale=new gb.vec2(1);this.m_matrix_t=(new gb.mat4).identity();this.m_matrix_r=(new gb.mat4).identity();this.m_matrix_s=(new gb.mat4).identity();this.m_matrix_v=(new gb.mat4).identity();this.m_matrix_p=(new gb.mat4).ortho(0,width,height,0,-1,1);this.m_is_matrix_m_computed=false;Object.defineProperty(this,"position",
{set:function(value){this.m_position=value;this.m_matrix_t.translate(this.m_position.x,this.m_position.y,0);this.m_is_matrix_m_computed=false},get:function(){return this.m_position}});Object.defineProperty(this,"rotation",{set:function(value){this.m_rotation=value;this.m_matrix_r.rotate_z(this.m_rotation);this.m_is_matrix_m_computed=false},get:function(){return this.m_rotation}});Object.defineProperty(this,"zoom",{set:function(value){this.m_scale=value;this.m_matrix_s.scale(this.m_scale.x,this.m_scale.y,
1);this.m_is_matrix_m_computed=false},get:function(){return this.m_scale}});Object.defineProperty(this,"matrix_v",{get:function(){if(!this.m_is_matrix_m_computed)this.m_matrix_v=gb.mat4.multiply(gb.mat4.multiply(this.m_matrix_t,this.m_matrix_r),this.m_matrix_s);return this.m_matrix_v}});Object.defineProperty(this,"matrix_p",{get:function(){return this.m_matrix_p}});this.position=new gb.vec2(0);this.rotation=0;this.zoom=new gb.vec2(1)},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"game_object",extend:gb.ces_entity,init:function(){var transformation_component=new gb.ces_transformation_component;this.add_component(transformation_component);Object.defineProperty(this,"position",{configurable:true,set:function(value){this.get_component(gb.ces_base_component.type.transformation).position=value},get:function(){return this.get_component(gb.ces_base_component.type.transformation).position}});Object.defineProperty(this,"rotation",{set:function(value){this.get_component(gb.ces_base_component.type.transformation).rotation=
value},get:function(){return this.get_component(gb.ces_base_component.type.transformation).rotation}});Object.defineProperty(this,"scale",{set:function(value){this.get_component(gb.ces_base_component.type.transformation).scale=value},get:function(){return this.get_component(gb.ces_base_component.type.transformation).scale}});Object.defineProperty(this,"size",{configurable:true,set:function(value){this.get_component(gb.ces_base_component.type.transformation).scale=value},get:function(){return this.get_component(gb.ces_base_component.type.transformation).scale}});
this.m_bound=new gb.vec4(0);Object.defineProperty(this,"bound",{configurable:true,get:function(){return this.m_bound}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"scene_graph",extend:gb.ces_entity,init:function(transition){this.m_camera=null;this.m_fabricator=null;this.m_transition=transition;var transformation_component=new gb.ces_transformation_component;this.add_component(transformation_component);var scene_component=new gb.ces_scene_component;scene_component.scene=this;this.add_component(scene_component);Object.defineProperty(this,"camera",{set:function(value){this.m_camera=value},get:function(){return this.m_camera}});
Object.defineProperty(this,"fabricator",{set:function(value){this.m_fabricator=value},get:function(){return this.m_fabricator}});Object.defineProperty(this,"transition",{get:function(){return this.m_transition}})},release:function(){},methods:{set_box2d_world:function(min_bound,max_bound){var box2d_world_component=this.get_component(gb.ces_base_component.type.box2d_world);if(!box2d_world_component){box2d_world_component=new gb.ces_box2d_world_component;this.add_component(box2d_world_component)}box2d_world_component.set_bounds(min_bound,
max_bound)},add_box2d_body:function(entity){var box2d_world_component=this.get_component(gb.ces_base_component.type.box2d_world);var box2d_body_component=entity.get_component(gb.ces_base_component.type.box2d_body);if(box2d_world_component&&!box2d_body_component){box2d_body_component=new gb.ces_box2d_body_component;var transformation_component=entity.get_component(gb.ces_base_component.type.transformation);var box2d_definition=box2d_body_component.box2d_definition;box2d_definition.set_type(Box2D.b2_dynamicBody);
box2d_definition.set_position(new Box2D.b2Vec2(transformation_component.position.x+entity.size.x*.5,transformation_component.position.y+entity.size.y*.5));box2d_definition.userData=entity;var box2d_shape=new Box2D.b2PolygonShape;var vertices=[];vertices.push(new Box2D.b2Vec2(0,0));vertices.push(new Box2D.b2Vec2(entity.size.x,0));vertices.push(new Box2D.b2Vec2(entity.size.x,entity.size.y));vertices.push(new Box2D.b2Vec2(0,entity.size.y));box2d_shape.SetAsBox(entity.size.x*.5,entity.size.y*.5);var box2d_body=
box2d_world_component.box2d_world.CreateBody(box2d_body_component.box2d_definition);box2d_body.CreateFixture(box2d_shape,1);box2d_body_component.box2d_body=box2d_body;entity.add_component(box2d_body_component)}},remove_box2d_body:function(entity){var box2d_world_component=this.get_component(gb.ces_base_component.type.box2d_world);var box2d_body_component=entity.get_component(gb.ces_base_component.type.box2d_body);if(box2d_world_component&&box2d_body_component){box2d_world_component.box2d_world.DestroyBody(box2d_body_component.box2d_body);
entity.remove_component(gb.ces_base_component.type.box2d_body)}}},static_methods:{}});oop.define_class({namespace:"gb",name:"light_source",extend:gb.game_object,constants:{radius_uniform:"u_radius",center_uniform:"u_center",color_uniform:"u_color"},init:function(){var material_component=new gb.ces_material_component;this.add_component(material_component);var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();this.add_component(geometry_component);var light_component=new gb.ces_light_component;this.add_component(light_component);
var light_mask_component=new gb.ces_light_mask_component;this.add_component(light_mask_component);this.m_radius=1;this.m_color=new gb.vec4(0);Object.defineProperty(this,"radius",{get:function(){return this.m_radius},set:function(value){this.m_radius=value;this.get_component(gb.ces_base_component.type.transformation).scale=new gb.vec2(this.m_radius);this.get_component(gb.ces_base_component.type.material).set_custom_shader_uniform(this.m_radius,gb.light_source.radius_uniform)}});Object.defineProperty(this,
"color",{get:function(){return this.m_color},set:function(value){this.m_color=value;this.get_component(gb.ces_base_component.type.material).set_custom_shader_uniform(this.m_color,gb.light_source.color_uniform)}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"sprite",extend:gb.game_object,init:function(){var material_component=new gb.ces_material_component;this.add_component(material_component);var geometry_component=new gb.ces_geometry_quad_component;this.add_component(geometry_component);Object.defineProperty(this,"size",{get:function(){var geometry_component=this.get_component(gb.ces_base_component.type.geometry);if(geometry_component instanceof gb.ces_geometry_quad_component)return geometry_component.size;else{var transformation_component=
this.get_component(gb.ces_base_component.type.transformation);return transformation_component.scale}},set:function(value){var geometry_component=this.get_component(gb.ces_base_component.type.geometry);if(geometry_component instanceof gb.ces_geometry_quad_component)geometry_component.size=value;else{var transformation_component=this.get_component(gb.ces_base_component.type.transformation);transformation_component.scale=value}var touch_recognize_component=this.get_component(gb.ces_base_component.type.touch_recognize);
if(touch_recognize_component){var bound=new gb.vec4(-value.x*(1-geometry_component.pivot.x),-value.y*(1-geometry_component.pivot.y),value.x*geometry_component.pivot.x,value.y*geometry_component.pivot.y);touch_recognize_component.bound=bound}}});Object.defineProperty(this,"pivot",{get:function(){var geometry_component=this.get_component(gb.ces_base_component.type.geometry);return geometry_component.pivot},set:function(value){var geometry_component=this.get_component(gb.ces_base_component.type.geometry);
geometry_component.pivot=value}});Object.defineProperty(this,"cast_shadow",{get:function(){return this.is_component_exist(gb.ces_base_component.type.convex_hull)},set:function(value){if(value){var geometry_component=this.get_component(gb.ces_base_component.type.geometry);var convex_hull_component=new gb.ces_convex_hull_component;convex_hull_component.generate_convex_hull(geometry_component.mesh.vbo.to_vertices_positions());this.add_component(convex_hull_component)}else this.remove_component(gb.ces_base_component.type.convex_hull)}});
Object.defineProperty(this,"is_touchable",{get:function(){if(this.get_component(gb.ces_base_component.type.touch_recognize))return true;else return false},set:function(value){if(value){if(!this.get_component(gb.ces_base_component.type.touch_recognize)){var touch_recognize_component=new gb.ces_touch_recognize_component;var size=this.size;touch_recognize_component.bound=new gb.vec4(0,0,size.x,size.y);touch_recognize_component.enable(gb.input_context.state.pressed,true);touch_recognize_component.enable(gb.input_context.state.released,
true);touch_recognize_component.enable(gb.input_context.state.dragged,true);this.add_component(touch_recognize_component)}}else this.remove_component(gb.ces_base_component.type.touch_recognize)}});Object.defineProperty(this,"bound",{configurable:true,get:function(){this.m_bound.x=0;this.m_bound.y=0;this.m_bound.z=0;this.m_bound.w=0;var geometry_component=this.get_component(gb.ces_base_component.type.geometry);if(geometry_component.mesh){var transformation_component=this.get_component(gb.ces_base_component.type.transformation);
var min_bound=gb.mat4.multiply_vec2(geometry_component.mesh.vbo.min_bound,transformation_component.matrix_m);var max_bound=gb.mat4.multiply_vec2(geometry_component.mesh.vbo.max_bound,transformation_component.matrix_m);min_bound.sub(transformation_component.position);max_bound.sub(transformation_component.position);this.m_bound.x=min_bound.x;this.m_bound.y=min_bound.y;this.m_bound.z=max_bound.x;this.m_bound.w=max_bound.y}return this.m_bound}})},release:function(){},methods:{set_animations_configuration:function(animations_configuration){var animation_component=
this.get_component(gb.ces_base_component.type.animation);if(!animation_component){animation_component=new gb.ces_animation_component;this.add_component(animation_component)}animation_component.set_animations_configuration(animations_configuration)},play_animation:function(animation_name){var animation_component=this.get_component(gb.ces_base_component.type.animation);if(animation_component)animation_component.current_animation=animation_name}},static_methods:{}});oop.define_class({namespace:"gb",name:"grid",extend:gb.game_object,constants:{color_uniform:"u_color"},init:function(){var material_component=new gb.ces_material_component;this.add_component(material_component);var geometry_component=new gb.ces_geometry_freeform_component;this.add_component(geometry_component);this.m_color=new gb.vec4(0,1,0,1);Object.defineProperty(this,"color",{get:function(){return this.m_color},set:function(value){this.m_color=value;this.get_component(gb.ces_base_component.type.material).set_custom_shader_uniform(this.m_color,
gb.grid.color_uniform)}});Object.defineProperty(this,"bound",{configurable:true,get:function(){this.m_bound.x=0;this.m_bound.y=0;this.m_bound.z=0;this.m_bound.w=0;var geometry_component=this.get_component(gb.ces_base_component.type.geometry);if(geometry_component.mesh){var transformation_component=this.get_component(gb.ces_base_component.type.transformation);var min_bound=gb.mat4.multiply_vec2(geometry_component.mesh.vbo.min_bound,transformation_component.matrix_m);var max_bound=gb.mat4.multiply_vec2(geometry_component.mesh.vbo.max_bound,
transformation_component.matrix_m);min_bound.sub(transformation_component.position);max_bound.sub(transformation_component.position);this.m_bound.x=min_bound.x;this.m_bound.y=min_bound.y;this.m_bound.z=max_bound.x;this.m_bound.w=max_bound.y}return this.m_bound}})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"scene_fabricator",init:function(){this.m_game_objects=[];this.m_configurations_accessor=null;this.m_resources_accessor=null;Object.defineProperty(this,"configurations_accessor",{set:function(value){this.m_configurations_accessor=value},get:function(){return this.m_configurations_accessor}});Object.defineProperty(this,"resources_accessor",{set:function(value){this.m_resources_accessor=value},get:function(){return this.m_resources_accessor}})},release:function(){},
methods:{add_materials:function(game_object,configurations){for(var i=0;i<configurations.length;++i){var material_configuration=configurations[i];var material=gb.material.construct(material_configuration);gb.material.set_shader(material,material_configuration,this.m_resources_accessor);gb.material.set_textures(material,material_configuration,this.m_resources_accessor);gb.ces_material_component.add_material(game_object,material_configuration.technique_name,material_configuration.technique_pass,material)}},
create_sprite:function(filename,callback){var sprite=new gb.sprite;this.m_game_objects.push(sprite);var self=this;this.m_configurations_accessor.get_sprite_configuration(filename,function(configuration){self.add_materials(sprite,configuration.materials_configurations);if(callback)callback(sprite)});return sprite},create_light_source:function(filename,callback){var light_source=new gb.light_source;this.m_game_objects.push(light_source);var self=this;this.m_configurations_accessor.get_sprite_configuration(filename,
function(configuration){self.add_materials(light_source,configuration.materials_configurations);if(callback)callback()});return light_source},create_grid:function(filename,num_rows,num_columns,rows_gap,columns_gap,callback){var grid=new gb.grid;this.m_game_objects.push(grid);var geometry_component=grid.get_component(gb.ces_base_component.type.geometry);geometry_component.mesh=gb.mesh_constructor.create_grid(num_rows,num_columns,rows_gap,columns_gap);var bound=grid.bound;var vertices=[];vertices.push(new gb.vec2(bound.x,
bound.y));vertices.push(new gb.vec2(bound.z,bound.y));vertices.push(new gb.vec2(bound.z,bound.w));vertices.push(new gb.vec2(bound.x,bound.w));var convex_hull_component=new gb.ces_convex_hull_component;convex_hull_component.generate_convex_hull(vertices);grid.add_component(convex_hull_component);var self=this;this.m_configurations_accessor.get_sprite_configuration(filename,function(configuration){self.add_materials(grid,configuration.materials_configurations);if(callback)callback()});return grid}},
static_methods:{}});oop.define_class({namespace:"gb",name:"game_loop",init:function(){this.m_listeners=[];this.m_previous_timestamp=Date.now()},release:function(){},methods:{on_update:function(){var current_timestamp=Date.now();var deltatime=(current_timestamp-this.m_previous_timestamp)/1E3;var listeners_count=this.m_listeners.length;var listener=null;for(var i=0;i<listeners_count;++i){listener=this.m_listeners[i];listener.on_update(deltatime)}this.m_previous_timestamp=current_timestamp},add_listener:function(listener){if(_.isFunction(listener.on_update))if(!_.contains(this.m_listeners,
listener))this.m_listeners.push(listener);else console.error("can't add same listener for game loop");else console.error("game loop listener doesn't contain on_update method")},remove_listener:function(listener){var index=_.indexOf(this.m_listeners,listener);if(index!==-1)this.m_listeners.splice(index,1);else console.error("game loop doesn't contain this listener")}},static_methods:{}});var g_game_loop=null;
var game_loop=function(window){function on_update(){g_game_loop.on_update();g_game_loop.attach_to_runloop()(on_update)}function init(){g_game_loop=new gb.game_loop;g_game_loop.attach_to_runloop=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1E3/60)}};return g_game_loop}return{get_instance:function(){if(!g_game_loop){g_game_loop=
init();on_update()}return g_game_loop}}}(window);var loop=function(){return game_loop.get_instance()}();oop.define_class({namespace:"gb",name:"game_transition",init:function(guid){this.m_guid=guid;this.m_configurations_accessor=null;this.m_resources_accessor=null;this.m_systems_feeder=new gb.ces_systems_feeder;this.m_input_context=null;this.m_scene=null;Object.defineProperty(this,"guid",{get:function(){return this.m_guid}})},release:function(){},methods:{on_activated:function(input_context,configurations_accessor,resources_accessor,callback){this.m_input_context=input_context;this.m_configurations_accessor=
configurations_accessor;this.m_resources_accessor=resources_accessor;var render_system=new gb.ces_render_system;var render_pipeline=render_system.render_pipeline;var self=this;this.m_configurations_accessor.get_transition_configuration(this.m_guid,function(transition_configuration){if(transition_configuration.ws_techniques_configurations!==null)for(var i=0;i<transition_configuration.ws_techniques_configurations.length;++i){var ws_technique_configuration=transition_configuration.ws_techniques_configurations[i];
var screen_width=Math.min(gl.viewport_width,ws_technique_configuration.screen_width);var screen_height=Math.min(gl.viewport_height,ws_technique_configuration.screen_height);var render_technique_ws=new gb.render_technique_ws(screen_width,screen_height,ws_technique_configuration.technique_name,ws_technique_configuration.index,ws_technique_configuration.num_passes);var clear_color=new gb.vec4(ws_technique_configuration.clear_color_r,ws_technique_configuration.clear_color_g,ws_technique_configuration.clear_color_b,
ws_technique_configuration.clear_color_a);render_technique_ws.clear_color=clear_color;render_pipeline.add_ws_render_technique(ws_technique_configuration.technique_name,ws_technique_configuration.index,render_technique_ws);self.m_resources_accessor.add_custom_resource(ws_technique_configuration.technique_name+".color",render_technique_ws.color_attachment_texture);self.m_resources_accessor.add_custom_resource(ws_technique_configuration.technique_name+".depth",render_technique_ws.depth_attachment_texture)}if(transition_configuration.ss_techniques_configurations!==
null)for(var i=0;i<transition_configuration.ss_techniques_configurations.length;++i){var ss_technique_configuration=transition_configuration.ss_techniques_configurations[i];var material_configuration=ss_technique_configuration.material_configuration;var material=gb.material.construct(material_configuration);gb.material.set_shader(material,material_configuration,self.m_resources_accessor);gb.material.set_textures(material,material_configuration,self.m_resources_accessor);var screen_width=Math.min(gl.viewport_width,
ss_technique_configuration.screen_width);var screen_height=Math.min(gl.viewport_height,ss_technique_configuration.screen_height);var render_technique_ss=new gb.render_technique_ss(screen_width,screen_height,ss_technique_configuration.technique_name,0,material);render_pipeline.add_ss_render_technique(ss_technique_configuration.technique_name,render_technique_ss);self.m_resources_accessor.add_custom_resource(ss_technique_configuration.technique_name+".color",render_technique_ss.color_attachment_texture)}var main_technique_configuration=
transition_configuration.main_technique_configuration;var material_configuration=main_technique_configuration.material_configuration;var material=gb.material.construct(material_configuration);gb.material.set_shader(material,material_configuration,self.m_resources_accessor);gb.material.set_textures(material,material_configuration,self.m_resources_accessor);render_pipeline.create_main_render_technique(material);var scene_fabricator=new gb.scene_fabricator;scene_fabricator.configurations_accessor=self.m_configurations_accessor;
scene_fabricator.resources_accessor=self.m_resources_accessor;self.m_scene=new gb.scene_graph(self);self.m_scene.fabricator=scene_fabricator;callback(self.m_scene);self.m_systems_feeder.root=self.m_scene;self.m_systems_feeder.add_system(render_system);var deferred_lighting_system=new gb.ces_deferred_lighting_system;self.m_systems_feeder.add_system(deferred_lighting_system);var animation_system=new gb.ces_animation_system;self.m_systems_feeder.add_system(animation_system);var touches_recognize_system=
new gb.ces_touches_system;self.m_input_context.add_listener(touches_recognize_system);self.m_systems_feeder.add_system(touches_recognize_system);var box2d_system=new gb.ces_box2d_system;self.m_systems_feeder.add_system(box2d_system);var action_system=new gb.ces_action_system;self.m_systems_feeder.add_system(action_system);loop.add_listener(self.m_systems_feeder)})},on_deactivated:function(){var touches_recognize_system=this.m_systems_feeder.get_system(gb.ces_base_system.type.touches_recognize);this.m_input_context.remove_listener(touches_recognize_system);
this.m_systems_feeder.deallock_systems();loop.remove_listener(this.m_systems_feeder)},get_ws_technique_result_as_image:function(technique_name,technique_index,image_width,image_height){var render_system=this.m_systems_feeder.get_system(gb.ces_base_system.type.render);return render_system.render_pipeline.get_ws_technique_result_as_image(technique_name,technique_index,image_width,image_height)}},static_methods:{}});var g_game_controller=null;
oop.define_class({namespace:"gb",name:"game_controller",init:function(){this.m_current_transition=null;this.m_transitions=[];this.resource_accessor=new gb.resource_accessor;this.configuration_accessor=new gb.configuration_accessor;this.m_input_context=new gb.input_context},release:function(){},methods:{add_transition:function(transition){var index=this.m_transitions.findIndex(function(analized_transition){return analized_transition.guid===transition.guid});if(index===-1)this.m_transitions.push(transition);else console.warn("can't add same transition")},
remove_transition:function(transition){var index=this.m_transitions.findIndex(function(analized_transition){return analized_transition.guid===transition.guid});if(index!==-1)this.m_transitions.splice(index,1)},goto_transition:function(guid,callback){var index=this.m_transitions.findIndex(function(analized_transition){return analized_transition.guid===guid});if(index!==-1){if(this.m_current_transition)this.m_current_transition.on_deactivated();this.m_current_transition=this.m_transitions[index];this.m_current_transition.on_activated(this.m_input_context,
this.configuration_accessor,this.resource_accessor,callback)}}},static_methods:{get_instance:function(){if(!g_game_controller)g_game_controller=new gb.game_controller;return g_game_controller}}});oop.define_class({namespace:"gb",name:"max_rects_pack_algorithm",constants:{heuristic:{none:0,TL:1,BAF:2,BSSF:3,BLSF:4,MINW:5,MINH:6}},init:function(){this.m_free_nodes_container=[];this.m_occupied_nodes_container=[];this.m_heuristic=0;Object.defineProperty(this,"heuristic",{get:function(){return this.m_heuristic},set:function(value){this.m_heuristic=value}});this.m_atlas_width=0;Object.defineProperty(this,"atlas_width",{get:function(){return this.m_atlas_width},set:function(value){this.m_atlas_width=
value}});this.m_atlas_height=0;Object.defineProperty(this,"atlas_height",{get:function(){return this.m_atlas_height},set:function(value){this.m_atlas_height=value}});this.m_is_rotation_enabled=false;Object.defineProperty(this,"is_rotation_enabled",{get:function(){return this.m_is_rotation_enabled},set:function(value){this.m_is_rotation_enabled=value}})},release:function(){},methods:{add_sprite:function(sprite,page){if(!page){console.warn("atlas page undefined");page=0}console.warn("try to add sprite in atlas page: "+
page);if(!this.m_free_nodes_container[page]){this.m_free_nodes_container[page]=[];this.m_free_nodes_container[page].push(new gb.vec4(0,0,this.m_atlas_width,this.m_atlas_height));console.warn("new atlas page created with index: "+page)}var free_nodes_container=this.m_free_nodes_container[page];if(!this.m_occupied_nodes_container[page])this.m_occupied_nodes_container[page]=[];var occupied_nodes_container=this.m_occupied_nodes_container[page];var left_neighbor=false;var right_neighbor=false;var current_left_neighbor=
false;var current_right_neighbor=false;var rotated=false;var best_is_rotated=false;var offset=0;var min_offset=this.m_atlas_width*this.m_atlas_height+1;var current_free_node_index=-1;var heuristic=gb.max_rects_pack_algorithm.heuristic;var free_nodes_count=free_nodes_container.length;for(var i=0;i<free_nodes_count;++i){var free_node=free_nodes_container[i];if(free_node.z>=sprite.size.x&&free_node.w>=sprite.size.y||free_node.z>=sprite.size.y&&free_node.w>=sprite.size.x){rotated=false;offset=0;if(free_node.z>=
sprite.size.y&&free_node.w>=sprite.size.x&&!(free_node.z>=sprite.size.x&&free_node.w>=sprite.size.y)){if(!this.m_is_rotation_enabled)continue;rotated=true;offset+=sprite.size.y;console.error("implement sprite rotation")}switch(this.m_heuristic){case heuristic.none:current_free_node_index=i;i=free_nodes_count;continue;case heuristic.TL:offset+=free_node.y;current_left_neighbor=false;current_right_neighbor=false;var occupied_nodes_count=occupied_nodes_container.length;for(var j=0;j<occupied_nodes_count;++j){var occupied_node=
occupied_nodes_container[j];if(Math.abs(occupied_node.y+occupied_node.w/2-free_node.y-free_node.w/2)<Math.max(occupied_node.w,free_node.w)/2){if(occupied_node.x+occupied_node.z===free_node.x){offset-=5;current_left_neighbor=true}if(occupied_node.x===free_node.x+free_node.z){offset-=5;current_right_neighbor=true}}}if(current_left_neighbor||!current_right_neighbor){if(free_node.x+free_node.z===this.m_atlas_width){offset-=1;current_right_neighbor=true}if(free_node.x===0){offset-=1;current_left_neighbor=
true}}break;case heuristic.BAF:offset+=free_node.z*free_node.w;break;case heuristic.BSSF:offset+=Math.min(free_node.z-sprite.size.x,free_node.w-sprite.size.y);break;case heuristic.BLSF:offset+=Math.max(free_node.z-sprite.size.x,free_node.w-sprite.size.y);break;case heuristic.MINW:offset+=free_node.z;break;case heuristic.MINH:offset+=free_node.w;break}if(offset<min_offset){min_offset=offset;current_free_node_index=i;left_neighbor=current_left_neighbor;right_neighbor=current_right_neighbor;best_is_rotated=
rotated}if(rotated)console.error("implement sprite rotation")}}if(best_is_rotated)console.error("implement sprite rotation");if(current_free_node_index>=0){i=current_free_node_index;var free_node=free_nodes_container[current_free_node_index];var current_free_node=new gb.vec4(free_node.x,free_node.y,sprite.size.x,sprite.size.y);if(this.m_heuristic===heuristic.TL){if(!left_neighbor&&free_node.x!==0&&free_node.z+free_node.x===this.m_atlas_width){current_free_node.x=this.m_atlas_width-sprite.size.x;current_free_node.y=
free_node.y;current_free_node.z=sprite.size.x;current_free_node.w=sprite.size.y}if(!left_neighbor&&right_neighbor){current_free_node.x=free_node.x+free_node.z-sprite.size.x;current_free_node.y=free_node.y;current_free_node.z=sprite.size.x;current_free_node.w=sprite.size.y}}occupied_nodes_container.push(new gb.vec4(current_free_node));if(free_node.z>sprite.size.x){var node=new gb.vec4;node.x=free_node.x+(current_free_node.x===free_node.x?sprite.size.x:0);node.y=free_node.y;node.z=free_node.z-sprite.size.x;
node.w=free_node.w;free_nodes_container.push(node)}if(free_node.w>sprite.size.y){var node=new gb.vec4;node.x=free_node.x;node.y=free_node.y+sprite.size.y;node.z=free_node.z;node.w=free_node.w-sprite.size.y;free_nodes_container.push(node)}free_nodes_container.splice(i,1);for(var i=0;i<free_nodes_container.length;++i){var free_node=free_nodes_container[i];if(gb.math.rect_intersect(free_node,current_free_node)){if(current_free_node.x+current_free_node.z<free_node.x+free_node.z){var node=new gb.vec4;
node.x=current_free_node.x+current_free_node.z;node.y=free_node.y;node.z=free_node.x+free_node.z-current_free_node.x-current_free_node.z;node.w=free_node.w;free_nodes_container.push(node)}if(current_free_node.y+current_free_node.w<free_node.y+free_node.w){var node=new gb.vec4;node.x=free_node.x;node.y=current_free_node.y+current_free_node.w;node.z=free_node.z;node.w=free_node.y+free_node.w-current_free_node.y-current_free_node.w;free_nodes_container.push(node)}if(current_free_node.x>free_node.x){var node=
new gb.vec4;node.x=free_node.x;node.y=free_node.y;node.z=current_free_node.x-free_node.x;node.w=free_node.w;free_nodes_container.push(node)}if(current_free_node.y>free_node.y){var node=new gb.vec4;node.x=free_node.x;node.y=free_node.y;node.z=free_node.z;node.w=current_free_node.y-free_node.y;free_nodes_container.push(node)}free_nodes_container.splice(i,1);--i}}for(var i=0;i<free_nodes_container.length;i++)for(var j=i+1;j<free_nodes_container.length;j++){var free_node_i=free_nodes_container[i];var free_node_j=
free_nodes_container[i];if(i!=j&&gb.math.rect_contains(free_node_i,free_node_j)){free_nodes_container.splice(j,1);--j}}return{"position":new gb.vec2(current_free_node.x,current_free_node.y),"page":page}}else{var next_page=page+1;return this.add_sprite(sprite,next_page)}},reset:function(){this.m_free_nodes_container=[];this.m_occupied_nodes_container=[]}},static_methods:{}});oop.define_class({namespace:"gb",name:"common_alert_view",init:function(container,ui,ui_j){$(ui_j(container)).append("<div id="+ui.common_alert_view+' class="ui-state-error ui-corner-all" style="padding: 0 .7em; background:darkorange;">'+"<p>"+'<span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>'+"<strong>Warning: </strong>"+"<div id="+ui.common_alert_view_textfield+' style="margin-top: -10.5%; margin-left: 30%;"></div>'+"</p>"+"</div>");$(ui_j(ui.common_alert_view)).dialog({autoOpen:false,
width:390,height:140,modal:false,show:{effect:"bounce",duration:1E3},hide:{effect:"clip",duration:250},open:function(event,element){setTimeout(function(){$(ui_j(ui.common_alert_view)).dialog("close")},2E3)}});$(ui_j(ui.common_alert_view)).siblings("div.ui-dialog-titlebar").remove()},release:function(){},methods:{show:function(message,ui,ui_j){$(ui_j(ui.common_alert_view_textfield)).html(message);$(ui_j(ui.common_alert_view)).dialog("open")}},static_methods:{}});oop.define_class({namespace:"gb",name:"common_error_view",init:function(container,ui,ui_j){$(ui_j(container)).append("<div id="+ui.common_error_view+' class="ui-state-error ui-corner-all" style="padding: 0 .7em; background:darkorange;">'+"<p>"+'<span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>'+"<strong>Error: </strong>"+"<div id="+ui.common_error_view_textfield+' style="margin-top: -4%;"></div>'+"</p>"+"</div>");$(ui_j(ui.common_error_view)).dialog({autoOpen:false,
width:450,height:450,modal:true,show:{effect:"bounce",duration:1E3},hide:{effect:"clip",duration:250},buttons:[{text:"Report bug",click:function(){location.reload()}},{text:"Ok",click:function(){location.reload()}}]});$(ui_j(ui.common_error_view)).parent().css({"background":"black"});$(ui_j(ui.common_error_view)).siblings("div.ui-dialog-titlebar").remove()},release:function(){},methods:{show:function(message,ui,ui_j){$(ui_j(ui.common_error_view_textfield)).html(message);$(ui_j(ui.common_error_view)).dialog("open")}},
static_methods:{}});oop.define_class({namespace:"gb",name:"common_progress_view",init:function(container,ui,ui_j){$(ui_j(container)).append("<div id="+ui.common_progress_view+' class="ui-state-error" style="background:darkorange;">'+"<div id="+ui.common_progress_view_bar+' style="height: 30px;"></div>'+"<p>"+'<span class="ui-icon ui-icon-clock" style="float: left; margin-right: .3em;"></span>'+"<div id="+ui.common_progress_view_textfield+"></div>"+"</p>"+"</div>");$(ui_j(ui.common_progress_view_bar)).progressbar({value:false});
$(ui_j(ui.common_progress_view)).dialog({autoOpen:false,width:520,height:120,modal:false,show:{effect:"bounce",duration:1E3},hide:{effect:"clip",duration:250}});$(ui_j(ui.common_progress_view)).siblings("div.ui-dialog-titlebar").remove()},release:function(){},methods:{show:function(ui,ui_j){$(ui_j(ui.common_progress_view)).dialog("open")},hide:function(ui,ui_j){$(ui_j(ui.common_progress_view_bar)).progressbar("value",false);$(ui_j(ui.common_progress_view)).dialog("close")},update_progress:function(message,
value,ui,ui_j){$(ui_j(ui.common_progress_view_textfield)).html(message);$(ui_j(ui.common_progress_view_bar)).progressbar("value",value)}},static_methods:{}});var g_ss_merge_controller=null;var g_ss_merge_transition=null;
oop.define_class({namespace:"gb",name:"ss_merge_controller",constants:{html_elements:{tab_container:"ss-merge-tab-container",tab_left_panel:"ss-merge-tab-left-panel",tab_right_panel:"ss-merge-tab-right-panel",import_container:"ss-merge-import-container",import_size_drop_down_box:"ss-merge-size-drop-down-box",import_size_drop_down_box_button:"ss-merge-size-drop-down-box-button",import_drop_zone:"ss-merge-drop-zone",import_add_image_button:"ss-merge-add_image-button",import_add_image_input:"ss-merge-add_image-input",
frames_container:"ss-merge-frames-container",frames_sort_button:"ss-merge-frames-sort-button",frames_table:"ss-merge-frames-table",frames_table_scroll:"ss-merge-frames-table_scroll",frames_table_cell:"ss-merge-frames-table-cell",frames_table_cell_delete_icon:"ss-merge-frames-table-cell-delete-icon",frames_table_cell_image:"ss-merge-frames-table-cell-image",editing_container:"ss-merge-editing-container",editing_page_drop_down_box:"ss-merge-editing-page-drop-down-box",editing_page_drop_down_box_button:"ss-merge-editing-page-drop-down-box-button",
editing_move_resize_radio_button:"ss-merge-editing-move-resize-radio-button",editing_move_resize_freeform_button:"ss-merge-editing-move-resize-freeform-button",editing_move_resize_snaptogrid_button:"ss-merge-editing-move-resize-snaptogrid-button",editing_pack_algorithm_drop_down_box:"ss-merge-editing-pack-algorithm-drop-down-box",editing_pack_algorithm_drop_down_box_button:"ss-merge-editing-pack-algorithm-drop-down-box-button",editing_spread_button:"ss-merge-editing-spread-button",animations_container:"ss-merge-animations-container",
animations_current_animation_drop_down_box:"ss-merge-animations-current-animation-drop-down-box",animations_current_animation_drop_down_box_button:"ss-merge-animations-current-animation-drop-down-box-button",animations_add_animation_button:"ss-merge-animations-add-animation-button",animations_table:"ss-merge-animations-table",animations_table_scroll:"ss-merge-animations-table-scroll",animations_table_cell:"ss-merge-animations-table-cell",animations_table_cell_animation_name_textfield:"ss-merge-animations-table-cell-animation-name-textfield",
animations_table_cell_frames_label:"ss-merge-animations-table-cell-frames-label",animations_table_cell_frames_slider:"ss-merge-animations-table-cell-frames-slider",animations_table_cell_delete_icon:"ss-merge-animations-table-cell-delete-icon",animations_table_cell_apply_button:"ss-merge-animations-table-cell-apply-button",export_container:"ss-merge-export-container",export_filename_input:"ss-merge-export-filename-input",export_animation_preview_button:"ss-merge-export-animation-preview_button",export_save_images_button:"ss-merge-export-atlas-button",
export_save_pages_table:"ss-merge-export-save-pages-table",export_save_pages_table_scroll:"ss-merge-export-save-pages-table-scroll",export_save_pages_table_cell:"ss-merge-export-save-pages-table-cell",export_save_pages_table_cell_download_button:"ss-merge-export-save-pages-table-cell-download-button",export_save_frames_button:"ss-merge-export-save-frames-button",export_save_frames_textfield:"ss-merge-export_save-frames-textfield",export_save_frames_download_button:"ss-merge-export_save-frames-download-button",
export_animation_preview_dialog:"ss-merge-export-animation-preview-dialog",common_alert_view:"ss-merge-common-alert-view",common_alert_view_textfield:"ss-merge-common-alert-view-textfield",common_error_view:"ss-merge-common-error-view",common_error_view_textfield:"ss-merge-common-error-view-textfield",common_progress_view:"ss-merge-common-progress-view",common_progress_view_bar:"ss-merge-common-progress-view-bar",common_progress_view_textfield:"ss-merge-common-progress-view-textfield"},default_filenames:{page:"page",
configuration:"configuration"}},init:function(){g_ss_merge_controller=this;var ui=gb.ss_merge_controller.ui();var ui_j=gb.ss_merge_controller.ui_j;var self=gb.ss_merge_controller.self();window.onerror=function(message,file,line,column,error){var stack=error?"\n\n"+error.stack:"";self.error_view.show(message+"\n("+file+":"+line+")"+stack,ui,ui_j)};$(ui_j(ui.tab_container)).append($("<div id="+ui.tab_left_panel+' style="background:black; margin-top: 2px;"/>'));$(ui_j(ui.tab_container)).append($("<div id="+
ui.tab_right_panel+' style="background:black; margin-top: 2px;"/>'));$(ui_j(ui.tab_right_panel)).append($('<canvas id="gl_canvas" width="1024" height="1024"></canvas>'));this.m_import_view=new gb.ss_merge_import_view(this,ui,ui_j);this.m_frames_view=new gb.ss_merge_frames_view(this,ui,ui_j);this.m_packer_view=new gb.ss_merge_packer_view(this,ui,ui_j);this.m_animations_view=new gb.ss_merge_animations_view(this,ui,ui_j);this.m_export_view=new gb.ss_merge_export_view(this,ui,ui_j);$(ui_j(ui.tab_container)).tooltip({position:{my:"left top",
at:"left+10 top+10",of:"#gl_canvas"}});$(ui_j(ui.tab_left_panel)).accordion({heightStyle:"content"});$(ui_j(ui.tab_left_panel)).on("accordionbeforeactivate",function(event,element){var index=$(element.newHeader).index("h3");if(index>0&&self.m_sprites.length===0){self.on_show_alert_view("You need to add sprites at first!");return false}return true});var gl_context=new gb.graphics_context;g_ss_merge_transition=new gb.game_transition("data/resources/configurations/transitions/transition.spritesheets.merge.json");
gb.game_controller.get_instance().add_transition(g_ss_merge_transition);this.m_sprites=[];this.m_animations=[];this.m_sprites_on_pages=[];this.m_current_page=0;this.m_importing_images_size=1;this.m_current_animation_name="all frames";this.m_grid=null;this.m_alert_view=new gb.common_alert_view(ui.tab_left_panel,ui,ui_j);this.m_error_view=new gb.common_error_view(ui.tab_left_panel,ui,ui_j);this.m_progress_view=new gb.common_progress_view(ui.tab_left_panel,ui,ui_j);this.m_merge_algorithm=new gb.max_rects_pack_algorithm;
this.m_merge_algorithm.atlas_width=1024;this.m_merge_algorithm.atlas_height=1024;this.m_merge_algorithm.heuristic=gb.max_rects_pack_algorithm.heuristic.TL;this.m_scene=null;this.m_animated_sprite=null;this.m_page_size=1024;this.m_export_image_filename=gb.ss_merge_controller.default_filenames.page;this.m_export_configuration_filename=gb.ss_merge_controller.default_filenames.configuration;Object.defineProperty(this,"import_view",{get:function(){return this.m_import_view}});Object.defineProperty(this,
"frames_view",{get:function(){return this.m_frames_view}});Object.defineProperty(this,"animation_view",{get:function(){return this.m_animations_view}});Object.defineProperty(this,"export_view",{get:function(){return this.m_export_view}});Object.defineProperty(this,"alert_view",{get:function(){return this.m_alert_view}});Object.defineProperty(this,"error_view",{get:function(){return this.m_error_view}});Object.defineProperty(this,"progress_view",{get:function(){return this.m_progress_view}});Object.defineProperty(this,
"importing_images_size",{get:function(){return this.m_importing_images_size}});Object.defineProperty(this,"export_image_filename",{get:function(){return this.m_export_image_filename},set:function(value){this.m_export_image_filename=value}});Object.defineProperty(this,"export_configuration_filename",{get:function(){return this.m_export_configuration_filename},set:function(value){this.m_export_configuration_filename=value}});Object.defineProperty(this,"scene",{get:function(){return this.m_scene},set:function(value){this.m_scene=
value}});Object.defineProperty(this,"animated_sprite",{get:function(){return this.m_animated_sprite},set:function(value){this.m_animated_sprite=value}});Object.defineProperty(this,"frames_count",{get:function(){return this.m_sprites.length}});Object.defineProperty(this,"animations",{get:function(){return this.m_animations}});Object.defineProperty(this,"current_animation_name",{get:function(){return this.m_current_animation_name},set:function(value){this.m_current_animation_name=value}})},release:function(){},
methods:{activate:function(){var self=gb.ss_merge_controller.self();var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;var gl_canvas=$("#gl_canvas").detach();$(ui_j(ui.tab_right_panel)).append(gl_canvas);gb.game_controller.get_instance().goto_transition("data/resources/configurations/transitions/transition.spritesheets.merge.json",function(scene){self.scene=scene;var camera=new gb.camera(gl.viewport_width,gl.viewport_height);scene.camera=camera;self.m_grid=scene.fabricator.create_grid("data/resources/configurations/game_objects/grid.json",
32,32,32,32,function(){self.m_grid.color=new gb.vec4(0,1,0,1);self.m_grid.position=new gb.vec2(0,-1)});scene.add_child(self.m_grid);var sprites_count=self.m_sprites.length;if(sprites_count!==0)for(var i=0;i<sprites_count;++i){var sprite=self.m_sprites[i];scene.add_child(sprite)}self.on_pack_sprites();self.animated_sprite=scene.fabricator.create_sprite("data/resources/configurations/game_objects/sprite.animation.json",function(){self.scene.add_child(self.animated_sprite);self.animated_sprite.size=
new gb.vec2(256,256);self.animated_sprite.position=new gb.vec2(256,256)})})},deactivate:function(){var sprites_count=this.m_sprites.length;if(sprites_count!==0)for(var i=0;i<sprites_count;++i){var sprite=this.m_sprites[i];this.scene.remove_child(sprite)}this.scene.remove_child(this.m_grid);var geometry_component=this.m_grid.get_component(gb.ces_base_component.type.geometry);geometry_component.mesh.release()},on_importing_images_size_changed:function(size){this.m_importing_images_size=size},on_move_resize_mode_changed:function(snap_to_grid){self.m_selector.is_align_movement=
snap_to_grid},on_images_importing:function(images_files){var self=this;var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;self.progress_view.show(ui,ui_j);var images_files_count_unprocessed=images_files.length;var images_files_count_processed=0;for(var i=0;i<images_files_count_unprocessed;++i){var image_file=images_files[i];if(!image_file.type.match("image.*"))continue;var reader=new FileReader;reader.m_filename=image_file.name;reader.onload=function(data){return function(data){var image=
new Image;image.src=data.target.result;image.onload=function(){var texture=self.scene.fabricator.resources_accessor.get_texture(data.target.m_filename,image);texture.add_resource_loading_callback(function(resource,userdata){var sprite=self.scene.fabricator.create_sprite("data/resources/configurations/game_objects/sprite.savetoimage.json",function(){resource.mag_filter=gl.LINEAR;resource.min_filter=gl.LINEAR;resource.wrap_mode=gl.CLAMP_TO_EDGE;var material_component=sprite.get_component(gb.ces_base_component.type.material);
material_component.set_texture(resource,0);sprite.size=new gb.vec2(Math.round(resource.width*self.importing_images_size),Math.round(resource.height*self.importing_images_size));self.on_sprite_added_to_page(sprite,0);images_files_count_processed++;self.progress_view.update_progress("Loading images...",false,ui,ui_j);if(images_files_count_processed===images_files_count_unprocessed){self.progress_view.update_progress("Generating animation...",false,ui,ui_j);self.on_pack_sprites();self.on_generate_animation(function(){self.progress_view.hide(ui,
ui_j)})}});var sprites_count=self.m_sprites.length;var same_images_count=0;var analized_sprite=null;for(var i=0;i<sprites_count;++i){analized_sprite=self.m_sprites[i];if(analized_sprite.tag.indexOf(data.target.m_filename)!==-1)same_images_count++}var unique_tag=data.target.m_filename;if(same_images_count!==0)unique_tag+="("+same_images_count+")";sprite.tag=unique_tag;self.frames_view.add_frame(self,unique_tag,image,gb.ss_merge_controller.ui(),gb.ss_merge_controller.ui_j);self.on_sprite_added_to_table(sprite)})}}}(image_file);
reader.readAsDataURL(image_file)}},on_sprites_reordering:function(){var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;var tags=$(ui_j(ui.frames_table)+" li").map(function(){return $(this).find("#ss-merge-frames-table-cell").text()});var sprites=[];var tags_count=tags.length;var sprite=null;for(var i=0;i<tags_count;++i){sprite=this.m_sprites.find(function(analized_sprite){return analized_sprite.tag===tags[i]});sprites.push(sprite)}this.m_sprites=sprites;var sprites_count=
this.m_sprites.length;$(ui_j(ui.frames_table)).height(sprites_count>0?sprites_count==1?170:340:0);$(ui_j(ui.frames_sort_button)).button(sprites_count>1?"enable":"disable")},on_pack_sprites:function(){this.m_merge_algorithm.reset();this.m_sprites_on_pages=[];var sprites_count=this.m_sprites.length;var pages_count=1;for(var i=0;i<sprites_count;++i){var sprite=this.m_sprites[i];var packed_data=this.m_merge_algorithm.add_sprite(sprite);var position=packed_data.position;var page=packed_data.page;if(!this.m_sprites_on_pages[page])this.m_sprites_on_pages[page]=
[];this.m_sprites_on_pages[page].push(sprite);position.x+=sprite.size.x*sprite.pivot.x;position.y+=sprite.size.y*sprite.pivot.y;sprite.position=position;sprite.visible=false;pages_count=Math.max(pages_count,page+1)}var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;$(ui_j(ui.editing_page_drop_down_box)).find("option").remove().end();for(var i=0;i<pages_count;++i)$(ui_j(ui.editing_page_drop_down_box)).append($("<option></option>").attr("value",i).text("page "+(i+1)));
this.on_page_changed(0,true)},on_sprite_added_to_table:function(sprite){this.scene.add_child(sprite);this.m_sprites.push(sprite)},on_sprite_removed_from_table:function(unique_tag){var sprite_index=-1;var sprite=null;var sprites_count=this.m_sprites.length;for(var i=0;i<sprites_count;++i){sprite=gb.ss_merge_controller.self().m_sprites[i];if(sprite.tag===unique_tag){sprite_index=i;break}}this.m_sprites.splice(sprite_index,1);this.scene.remove_child(sprite);sprite.release();var ui=gb.ss_merge_controller.html_elements;
var ui_j=gb.ss_merge_controller.ui_j;var self=this;this.progress_view.show(ui,ui_j);this.progress_view.update_progress("Generating animation...",false,ui,ui_j);this.on_pack_sprites();this.on_generate_animation(function(){self.progress_view.hide(ui,ui_j)});this.animation_view.on_frames_count_changed(this,ui,ui_j)},on_sprite_added_to_page:function(entity,animated){if(animated){var action_component=entity.get_component(gb.ces_base_component.type.action);if(!action_component){entity.scale.x=0;entity.scale.y=
0;entity.visible=true;action_component=new gb.ces_action_component;action_component.action=function(entity,deltatime){if(entity.scale.x<1){entity.scale.x+=.1;entity.scale.y+=.1}else{entity.scale.x=1;entity.scale.y=1;action_component.action=null;entity.remove_component(gb.ces_base_component.type.action)}};entity.add_component(action_component)}}else{entity.scale.x=1;entity.scale.y=1;entity.visible=true}},on_sprite_removed_from_page:function(entity,animated){if(animated){var action_component=entity.get_component(gb.ces_base_component.type.action);
if(!action_component){entity.scale.x=1;entity.scale.y=1;action_component=new gb.ces_action_component;action_component.action=function(entity,deltatime){if(entity.scale.x>0){entity.scale.x-=.1;entity.scale.y-=.1}else{entity.scale.x=0;entity.scale.y=0;entity.visible=false;action_component.action=null;entity.remove_component(gb.ces_base_component.type.action)}};entity.add_component(action_component)}}else{entity.scale.x=0;entity.scale.y=0;entity.visible=false}},on_add_sprites_on_page:function(page,animated,
callback){if(page>=0&&page<this.m_sprites_on_pages.length){var sprites=this.m_sprites_on_pages[page];var sprites_count=sprites.length;var sprite=null;for(var i=0;i<sprites_count;++i){sprite=sprites[i];this.on_sprite_added_to_page(sprite,animated)}if(callback){var update_sprites_status=function(){var is_sprites_removed=true;for(var i=0;i<sprites_count;++i){sprite=sprites[i];var action_component=sprite.get_component(gb.ces_base_component.type.action);if(action_component){is_sprites_removed=false;break}}if(is_sprites_removed)setTimeout(callback,
100);else setTimeout(update_sprites_status,100)};update_sprites_status()}}else if(callback)callback()},on_remove_sprites_from_page:function(page,animated,callback){if(page>=0&&page<this.m_sprites_on_pages.length){var sprites=this.m_sprites_on_pages[page];var sprites_count=sprites.length;var sprite=null;for(var i=0;i<sprites_count;++i){sprite=sprites[i];this.on_sprite_removed_from_page(sprite,animated)}if(callback){var update_sprites_status=function(){var is_sprites_removed=true;for(var i=0;i<sprites_count;++i){sprite=
sprites[i];var action_component=sprite.get_component(gb.ces_base_component.type.action);if(action_component){is_sprites_removed=false;break}}if(is_sprites_removed)setTimeout(callback,100);else setTimeout(update_sprites_status,100)};update_sprites_status()}}else if(callback)callback()},on_page_changed:function(index,animated,callback){var self=gb.ss_merge_controller.self();this.on_remove_sprites_from_page(this.m_current_page,animated,function(){self.m_current_page=index;self.on_add_sprites_on_page(index,
animated,callback)})},on_export_filename_changed:function(filename){this.export_image_filename=filename;this.export_configuration_filename=filename},on_export_images:function(callback){var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;this.export_view.cleanup_frames(ui,ui_j);var pages_count=this.m_sprites_on_pages.length;var page=0;var self=this;var images=[];var create_page_shapshot=function(page){self.on_page_changed(page,true,function(){var image=g_ss_merge_transition.get_ws_technique_result_as_image("ws.savetoimage",
0,self.m_page_size,self.m_page_size);images.push(image);self.export_view.add_frame(image,self.export_image_filename,page,ui,ui_j);page++;if(page<pages_count)create_page_shapshot(page);else{self.on_page_changed(0,true);if(callback)callback(images)}})};create_page_shapshot(page)},on_export_configuration:function(){var frames=[];var sortered_sprites=this.m_sprites.sort(function(sprite_1,sprite_2){return sprite_1.tag.localeCompare(sprite_2.tag,"en",{numeric:true})});var pages_count=this.m_sprites_on_pages.length;
var sprites_count=sortered_sprites.length;var sprite=null;var position_0=null;var position_1=null;for(var i=0;i<sprites_count;++i){sprite=sortered_sprites[i];var index=-1;for(var j=0;j<pages_count;++j){index=this.m_sprites_on_pages[j].findIndex(function(analized_sprite){return analized_sprite.tag===sprite.tag});if(index!==-1){index=j;break}}var position_in_atlas=new gb.vec2(sprite.position);position_in_atlas.x-=sprite.size.x*sprite.pivot.x;position_in_atlas.y-=sprite.size.y*sprite.pivot.y;position_0=
position_in_atlas;position_1=gb.vec2.add(position_0,sprite.size);frames.push({t_name:"page_"+index+".png",d_name:sprite.tag,u_0:position_0.x/this.m_page_size,v_0:position_0.y/this.m_page_size,u_1:position_1.x/this.m_page_size,v_1:position_1.y/this.m_page_size})}var frames_count=frames.length;var animations_configuration=[];animations_configuration["frames"]=frames;animations_configuration["animations"]=[];animations_configuration["animations"].push({name:"all frames",first_frame:0,last_frame:frames_count});
for(animation_name in this.animations)animations_configuration["animations"].push({name:animation_name,first_frame:this.animations[animation_name][0],last_frame:this.animations[animation_name][1]});console.log(animations_configuration);var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;this.export_view.add_frames_configuration(animations_configuration,this.export_configuration_filename,ui,ui_j);return animations_configuration},on_generate_animation:function(callback){var self=
this;this.scene.remove_child(this.animated_sprite);this.on_export_images(function(images){var animations_configuration=self.on_export_configuration();var material_component=self.animated_sprite.get_component(gb.ces_base_component.type.material);var images_count=images.length;for(var i=0;i<images_count;++i){var image=images[i];var texture=self.scene.fabricator.resources_accessor.get_texture("page_"+i+".png",image);texture.mag_filter=gl.LINEAR;texture.min_filter=gl.LINEAR;texture.wrap_mode=gl.CLAMP_TO_EDGE;
material_component.set_texture(texture,i)}self.animated_sprite.set_animations_configuration(animations_configuration);self.animated_sprite.play_animation(self.current_animation_name);self.scene.add_child(self.animated_sprite);if(callback)callback()})},on_apply_animation:function(cached_animation_name,current_animation_name,frames_indices){if(cached_animation_name)delete this.m_animations[cached_animation_name];this.m_animations[current_animation_name]=frames_indices;var animations_configuration=this.on_export_configuration();
this.animated_sprite.set_animations_configuration(animations_configuration);this.animated_sprite.play_animation(this.current_animation_name)},on_current_animation_changed:function(animation_name){this.current_animation_name=animation_name;this.animated_sprite.play_animation(this.current_animation_name)},on_show_alert_view:function(message){var ui=gb.ss_merge_controller.html_elements;var ui_j=gb.ss_merge_controller.ui_j;this.alert_view.show(message,ui,ui_j)}},static_methods:{self:function(){return g_ss_merge_controller},
ui:function(){return gb.ss_merge_controller.html_elements},ui_j:function(element_name){return"#"+element_name}}});oop.define_class({namespace:"gb",name:"ss_merge_import_view",extend:gb.game_object,init:function(controller,ui,ui_j){$(ui_j(ui.tab_left_panel)).append("<h3>"+'<span class="ui-icon ui-icon-note" style="float:left; margin:2px;"></span>import'+"</h3>"+'<div style="background:none; border:0px;">'+'<div title="changed size of imported images" style="width:95%; margin:2%;">'+"<select id="+ui.import_size_drop_down_box+">"+"<option>image scale - 10%</option>"+"<option>image scale - 20%</option>"+"<option>image scale - 30%</option>"+
"<option>image scale - 40%</option>"+"<option>image scale - 50%</option>"+"<option>image scale - 60%</option>"+"<option>image scale - 70%</option>"+"<option>image scale - 80%</option>"+"<option>image scale - 90%</option>"+'<option selected="selected">image scale - 100%</option>'+"</select>"+"</div>"+"<div id="+ui.import_drop_zone+">"+'<input type="file" id='+ui.import_add_image_input+' style="display:none;" multiple>'+'<a style="width:99%;" href="#" id='+ui.import_add_image_button+">add images...</a>"+
'<label style="float:right; margin-top:8%; margin-right:33.5%">or drop here...</label>'+"</div>"+"</div>");$(ui_j(ui.import_add_image_button)).button();$(ui_j(ui.import_add_image_button)).on("click",function(){$(ui_j(ui.import_add_image_input)).trigger("click")});document.getElementById(ui.import_add_image_input).addEventListener("change",function(){controller.on_images_importing(this.files)},false);document.getElementById(ui.import_drop_zone).addEventListener("dragover",function(event){event.stopPropagation();
event.preventDefault();event.dataTransfer.dropEffect="copy"},false);document.getElementById(ui.import_drop_zone).addEventListener("drop",function(event){event.stopPropagation();event.preventDefault();controller.on_images_importing(event.dataTransfer.files)},false);$(ui_j(ui.import_size_drop_down_box)).selectmenu();$(ui_j(ui.import_size_drop_down_box_button)).css({"width":"100%"});$(ui_j(ui.import_size_drop_down_box)).on("selectmenuselect",function(event,ui){controller.on_importing_images_size_changed((ui.item.index+
1)/10)})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ss_merge_frames_view",constants:{image_preview_size:{width:128,height:128}},init:function(controller,ui,ui_j){$(ui_j(ui.tab_left_panel)).append("<h3>"+'<span class="ui-icon ui-icon-note" style="float:left; margin:2px;"></span>frames'+"</h3>"+'<div style="background:none; border:0px;">'+"<button id="+ui.frames_sort_button+' style="margin:2%; width:95%;">sort by name</button>'+"<div id="+ui.frames_table_scroll+' style="height:340px" class="scroll">'+'<ul style="list-style-type:none; margin-left:-12.5%;" id="'+
ui.frames_table+'"></ul>'+"</div>"+"</div>");$(".scroll").scrollable({"autoHide":false,"transferScrolling":false,"mouseWheelMaxDelta":.1});$(ui_j(ui.frames_table)).height(0);$(ui_j(ui.frames_table)).sortable();$(ui_j(ui.frames_table)).disableSelection();$(ui_j(ui.frames_table)).sortable({stop:function(){controller.on_sprites_reordering()}});$(ui_j(ui.frames_sort_button)).button();$(ui_j(ui.frames_sort_button)).button("disable")},release:function(){},methods:{add_frame:function(controller,unique_tag,
image,ui,ui_j){var self=this;var ratio=image.width/image.height;var image_preview_width=gb.ss_merge_frames_view.image_preview_size.width;var image_preview_height=gb.ss_merge_frames_view.image_preview_size.height;if(image.width>image.height)image_preview_height/=ratio;else if(image.width<image.height)image_preview_width/=ratio;$(ui_j(ui.frames_table)).append('<li class="ui-state-default" id='+unique_tag+' style="height: 160px; margin: 8px; background: none;">'+'<p align="center" style="font-size:14px; float:left; margin:2px; margin-left:-0.25%; margin-top:-0.25%; height:24px; width:100%; border-color: #666;" id='+
ui.frames_table_cell+' class="ui-widget-header" style="margin:4px;">'+'<span class="ui-icon ui-icon-circle-arrow-e" style="float:left; margin:4px;"/>'+"<span id="+ui.frames_table_cell_delete_icon+' class="ui-icon ui-icon-trash" style="float:right; margin:4px;"/>'+unique_tag+"</p>"+'<img style="float:left; margin:2px; height:'+image_preview_height+"px; width:"+image_preview_width+'px;" id='+ui.frames_table_cell_image+' align="left" src="'+image.src+'"/>'+"</li>");var cells=$(ui_j(ui.frames_table)).children();
var cell=cells[cells.length-1];$($(cell).find("#"+ui.frames_table_cell_delete_icon)).click(function(){var unique_tag=$(this).parent().find("#"+ui.frames_table_cell).text();$(this).parent().parent().remove();controller.on_sprite_removed_from_table(unique_tag);self.on_frames_count_changed(ui,ui_j)});this.on_frames_count_changed(ui,ui_j)},on_frames_count_changed:function(ui,ui_j){var cells=$(ui_j(ui.frames_table)).children();var cells_count=cells.length;$(ui_j(ui.frames_table)).height(cells_count*170);
$(ui_j(ui.frames_sort_button)).button(cells_count>1?"enable":"disable")}},static_methods:{}});oop.define_class({namespace:"gb",name:"ss_merge_packer_view",init:function(controller,ui,ui_j){$(ui_j(ui.tab_left_panel)).append("<h3>"+'<span class="ui-icon ui-icon-note" style="float:left; margin:2px;"></span>packer'+"</h3>"+'<div style="background:none; border:0px;" id='+ui.editing_container+">"+'<div style="width:95%; margin:2%; margin-top:5%">'+"<select id="+ui.editing_page_drop_down_box+">"+'<option selected="selected">page 1</option>'+"</select>"+"</div>"+'<div style="margin:2%;" id='+ui.editing_move_resize_radio_button+
">"+'<input type="radio" id='+ui.editing_move_resize_freeform_button+' name="'+ui.editing_move_resize_radio_button+'" checked="checked">'+"<label for="+ui.editing_move_resize_freeform_button+' style="width:48%;">free form</label>'+'<input type="radio" id='+ui.editing_move_resize_snaptogrid_button+' name="'+ui.editing_move_resize_radio_button+'">'+"<label for="+ui.editing_move_resize_snaptogrid_button+' style="width:52%;">snap to grid</label>'+"</div>"+'<div title="packing algorithm" style="width:95%; margin:2%; margin-top:5%">'+
"<select id="+ui.editing_pack_algorithm_drop_down_box+">"+'<option selected="selected">heuristic - none</option>'+"<option>heuristic - TL (top left fit)</option>"+"<option>heuristic - BAF (best area fit)</option>"+"<option>heuristic - BSSF (best short side fit)</option>"+"<option>heuristic - BLSF (best long side fit)</option>"+"<option>heuristic - MINW (min width fit)</option>"+"<option>heuristic - MINH (min height fit)</option>"+"</select>"+"</div>"+"<button id="+ui.editing_spread_button+' style="margin:2%; width:95.5%;">spread</button>'+
"</div>");$(ui_j(ui.editing_pack_algorithm_drop_down_box)).selectmenu();$(ui_j(ui.editing_pack_algorithm_drop_down_box_button)).css({"width":"100%"});$(ui_j(ui.editing_spread_button)).button();$(ui_j(ui.editing_spread_button)).on("click",function(){});$(ui_j(ui.editing_page_drop_down_box)).selectmenu();$(ui_j(ui.editing_page_drop_down_box_button)).css({"width":"100%"});$(ui_j(ui.editing_page_drop_down_box)).on("selectmenuselect",function(event,ui){controller.on_page_changed(ui.item.index,true)});
$(ui_j(ui.editing_move_resize_radio_button)).buttonset();$(ui_j(ui.editing_move_resize_radio_button)+" input[type=radio]").change(function(){controller.on_move_resize_mode_changed(this.id===ui.editing_move_resize_snaptogrid_button)})},release:function(){},methods:{},static_methods:{}});oop.define_class({namespace:"gb",name:"ss_merge_animations_view",init:function(controller,ui,ui_j){var self=this;$(ui_j(ui.tab_left_panel)).append("<h3>"+'<span class="ui-icon ui-icon-note" style="float:left; margin:2px;"></span>animations'+"</h3>"+'<div style="background:none; border:0px;" id='+ui.animations_container+">"+'<div style="width:95%; margin:2%; margin-top:5%">'+"<select id="+ui.animations_current_animation_drop_down_box+">"+'<option selected="selected">all frames</option>'+"</select>"+
"</div>"+"<button id="+ui.animations_add_animation_button+' style="margin:2%; width:95.5%;">add animation</button>'+"<div id="+ui.animations_table_scroll+' style="height:0px" class="scroll">'+'<ul style="list-style-type:none; margin-left:-12.5%;" id="'+ui.animations_table+'"></ul>'+"</div>"+"</div>");$(ui_j(ui.animations_current_animation_drop_down_box)).selectmenu();$(ui_j(ui.animations_current_animation_drop_down_box_button)).css({"width":"100%"});$(ui_j(ui.animations_current_animation_drop_down_box)).on("selectmenuselect",
function(event,ui){controller.on_current_animation_changed(ui.item.value)});$(ui_j(ui.animations_add_animation_button)).button();$(ui_j(ui.animations_add_animation_button)).on("click",function(){self.add_animation(controller,ui,ui_j)});$(".scroll").scrollable({"autoHide":false,"transferScrolling":false,"mouseWheelMaxDelta":.1});$(ui_j(ui.animations_table)).height(0);$(ui_j(ui.animations_table)).sortable();$(ui_j(ui.animations_table)).disableSelection();this.m_animations_names_cache=[];Object.defineProperty(this,
"animations_names_cache",{get:function(){return this.m_animations_names_cache}})},release:function(){},methods:{add_animation:function(controller,ui,ui_j){var self=this;$(ui_j(ui.animations_table)).append('<li class="ui-state-default" style="height: 200px; margin: 8px; background: none;">'+'<p align="center" style="font-size:14px; float:left; margin:2px; margin-left:-0.25%; margin-top:-0.25%; height:24px; width:100%; border-color: #666;" id='+ui.animations_table_cell+' class="ui-widget-header" style="margin:4px;">'+
'<span class="ui-icon ui-icon-circle-arrow-e" style="float:left; margin:4px;"/>'+"<span id="+ui.animations_table_cell_delete_icon+' class="ui-icon ui-icon-trash" style="float:right; margin:4px;"/>'+"</p>"+"<p>"+'<input class="ui-widget ui-front ui-widget-content ui-corner-all" style="margin:2%; width:94%;" placeholder=" animation name..." id='+ui.animations_table_cell_animation_name_textfield+' type="text">'+'<label style="margin-left: 3%;" for="'+ui.animations_table_cell_frames_label+'">frames: </label>'+
'<input type="text" id='+ui.animations_table_cell_frames_label+' readonly style="background: black; margin-top: 3%; border: 0; color: #f6931f; font-weight: bold;">'+"</p>"+'<div style="width: 88%; margin-left: 5.25%;" id='+ui.animations_table_cell_frames_slider+"></div>"+'<a style="margin-top:6%; margin-left:2%; width:95.5%;" id='+ui.animations_table_cell_apply_button+">apply</a>"+"</li>");var cells=$(ui_j(ui.animations_table)).children();var cell=cells[cells.length-1];$(cell).find(ui_j(ui.animations_table_cell_animation_name_textfield)).change(function(event){var current_animation_name=
event.target.value;var animations=controller.animations;var is_animation_with_same_name_exist=false;for(animation_name in animations)if(animation_name===current_animation_name){is_animation_with_same_name_exist=true;break}if(current_animation_name.length!=0&&!is_animation_with_same_name_exist)$(this).parent().parent().find(ui_j(ui.animations_table_cell_apply_button)).button("enable");else{$(this).parent().parent().find(ui_j(ui.animations_table_cell_apply_button)).button("disable");controller.on_show_alert_view("Animation with same name already exist!")}});
$(cell).find(ui_j(ui.animations_table_cell_frames_slider)).slider({range:true,min:0,max:controller.frames_count,values:[0,controller.frames_count],slide:function(event,element){$(this).parent().find(ui_j(ui.animations_table_cell_frames_label)).val(element.values[0]+" - "+element.values[1])}});$(cell).find(ui_j(ui.animations_table_cell_frames_label)).val("0 - "+controller.frames_count);$(cell).find(ui_j(ui.animations_table_cell_apply_button)).button();$(cell).find(ui_j(ui.animations_table_cell_apply_button)).button("disable");
$(cell).find(ui_j(ui.animations_table_cell_apply_button)).on("click",function(){var cell=$(this).parent();var current_animation_name=$(cell).find(ui_j(ui.animations_table_cell_animation_name_textfield)).val();var cached_animation_name=self.animations_names_cache[$(cell).find(ui_j(ui.animations_table_cell_animation_name_textfield))];var frames_indices=$(cell).find(ui_j(ui.animations_table_cell_frames_slider)).slider("option","values");var animations=controller.animations;controller.on_apply_animation(cached_animation_name,
current_animation_name,frames_indices);self.on_apply_animation(controller,ui,ui_j);self.animations_names_cache[$(cell).find(ui_j(ui.animations_table_cell_animation_name_textfield))]=current_animation_name});$(cell).find(ui_j(ui.animations_table_cell_delete_icon)).click(function(){var cell=$(this).parent().parent();var animation_name=$(cell).find(ui_j(ui.animations_table_cell_animation_name_textfield)).val();cell.remove();var options=$(ui_j(ui.animations_current_animation_drop_down_box)).children();
var options_count=options.length;var option=null;for(var i=0;i<options_count;++i){option=options[i];if($(option).text()===animation_name)$(option).remove()}$(ui_j(ui.animations_current_animation_drop_down_box)).selectmenu("refresh");$(ui_j(ui.animations_current_animation_drop_down_box_button)).css({"width":"100%"});self.on_animations_count_changed(ui,ui_j)});this.on_animations_count_changed(ui,ui_j)},on_apply_animation:function(controller,ui,ui_j){$(ui_j(ui.animations_current_animation_drop_down_box)).find("option").remove().end();
$(ui_j(ui.animations_current_animation_drop_down_box)).append($("<option></option>").text("all frames"));var animations=controller.animations;for(animation_name in animations)$(ui_j(ui.animations_current_animation_drop_down_box)).append($("<option></option>").text(animation_name));$(ui_j(ui.animations_current_animation_drop_down_box)).selectmenu("refresh");$(ui_j(ui.animations_current_animation_drop_down_box_button)).css({"width":"100%"})},on_animations_count_changed:function(ui,ui_j){var cells=$(ui_j(ui.animations_table)).children();
var cells_count=cells.length;var height=cells_count*210;$(ui_j(ui.animations_table)).height(height);$(ui_j(ui.animations_table_scroll)).css({"height":Math.min(430,height+cells_count*10)})},on_frames_count_changed:function(controller,ui,ui_j){var cells=$(ui_j(ui.animations_table)).children();var cells_count=cells.length;var cell=null;for(var i=0;i<cells_count;++i){cell=cells[i];$(cell).find(ui_j(ui.animations_table_cell_frames_label)).val("0 - "+controller.frames_count);$(cell).find(ui_j(ui.animations_table_cell_frames_slider)).slider({min:0,
max:controller.frames_count})}}},static_methods:{}});oop.define_class({namespace:"gb",name:"ss_merge_export_view",init:function(controller,ui,ui_j){$(ui_j(ui.tab_left_panel)).append("<h3>"+'<span class="ui-icon ui-icon-note" style="float:left; margin:2px;"></span>export'+"</h3>"+'<div style="background:none; border:0px;" id='+ui.export_container+">"+'<input class="ui-widget ui-front ui-widget-content ui-corner-all" style="margin:2%; width:94%;" placeholder=" enter filename..." id='+ui.export_filename_input+' type="text">'+'<button title="preview animation" id='+
ui.export_animation_preview_button+' style="margin:2%; width:95.5%;">preview animation</button>'+"<br>"+"<button id="+ui.export_save_images_button+' style="margin:2%; width:95.5%;">generate images</button>'+"<br>"+"<div id="+ui.export_save_pages_table_scroll+' style="height:340px; overflow: hidden;" class="scroll">'+'<ul style="list-style-type:none; margin-left:-10%; margin-top:-0.5%;" id="'+ui.export_save_pages_table+'"/>'+"</div>"+"<button id="+ui.export_save_frames_button+' style="margin:2%; width:95.5%;">generate frames configuration</button>'+
"</div>");$(".scroll").scrollable({"autoHide":false,"transferScrolling":false,"mouseWheelMaxDelta":.1});$(ui_j(ui.tab_right_panel)).append("<div id="+ui.export_animation_preview_dialog+' class="ui-dialog" title="Animation"></div>');$(ui_j(ui.export_filename_input)).change(function(event){$(ui_j(ui.export_save_images_button)).button(event.target.value.length!=0?"enable":"disable");$(ui_j(ui.export_save_frames_button)).button(event.target.value.length!=0?"enable":"disable");$(ui_j(ui.export_animation_preview_button)).button(event.target.value.length!=
0?"enable":"disable");if(event.target.value.length!=0)controller.on_export_filename_changed(event.target.value)});$(ui_j(ui.export_save_images_button)).button();$(ui_j(ui.export_save_images_button)).on("click",function(){controller.on_export_images()});$(ui_j(ui.export_save_images_button)).button("disable");$(ui_j(ui.export_save_pages_table_scroll)).height(0);$(ui_j(ui.export_save_pages_table)).sortable();$(ui_j(ui.export_save_pages_table)).disableSelection();$(ui_j(ui.export_save_frames_button)).button();
$(ui_j(ui.export_save_frames_button)).on("click",function(){controller.on_export_configuration()});$(ui_j(ui.export_save_frames_button)).button("disable");$(ui_j(ui.export_animation_preview_button)).button();$(ui_j(ui.export_animation_preview_button)).on("click",function(){controller.on_preview_animation_open()});$(ui_j(ui.export_animation_preview_button)).button("disable");var self=this;$(ui_j(ui.export_animation_preview_dialog)).dialog({autoOpen:false,width:512,height:512,modal:true,show:{effect:"blind",
duration:300},hide:{effect:"blind",duration:300},beforeClose:function(){controller.on_preview_animation_close()}})},release:function(){},methods:{add_frame:function(image,filename,index,ui,ui_j){$(ui_j(ui.export_save_pages_table)).append('<li class="ui-state-default" style="height:160px; margin:8px; background: none;">'+'<p align="center" style="font-size:14px; float:left; margin:4px; margin-left:-0.25%; margin-top:-0.25%; height:24px; width:100%; border-color: #666;" class="ui-widget-header">'+filename+
(index+1)+".png</p>"+'<img style="float:left; margin:2px; height:128px; width:128px;" align="left" src="'+image.src+'"/>'+'<a style="margin-top:12%; margin-left:8%;" id="'+ui.export_save_pages_table_cell_download_button+index+'" href="'+image.src.replace("image/png","image/octet-stream")+'"  download="'+filename+(index+1)+'.png">download</a>'+"</li>");$("#"+ui.export_save_pages_table_cell_download_button+index).button();$(ui_j(ui.export_save_pages_table_scroll)).height(170*Math.min(index+1,2))},add_frames_configuration:function(configuration,
filename,ui,ui_j){$(ui_j(ui.export_save_frames_textfield)).remove();$(ui_j(ui.export_save_frames_download_button)).remove();var configuration_json="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(configuration));$(ui_j(ui.export_container)).append("<div id="+ui.export_save_frames_textfield+' class="ui-widget ui-front ui-widget-content" style="margin:2%; font-size: 1vw; height: 150px; overflow: hidden; background: gray;">'+JSON.stringify(configuration)+"</div>"+'<a style="margin-top:2%; margin-left:2%; width:95.5%;" id='+
ui.export_save_frames_download_button+' href="data:'+configuration_json+'" download="'+filename+'.json">download frames configuration</a>');$(ui_j(ui.export_save_frames_download_button)).button()},cleanup_frames:function(ui,ui_j){var cells=$(ui_j(ui.export_save_pages_table)).children();var cells_count=cells.length;for(var i=0;i<cells_count;++i)cells[i].remove()}},static_methods:{}});var g_ss_animation_controller=null;var g_ss_animation_scene=null;
oop.define_class({namespace:"gb",name:"ss_animation_controller",init:function(){$("#ss-animation-tab").append($('<div id="ui-ss-animation-center"/>'));$("#ss-animation-tab").append($('<div id="ui-ss-animation-left"/>'));g_ss_animation_controller=this;var game_transition=new gb.game_transition("data/resources/configurations/transitions/transition.spritesheets.animation.json");gb.game_controller.get_instance().add_transition(game_transition);this.m_grid=null},release:function(){},methods:{activate:function(){var gl_canvas=
$("#gl_canvas").detach();$("#ui-ss-animation-center").append(gl_canvas);var self=this;gb.game_controller.get_instance().goto_transition("data/resources/configurations/transitions/transition.spritesheets.animation.json",function(scene){g_ss_animation_scene=scene;var camera=new gb.camera(gl.viewport_width,gl.viewport_height);scene.camera=camera;self.m_grid=scene.fabricator.create_grid("data/resources/configurations/game_objects/sprite_02.json",32,32,32,32,function(){self.m_grid.color=new gb.vec4(1,
1,0,1)});scene.add_child(self.m_grid)})},deactivate:function(){g_ss_animation_scene.remove_child(this.m_grid);var geometry_component=this.m_grid.get_component(gb.ces_base_component.type.geometry);geometry_component.mesh.release()}},static_methods:{}});var g_ss_preview_animation_controller=null;
oop.define_class({namespace:"gb",name:"ss_preview_animation_controller",init:function(){g_ss_preview_animation_controller=this;this.m_transition=new gb.game_transition("data/resources/configurations/transitions/transition.spritesheets.play.animation.dialog.json");gb.game_controller.get_instance().add_transition(this.m_transition)},release:function(){},methods:{activate:function(images,frames){var gl_canvas=$("#gl_canvas").detach();$("#"+gb.ss_merge_controller.html_elements.export_animation_preview_dialog).append(gl_canvas);this.m_scene=
null;var self=this;gb.game_controller.get_instance().goto_transition("data/resources/configurations/transitions/transition.spritesheets.play.animation.dialog.json",function(scene){self.m_scene=scene;var camera=new gb.camera(gl.viewport_width,gl.viewport_height);scene.camera=camera;var sprite=scene.fabricator.create_sprite("data/resources/configurations/game_objects/sprite.json",function(){var material_component=sprite.get_component(gb.ces_base_component.type.material);var images_count=images.length;
for(var i=0;i<images_count;++i){var image=images[i];var texture=scene.fabricator.resources_accessor.get_texture("page_"+i+".png",image);texture.mag_filter=gl.LINEAR;texture.min_filter=gl.LINEAR;texture.wrap_mode=gl.CLAMP_TO_EDGE;material_component.set_texture(texture,i)}scene.add_child(sprite);sprite.size=new gb.vec2(256,256);sprite.position=new gb.vec2(gl.viewport_width*.5,gl.viewport_height*.5);sprite.add_animation("animation",frames)})})},deactivate:function(){var sprites=this.m_scene.children;
var sprites_count=sprites.length;if(sprites_count!==0)for(var i=0;i<sprites_count;++i){var sprite=sprites[i];var geometry_component=sprite.get_component(gb.ces_base_component.type.geometry);geometry_component.mesh.release();this.m_scene.remove_child(sprite)}}},static_methods:{}});oop.define_class({namespace:"gb",name:"selector",constants:{corner_type:{left_top:0,right_top:1,left_bottom:2,right_bottom:3,center:4,max:5}},init:function(){this.m_bounding_quad=null;this.m_points=[];this.m_target=null;this.m_previous_target_touch_point=null;this.m_previous_selector_touch_point=null;Object.defineProperty(this,"bounding_quad",{get:function(){return this.m_bounding_quad},set:function(value){this.m_bounding_quad=value}});Object.defineProperty(this,"size",{get:function(){return this.m_bounding_quad.size},
set:function(value){this.m_bounding_quad.size=value}});Object.defineProperty(this,"position",{get:function(){return this.m_bounding_quad.position},set:function(value){this.m_bounding_quad.position=value}});Object.defineProperty(this,"target",{get:function(){return this.m_target},set:function(value){if(value){var target_touch_recognize_component=null;if(this.m_target){target_touch_recognize_component=this.m_target.get_component(gb.ces_base_component.type.touch_recognize);target_touch_recognize_component.remove_callback(gb.input_context.state.pressed,
this.on_target_pressed);target_touch_recognize_component.remove_callback(gb.input_context.state.dragged,this.on_target_dragged);target_touch_recognize_component.remove_callback(gb.input_context.state.released,this.on_target_released)}this.m_target=value;this.m_target.remove_from_parent();this.m_target.position=new gb.vec2(0);this.m_target.rotation=0;this.m_bounding_quad.add_child(this.m_target);this.m_bounding_quad.visible=true;this.m_bounding_quad.size=this.m_target.size;this.update_interactive_points_position();
var interactive_point=null;for(var i=0;i<gb.selector.corner_type.max;++i){interactive_point=this.m_points[i];interactive_point.remove_from_parent();this.m_bounding_quad.add_child(interactive_point);interactive_point.visible=true}target_touch_recognize_component=this.m_target.get_component(gb.ces_base_component.type.touch_recognize);target_touch_recognize_component.add_callback(gb.input_context.state.pressed,this.on_target_pressed,this);target_touch_recognize_component.add_callback(gb.input_context.state.released,
this.on_target_released,this);target_touch_recognize_component.add_callback(gb.input_context.state.dragged,this.on_target_dragged,this)}else{this.m_target=null;this.m_bounding_quad.visible=false;var interactive_point=null;for(var i=0;i<gb.selector.corner_type.max;++i){interactive_point=this.m_points[i];interactive_point.visible=false}}}});Object.defineProperty(this,"rotation",{get:function(){return this.m_bounding_quad.rotation},set:function(value){this.m_bounding_quad.rotation=value}});this.m_is_align_movement=
false;Object.defineProperty(this,"is_align_movement",{get:function(){return this.m_is_align_movement},set:function(value){this.m_is_align_movement=value}});this.m_is_proportional_resizing=false;Object.defineProperty(this,"is_proportional_resizing",{get:function(){return this.m_is_proportional_resizing},set:function(value){this.m_is_proportional_resizing=value}});this.m_summury_delta=new gb.vec2},release:function(){},methods:{update_interactive_points_position:function(){var center=new gb.vec2(this.m_target.size.x*
this.m_target.pivot.x-this.m_target.size.x*(1-this.m_target.pivot.x),this.m_target.size.y*this.m_target.pivot.y-this.m_target.size.y*(1-this.m_target.pivot.y));this.m_points[gb.selector.corner_type.center].position=center;var position_00=new gb.vec2(-this.m_target.size.x*(1-this.m_target.pivot.x),-this.m_target.size.y*(1-this.m_target.pivot.y));var position_11=new gb.vec2(this.m_target.size.x*this.m_target.pivot.x,this.m_target.size.y*this.m_target.pivot.y);this.m_points[gb.selector.corner_type.left_top].position=
new gb.vec2(position_00.x+this.m_points[gb.selector.corner_type.left_top].size.x*.5,position_00.y+this.m_points[gb.selector.corner_type.left_top].size.y*.5);this.m_points[gb.selector.corner_type.right_top].position=new gb.vec2(position_00.x+this.m_points[gb.selector.corner_type.right_top].size.x*.5,position_11.y-this.m_points[gb.selector.corner_type.right_top].size.y*.5);this.m_points[gb.selector.corner_type.left_bottom].position=new gb.vec2(position_11.x-this.m_points[gb.selector.corner_type.left_bottom].size.x*
.5,position_00.y+this.m_points[gb.selector.corner_type.left_bottom].size.y*.5);this.m_points[gb.selector.corner_type.right_bottom].position=new gb.vec2(position_11.x-this.m_points[gb.selector.corner_type.right_bottom].size.x*.5,position_11.y-this.m_points[gb.selector.corner_type.right_bottom].size.y*.5)},set_interactive_point:function(interactive_point,type){if(this.m_points[type])this.m_points[type].remove_from_parent();this.m_points[type]=interactive_point;this.m_bounding_quad.add_child(this.m_points[type]);
interactive_point.is_touchable=true;var selector_touch_recognize_component=interactive_point.get_component(gb.ces_base_component.type.touch_recognize);selector_touch_recognize_component.add_callback(gb.input_context.state.pressed,this.on_selector_pressed,this);selector_touch_recognize_component.add_callback(gb.input_context.state.released,this.on_selector_released,this);selector_touch_recognize_component.add_callback(gb.input_context.state.dragged,this.on_selector_dragged,this)},on_selector_pressed:function(entity,
state,point,userdata){userdata.m_previous_selector_touch_point=point},on_selector_released:function(entity,state,point,userdata){userdata.m_previous_selector_touch_point=null},on_selector_dragged:function(entity,state,point,userdata){if(userdata.m_previous_selector_touch_point){var delta=userdata.m_previous_selector_touch_point.sub(point);if(userdata.m_is_proportional_resizing){delta.x=Math.abs(delta.x)>Math.abs(delta.y)?delta.x:delta.y;delta.y=Math.abs(delta.x)>Math.abs(delta.y)?delta.x:delta.y}var delta_size=
new gb.vec2(delta);var current_position=userdata.position;var current_size=userdata.size;if(userdata.m_is_align_movement){userdata.m_summury_delta.x+=delta.x;userdata.m_summury_delta.y+=delta.y;delta.x=0;delta.y=0;delta_size.x=0;delta_size.y=0;if(Math.abs(userdata.m_summury_delta.x)>16){var next_position_x=Math.round((current_position.x-userdata.m_summury_delta.x)/32)*32;var next_size_x=Math.round((current_position.x+current_size.x-userdata.m_summury_delta.x)/32)*32;next_size_x-=current_position.x;
delta.x=current_position.x-next_position_x;delta_size.x=current_size.x-next_size_x;userdata.m_summury_delta.x=0}if(Math.abs(userdata.m_summury_delta.y)>16){var next_position_y=Math.round((current_position.y-userdata.m_summury_delta.y)/32)*32;var next_size_y=Math.round((current_position.y+current_size.y-userdata.m_summury_delta.y)/32)*32;next_size_y-=current_position.y;delta.y=current_position.y-next_position_y;delta_size.y=current_size.y-next_size_y;userdata.m_summury_delta.y=0}}if(entity===userdata.m_points[gb.selector.corner_type.left_top]){current_size.x+=
delta.x;current_size.y+=delta.y}else if(entity===userdata.m_points[gb.selector.corner_type.right_top]){current_size.x+=delta.x;current_size.y-=delta_size.y}else if(entity===userdata.m_points[gb.selector.corner_type.left_bottom]){current_size.x-=delta_size.x;current_size.y+=delta.y}else if(entity===userdata.m_points[gb.selector.corner_type.right_bottom]){current_size.x-=delta_size.x;current_size.y-=delta_size.y}current_position.x-=delta.x*userdata.m_target.pivot.x;current_position.y-=delta.y*userdata.m_target.pivot.y;
userdata.position=current_position;userdata.size=current_size;userdata.m_target.size=current_size;userdata.update_interactive_points_position();userdata.m_previous_selector_touch_point=new gb.vec2(point)}},on_target_pressed:function(entity,state,point,userdata){userdata.m_previous_target_touch_point=new gb.vec2(point)},on_target_released:function(entity,state,point,userdata){userdata.m_previous_target_touch_point=null;userdata.m_summury_delta.x=0;userdata.m_summury_delta.y=0},on_target_dragged:function(entity,
state,point,userdata){if(userdata.m_previous_target_touch_point){var delta=userdata.m_previous_target_touch_point.sub(point);if(userdata.m_is_align_movement){userdata.m_summury_delta.x+=delta.x;userdata.m_summury_delta.y+=delta.y;delta.x=0;delta.y=0;if(Math.abs(userdata.m_summury_delta.x)>16){var next_position_x=Math.round((userdata.position.x-userdata.m_summury_delta.x)/32)*32;delta.x=userdata.position.x-next_position_x;userdata.m_summury_delta.x=0}if(Math.abs(userdata.m_summury_delta.y)>16){var next_position_y=
Math.round((userdata.position.y-userdata.m_summury_delta.y)/32)*32;delta.y=userdata.position.y-next_position_y;userdata.m_summury_delta.y=0}userdata.position=userdata.position.sub(delta)}else userdata.position=userdata.position.sub(delta);userdata.m_previous_target_touch_point=new gb.vec2(point)}}},static_methods:{}});oop.define_class({namespace:"gb",name:"editor_fabricator",init:function(){this.m_scene_fabricator=null;Object.defineProperty(this,"scene_fabricator",{get:function(){return this.m_scene_fabricator},set:function(value){this.m_scene_fabricator=value}})},release:function(){},methods:{create_selector:function(){var selector=new gb.selector;var bounding_quad=this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",function(){var material_component=bounding_quad.get_component(gb.ces_base_component.type.material);
material_component.set_custom_shader_uniform(new gb.vec4(0,1,0,.25),"u_color")});selector.bounding_quad=bounding_quad;var center_selector=this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",function(){var material_component=center_selector.get_component(gb.ces_base_component.type.material);material_component.set_custom_shader_uniform(new gb.vec4(1,0,0,.5),"u_color");var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();
center_selector.add_component(geometry_component);center_selector.size=new gb.vec2(8);var selector_touch_recognize_component=center_selector.get_component(gb.ces_base_component.type.touch_recognize);var selector_size=center_selector.size;selector_touch_recognize_component.bound=new gb.vec4(selector_size.x*-.5,selector_size.y*-.5,selector_size.x*.5,selector_size.y*.5)});selector.set_interactive_point(center_selector,gb.selector.corner_type.center);var left_top_selector=this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",
function(){var material_component=left_top_selector.get_component(gb.ces_base_component.type.material);material_component.set_custom_shader_uniform(new gb.vec4(1,0,0,.5),"u_color");var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();left_top_selector.add_component(geometry_component);left_top_selector.size=new gb.vec2(8);var selector_touch_recognize_component=left_top_selector.get_component(gb.ces_base_component.type.touch_recognize);
var selector_size=left_top_selector.size;selector_touch_recognize_component.bound=new gb.vec4(selector_size.x*-.5,selector_size.y*-.5,selector_size.x*.5,selector_size.y*.5)});selector.set_interactive_point(left_top_selector,gb.selector.corner_type.left_top);var right_top_selector=this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",function(){var material_component=right_top_selector.get_component(gb.ces_base_component.type.material);material_component.set_custom_shader_uniform(new gb.vec4(1,
0,0,.5),"u_color");var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();right_top_selector.add_component(geometry_component);right_top_selector.size=new gb.vec2(8);var selector_touch_recognize_component=right_top_selector.get_component(gb.ces_base_component.type.touch_recognize);var selector_size=right_top_selector.size;selector_touch_recognize_component.bound=new gb.vec4(selector_size.x*-.5,selector_size.y*-.5,selector_size.x*.5,
selector_size.y*.5)});selector.set_interactive_point(right_top_selector,gb.selector.corner_type.right_top);var left_bottom_selector=this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",function(){var material_component=left_bottom_selector.get_component(gb.ces_base_component.type.material);material_component.set_custom_shader_uniform(new gb.vec4(1,0,0,.5),"u_color");var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();
left_bottom_selector.add_component(geometry_component);left_bottom_selector.size=new gb.vec2(8);var selector_touch_recognize_component=left_bottom_selector.get_component(gb.ces_base_component.type.touch_recognize);var selector_size=left_bottom_selector.size;selector_touch_recognize_component.bound=new gb.vec4(selector_size.x*-.5,selector_size.y*-.5,selector_size.x*.5,selector_size.y*.5)});selector.set_interactive_point(left_bottom_selector,gb.selector.corner_type.left_bottom);var right_bottom_selector=
this.m_scene_fabricator.create_sprite("data/resources/configurations/game_objects/selector.json",function(){var material_component=right_bottom_selector.get_component(gb.ces_base_component.type.material);material_component.set_custom_shader_uniform(new gb.vec4(1,0,0,.5),"u_color");var geometry_component=new gb.ces_geometry_freeform_component;geometry_component.mesh=gb.mesh_constructor.create_circle();right_bottom_selector.add_component(geometry_component);right_bottom_selector.size=new gb.vec2(8);
var selector_touch_recognize_component=right_bottom_selector.get_component(gb.ces_base_component.type.touch_recognize);var selector_size=right_bottom_selector.size;selector_touch_recognize_component.bound=new gb.vec4(selector_size.x*-.5,selector_size.y*-.5,selector_size.x*.5,selector_size.y*.5)});selector.set_interactive_point(right_bottom_selector,gb.selector.corner_type.right_bottom);return selector}},static_methods:{}});
